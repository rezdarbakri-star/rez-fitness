<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0f1a">
    <title>FitLog - Tr√§ningsjournal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Prevent zoom and bounce */
        html {
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            overflow: hidden;
            height: 100%;
            background: #0a0f1a;
        }
        
        body {
            overflow: hidden;
            height: 100%;
            position: fixed;
            width: 100%;
            overscroll-behavior: none;
            background: #0a0f1a;
        }
        
        /* Prevent input zoom on iOS */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        input[type="number"] {
            font-size: 16px !important;
        }
        
        /* F√∂rhindra automatisk scroll vid focus */
        input:focus, textarea:focus {
            outline: none;
        }
        
        /* Fixed input bar styling for logging */
        .logging-input-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface-elevated);
            border-top: 2px solid var(--accent);
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
            z-index: 200;
            transform: translateY(0);
            transition: transform 0.2s;
        }
        
        /* Free training input bar - stays at visual viewport bottom */
        .free-input-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 9999;
        }
        
        /* When keyboard is open on iOS, use visual viewport positioning */
        @supports (height: 100dvh) {
            .free-input-bar {
                bottom: 0;
            }
        }
        
        /* Wheel Picker Styles */
        .wheel-scroll {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .wheel-scroll::-webkit-scrollbar {
            display: none;
        }
        .wheel-item {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            font-weight: 500;
            color: var(--text-muted);
            scroll-snap-align: center;
            transition: all 0.15s ease;
            opacity: 0.3;
        }
        /* Items f√∂r reps/set picker (42px height) */
        .wheel-item-sm {
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            scroll-snap-align: center;
            transition: all 0.15s ease;
            opacity: 0.4;
        }
        .wheel-item.selected, .wheel-item:nth-child(n) {
            /* Selected state handled by scroll position */
        }
        .wheel-scroll > .wheel-item:nth-child(n+2):nth-last-child(n+2) {
            /* Middle items */
        }
        
        /* Mobile Reps/Set Picker - centrerad */
        #mobileRepsSetPicker {
            flex: 1;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        
        #exerciseStep2.show-mobile {
            display: flex !important;
            flex-direction: column;
            height: calc(100vh - 120px);
        }
        
        :root {
            --primary: #0a0e27;
            --secondary: #1a1f3a;
            --accent: #00e5a0;
            --accent-hover: #00ffc3;
            --text: #e8eef2;
            --text-muted: #8b95a5;
            --border: #2a3142;
            --danger: #ff4757;
            --surface: #141829;
            --surface-elevated: #1e2438;
            --week-width: 600px;
            --exercise-col-width: 250px;
            --safe-margin: max(1rem, env(safe-area-inset-left));
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, #0d1328 100%);
            color: var(--text);
            min-height: 100vh;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 2rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--primary);
        }
        
        #app-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
            background: var(--primary);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Mobile safe margins */
        @media (max-width: 768px) {
            .container {
                padding: 2rem var(--safe-margin) 1rem;
                justify-content: flex-start;
                padding-top: 3rem;
                background: var(--primary);
            }
            
            #app-content {
                padding-top: 10vh;
                padding-bottom: 10vh;
                background: var(--primary);
            }
            
            .workout-builder {
                padding: 0 0.25rem;
            }
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--surface);
            padding: 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: var(--accent);
            color: var(--primary);
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--surface);
            border-radius: 16px;
            border: 2px dashed var(--border);
        }
        
        .empty-state h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .empty-state p {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }
        
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--primary);
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--surface-elevated);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(8px);
            z-index: 1000;
            padding: 0;
            overflow-y: auto;
        }
        
        .modal.show {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
        }
        
        @media (min-width: 769px) {
            .modal.show {
                align-items: center;
                padding: 1rem;
            }
        }
        
        .modal-content {
            background: var(--secondary);
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            padding-bottom: calc(1.5rem + env(safe-area-inset-bottom, 0px));
            max-width: 500px;
            width: 100%;
            border: 1px solid var(--border);
            border-bottom: none;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        @media (min-width: 769px) {
            .modal-content {
                border-radius: 16px;
                border-bottom: 1px solid var(--border);
                padding: 2rem;
                max-height: calc(100vh - 2rem);
            }
        }
        
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }
        
        /* Helsk√§rm f√∂r exerciseModal p√• mobil */
        @media (max-width: 768px) {
            #exerciseModal .modal-content {
                border-radius: 0;
                max-height: calc(100vh - 90px);
                height: auto;
                max-width: 100%;
                padding: 1rem;
                padding-top: calc(1rem + env(safe-area-inset-top, 0px));
                margin-bottom: 90px;
            }
            #exerciseModal.show {
                align-items: flex-start;
            }
            #exerciseModal #selectedExercisesBar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
            }
        }
        
        .open-library-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(0, 229, 160, 0.1) 0%, rgba(0, 229, 160, 0.05) 100%);
            border: 2px dashed var(--accent);
            border-radius: 8px;
            color: var(--accent);
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .open-library-btn:hover {
            background: linear-gradient(135deg, rgba(0, 229, 160, 0.2) 0%, rgba(0, 229, 160, 0.1) 100%);
            transform: translateY(-2px);
        }
        
        .open-library-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .template-library-modal {
            max-width: 600px;
        }
        
        .template-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 350px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        .template-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .template-grid::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 3px;
        }
        
        .template-grid::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }
        
        .template-card {
            padding: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .template-card:hover {
            border-color: var(--accent);
            transform: translateX(4px);
            background: var(--surface-elevated);
        }
        
        .filter-info {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--surface);
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .filter-tag {
            padding: 0.25rem 0.5rem;
            background: rgba(0, 229, 160, 0.15);
            border: 1px solid var(--accent);
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 8px;
        }
        
        .close-btn:hover {
            background: var(--surface);
            color: var(--text);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.875rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'Outfit', sans-serif;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .day-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        
        .day-option {
            padding: 0.875rem;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .day-option:hover {
            border-color: var(--accent);
        }
        
        .day-option.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
        }
        
        .workout-builder {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .builder-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
        }
        
        .week-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        
        .week-tab {
            padding: 0.75rem 1.25rem;
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .week-tab.active {
            background: var(--accent);
            color: var(--primary);
            border-color: var(--accent);
        }
        
        .day-section {
            margin-bottom: 2rem;
            background: var(--surface-elevated);
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .day-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .exercise-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .exercise-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr auto;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: var(--secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .exercise-name {
            font-weight: 500;
        }
        
        .muscle-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--accent);
            color: var(--primary);
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .exercise-lib-btn:hover {
            background: var(--accent) !important;
            color: var(--primary) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 229, 160, 0.3);
        }
        
        .weight-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .weight-input button {
            padding: 0.25rem 0.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            cursor: pointer;
            font-weight: 600;
        }
        
        .weight-input button:hover {
            background: var(--accent);
            color: var(--primary);
        }
        
        .weight-input input {
            width: 70px;
            text-align: center;
            padding: 0.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
        }
        
        .empty-exercises {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            border: 1px dashed var(--border);
            border-radius: 8px;
        }
        
        /* Ta bort hover-effekter p√• touch-devices */
        @media (hover: none) and (pointer: coarse) {
            .btn-primary:hover {
                background: var(--accent);
                transform: none;
            }
            
            .open-library-btn:hover {
                background: linear-gradient(135deg, rgba(0, 229, 160, 0.15) 0%, rgba(0, 229, 160, 0.05) 100%);
                transform: none;
            }
            
            .template-card:hover {
                border-color: var(--border);
                transform: none;
                background: var(--surface);
            }
            
            .close-btn:hover {
                background: none;
                color: var(--text-muted);
            }
            
            .day-option:hover {
                border-color: var(--border);
            }
            
            .exercise-lib-btn:hover {
                background: var(--surface-elevated) !important;
                color: var(--text) !important;
                transform: none;
                box-shadow: none;
            }
            
            .weight-input button:hover {
                background: var(--surface);
                color: var(--text);
            }
        }
        
        @media (max-width: 768px) {
            :root {
                --week-width: 320px;
                --exercise-col-width: 140px;
            }
            
            .container {
                padding: 0.5rem;
            }
            
            header {
                flex-direction: column;
                gap: 0.75rem;
                padding: 0.75rem 0;
            }
            
            .logo {
                font-size: 1.5rem;
            }
            
            .tabs {
                width: 100%;
                justify-content: center;
            }
            
            .tab {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }
            
            .day-selector {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .exercise-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .modal {
                padding: 0.5rem;
            }
            
            .modal-content {
                padding: 1rem;
                max-height: calc(100vh - 1rem);
            }
            
            .modal-header h3 {
                font-size: 1.25rem;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .form-group input,
            .form-group select {
                padding: 0.75rem;
            }
            
            .day-section {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .day-header h3 {
                font-size: 1rem;
            }
            
            .builder-header {
                flex-direction: row;
                gap: 0.5rem;
                align-items: center;
                justify-content: space-between;
            }
            
            .builder-header h2 {
                font-size: 1.1rem;
                margin: 0;
            }
            
            .week-tabs {
                gap: 0.25rem;
                margin-bottom: 1rem;
            }
            
            .week-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            /* Mobil-anpassad tabell */
            .day-section table th,
            .day-section table td {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
            }
            
            .day-section table th:first-child {
                min-width: 120px !important;
            }
            
            .day-section table th:nth-child(2),
            .day-section table th:nth-child(3) {
                width: 50px !important;
            }
            
            .muscle-badge {
                font-size: 0.6rem !important;
                padding: 0.15rem 0.35rem !important;
                margin-left: 0.25rem !important;
            }
            
            /* Kompakta set-celler p√• mobil */
            .day-section input[type="number"] {
                width: 45px !important;
                padding: 0.35rem !important;
                font-size: 0.8rem !important;
            }
            
            /* Veckohuvud mer kompakt */
            .day-section [style*="VECKA"] {
                font-size: 0.7rem !important;
                padding: 0.5rem !important;
            }
            
            /* Programlista */
            .day-section p {
                font-size: 0.85rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .btn-sm {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            /* Template cards */
            .template-card {
                padding: 0.75rem;
            }
            
            .template-grid {
                max-height: 300px;
            }
            
            .filter-info {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .filter-tag {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
            
            /* Open library button */
            .open-library-btn {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
        }
        
        /* Extra small devices */
        @media (max-width: 400px) {
            .container {
                padding: 0.25rem;
            }
            
            .day-selector {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .day-option {
                padding: 0.6rem;
                font-size: 0.85rem;
            }
            
            .modal-content {
                padding: 0.75rem;
            }
            
            .day-section {
                padding: 0.5rem;
            }
            
            .day-section table th:first-child {
                min-width: 100px !important;
            }
            
            .day-section input[type="number"] {
                width: 38px !important;
                padding: 0.3rem !important;
                font-size: 0.75rem !important;
            }
            
            .gender-btn, .level-btn {
                padding: 0.6rem !important;
                font-size: 0.8rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- PT/Klient toggle - fixed top right corner -->
        <!-- Menu Button - Fixed position outside container, iOS safe zone -->
        <button id="menuBtn" onclick="window.showMenuModal()" style="position: fixed; top: max(env(safe-area-inset-top, 0.5rem), 0.5rem); top: calc(env(safe-area-inset-top, 0px) + 0.75rem); left: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; padding: 0.5rem; display: flex; align-items: center; justify-content: center; z-index: 1000; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text)" stroke-width="2" stroke-linecap="round">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        
        <div id="modeSwitchBtn" onclick="togglePTMode()" style="position: fixed; top: calc(env(safe-area-inset-top, 0px) + 0.75rem); right: 0.75rem; display: flex; align-items: center; gap: 0.4rem; padding: 0.2rem; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; font-size: 0.6rem; transition: all 0.2s; z-index: 1000;">
            <span id="modeLabel" style="color: var(--text-muted); padding-left: 0.4rem;">Klient</span>
            <div id="toggleTrack" style="width: 36px; height: 20px; background: var(--border); border-radius: 10px; position: relative; transition: background 0.2s;">
                <div id="toggleThumb" style="width: 16px; height: 16px; background: var(--text-muted); border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.2s;"></div>
            </div>
        </div>
        
        <!-- Header hidden for now -->
        <header id="mainHeader" style="display: none;">
            <div class="logo">FitLog</div>
            <div class="tabs">
                <button class="tab active">Tr√§ning</button>
                <button class="tab">Kost</button>
                <button class="tab">Inv√§gning</button>
            </div>
        </header>
        
        <div id="app-content"></div>
    </div>
    
    <!-- Create Program Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="createModalTitle">Skapa tr√§ningsschema</h3>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <button type="button" id="modalLibraryBtn" onclick="window.openTemplateLibraryFromCreate()" style="padding: 0.4rem 0.6rem; background: var(--surface-elevated); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 0.85rem; display: flex; align-items: center; gap: 0.3rem;">
                        üìö <span id="modalLibraryCount" style="background: var(--accent); color: var(--primary); padding: 0.1rem 0.35rem; border-radius: 8px; font-size: 0.7rem;">0</span>
                    </button>
                    <button class="close-btn" id="closeModalBtn">√ó</button>
                </div>
            </div>
            
            <!-- STEP 1: K√∂n -->
            <div id="createStep1" style="display: block;">
                <div class="form-group">
                    <label>K√∂n</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <button type="button" onclick="window.selectGenderAndNext('Man')" class="create-option-btn" data-value="Kille" style="padding: 1.25rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1.1rem; transition: all 0.2s;">Man</button>
                        <button type="button" onclick="window.selectGenderAndNext('Kvinna')" class="create-option-btn" data-value="Tjej" style="padding: 1.25rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1.1rem; transition: all 0.2s;">Kvinna</button>
                    </div>
                </div>
            </div>
            
            <!-- STEP 2: Niv√• -->
            <div id="createStep2" style="display: none;">
                <div style="margin-bottom: 1rem; padding: 0.5rem 0.75rem; background: var(--surface-elevated); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span><span style="color: var(--text-muted); font-size: 0.75rem;">K√∂n:</span> <span id="selectedGenderDisplay" style="font-weight: 600;"></span></span>
                    <button onclick="window.goToCreateStep(1)" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.8rem;">‚Üê Tillbaka</button>
                </div>
                <div class="form-group">
                    <label>Niv√•</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button type="button" onclick="window.selectLevelAndNext('Nyb√∂rjare')" class="create-option-btn" style="padding: 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; text-align: left;">Nyb√∂rjare</button>
                        <button type="button" onclick="window.selectLevelAndNext('Medel')" class="create-option-btn" style="padding: 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; text-align: left;">Medel</button>
                        <button type="button" onclick="window.selectLevelAndNext('Avancerad')" class="create-option-btn" style="padding: 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; text-align: left;">Avancerad</button>
                    </div>
                </div>
            </div>
            
            <!-- STEP 3: Dagar per vecka -->
            <div id="createStep3" style="display: none;">
                <div style="margin-bottom: 1rem; padding: 0.5rem 0.75rem; background: var(--surface-elevated); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span><span id="selectedGenderDisplay2"></span> ¬∑ <span id="selectedLevelDisplay" style="color: var(--accent);"></span></span>
                    <button onclick="window.goToCreateStep(2)" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.8rem;">‚Üê Tillbaka</button>
                </div>
                <div class="form-group">
                    <label>Antal dagar per vecka</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                        <button type="button" onclick="window.selectDaysAndNext(1)" class="create-option-btn" style="padding: 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1.2rem; transition: all 0.2s;">1</button>
                        <button type="button" onclick="window.selectDaysAndNext(2)" class="create-option-btn" style="padding: 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1.2rem; transition: all 0.2s;">2</button>
                        <button type="button" onclick="window.selectDaysAndNext(3)" class="create-option-btn" style="padding: 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1.2rem; transition: all 0.2s;">3</button>
                        <button type="button" onclick="window.selectDaysAndNext(4)" class="create-option-btn" style="padding: 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1.2rem; transition: all 0.2s;">4</button>
                        <button type="button" onclick="window.selectDaysAndNext(5)" class="create-option-btn" style="padding: 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1.2rem; transition: all 0.2s;">5</button>
                        <button type="button" onclick="window.selectDaysAndNext(6)" class="create-option-btn" style="padding: 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1.2rem; transition: all 0.2s;">6</button>
                    </div>
                </div>
            </div>
            
            <!-- STEP 4: Antal veckor -->
            <div id="createStep4" style="display: none;">
                <div style="margin-bottom: 1rem; padding: 0.5rem 0.75rem; background: var(--surface-elevated); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span><span id="selectedGenderDisplay3"></span> ¬∑ <span id="selectedLevelDisplay2" style="color: var(--accent);"></span> ¬∑ <span id="selectedDaysDisplay" style="color: var(--text-muted);"></span></span>
                    <button onclick="window.goToCreateStep(3)" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.8rem;">‚Üê Tillbaka</button>
                </div>
                <div class="form-group">
                    <label>Antal veckor</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                        <button type="button" onclick="window.selectWeeksAndNext(1)" class="create-option-btn" style="padding: 0.75rem 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; flex: 1; min-width: 50px;">1</button>
                        <button type="button" onclick="window.selectWeeksAndNext(2)" class="create-option-btn" style="padding: 0.75rem 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; flex: 1; min-width: 50px;">2</button>
                        <button type="button" onclick="window.selectWeeksAndNext(4)" class="create-option-btn" style="padding: 0.75rem 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; flex: 1; min-width: 50px;">4</button>
                        <button type="button" onclick="window.selectWeeksAndNext(8)" class="create-option-btn" style="padding: 0.75rem 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; flex: 1; min-width: 50px;">8</button>
                        <button type="button" onclick="window.selectWeeksAndNext(12)" class="create-option-btn" style="padding: 0.75rem 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; flex: 1; min-width: 50px;">12</button>
                        <button type="button" onclick="window.selectWeeksAndNext(16)" class="create-option-btn" style="padding: 0.75rem 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; flex: 1; min-width: 50px;">16</button>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" id="customWeeksInput" placeholder="Eller skriv antal..." min="1" max="52" style="flex: 1;" oninput="window.checkCustomWeeks()">
                        <button id="customWeeksBtn" class="btn btn-primary" onclick="window.goToCreateStep5WithCustomWeeks()" style="display: none; padding: 0.5rem 1rem;">N√§sta</button>
                    </div>
                </div>
            </div>
            
            <!-- STEP 5: V√§lj mall eller bygg fr√•n scratch -->
            <div id="createStep5" style="display: none;">
                <div style="margin-bottom: 1rem; padding: 0.5rem 0.75rem; background: var(--surface-elevated); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span><span id="selectedGenderDisplay4"></span> ¬∑ <span id="selectedLevelDisplay3" style="color: var(--accent);"></span> ¬∑ <span id="selectedDaysDisplay2"></span> ¬∑ <span id="selectedWeeksDisplay" style="color: var(--text-muted);"></span></span>
                    <button onclick="window.goToCreateStep(4)" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.8rem;">‚Üê Tillbaka</button>
                </div>
                <div class="form-group">
                    <label>Hur vill du skapa programmet?</label>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button type="button" onclick="window.openTemplateLibraryFromCreate()" class="create-option-btn" style="padding: 1.25rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; text-align: left; display: flex; align-items: center; justify-content: space-between;">
                            <span>V√§lj fr√•n mall</span>
                            <span id="matchingTemplatesCount" style="background: var(--surface-elevated); color: var(--text-muted); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem;">0</span>
                        </button>
                        <button type="button" onclick="window.goToCreateStep(6)" class="create-option-btn" style="padding: 1.25rem; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text); font-size: 1rem; transition: all 0.2s; text-align: left;">
                            <span>Bygg fr√•n scratch</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- STEP 6: Namn p√• program -->
            <div id="createStep6" style="display: none;">
                <div style="margin-bottom: 1rem; padding: 0.5rem 0.75rem; background: var(--surface-elevated); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span><span id="selectedGenderDisplay5"></span> ¬∑ <span id="selectedLevelDisplay4" style="color: var(--accent);"></span> ¬∑ <span id="selectedDaysDisplay3"></span> ¬∑ <span id="selectedWeeksDisplay2" style="color: var(--text-muted);"></span></span>
                    <button onclick="window.goToCreateStep(5)" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.8rem;">‚Üê Tillbaka</button>
                </div>
                <div class="form-group">
                    <label>Namn p√• program</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" id="programName" placeholder="t.ex. Styrkeprogram FAS 1" maxlength="40" style="flex: 1;" oninput="window.checkProgramName()">
                        <button id="createProgramBtn" class="btn btn-primary" onclick="window.createProgramFromSteps()" style="display: none; padding: 0.75rem 1.25rem; white-space: nowrap;">Skapa</button>
                    </div>
                </div>
            </div>
            
            <!-- Hidden fields -->
            <input type="hidden" id="programGender" value="">
            <input type="hidden" id="programLevel" value="">
            <input type="hidden" id="programDaysPerWeek" value="">
            <input type="hidden" id="weeksCount" value="8">
        </div>
    </div>
    
    <!-- Template Library Modal -->
    <div class="modal" id="templateLibraryModal">
        <div class="modal-content template-library-modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üìö Mall-bibliotek</h3>
                <button class="close-btn" id="closeTemplateLibraryBtn">√ó</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="templateSearchInput" placeholder="S√∂k mall..." style="width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem 1rem; color: var(--text); font-size: 0.9rem;" oninput="window.filterTemplates()">
            </div>
            <div id="filterInfo" class="filter-info" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;"></div>
            <div id="templateGrid" class="template-grid" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- Add Exercise Modal -->
    <div class="modal" id="exerciseModal">
        <div class="modal-content" id="exerciseModalContent">
            <div class="modal-header" id="exerciseModalHeader">
                <h3 id="exerciseModalTitle">L√§gg till √∂vning(ar)</h3>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <button class="close-btn" id="closeExerciseModalBtn">√ó</button>
                </div>
            </div>
            
            <!-- STEP 1: Exercise Name -->
            <div id="exerciseStep1">
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="exerciseName" placeholder="S√∂k eller skriv eget..." maxlength="50" style="width: 100%; padding: 1rem; font-size: 1rem; border-radius: 10px;" oninput="window.checkExerciseName()">
                </div>
                <button id="step1NextBtn" class="btn btn-primary" onclick="window.goToStep2()" style="width: 100%; display: none; margin-bottom: 1rem;">L√§gg till</button>
                
                <!-- Exercise Library -->
                <div id="exerciseLibrary" style="border: 1px solid var(--border); border-radius: 10px; padding: 1rem; padding-bottom: 120px; background: var(--surface);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">√ñvningsbibliotek</h4>
                        <button id="editLibraryBtn" class="btn btn-secondary btn-sm" onclick="toggleLibraryEditMode()" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                            <span id="editLibraryText">‚úèÔ∏è</span>
                        </button>
                    </div>
                    <div id="libraryContent"></div>
                </div>
            </div>
            
            <!-- STEP 1b: Muscle Group (only for manual entry) -->
            <div id="exerciseStep1b" style="display: none;">
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--surface-elevated); border-radius: 8px;">
                    <span style="color: var(--text-muted); font-size: 0.75rem;">√ñvning:</span>
                    <span id="selectedExerciseNameMuscle" style="font-weight: 600; margin-left: 0.5rem;"></span>
                    <button onclick="window.goToStep1()" style="float: right; background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.8rem;">‚Üê Tillbaka</button>
                </div>
                
                <div class="form-group">
                    <label>V√§lj muskelgrupp</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                        <button type="button" onclick="window.selectMuscleGroup('Br√∂st')" style="padding: 0.75rem; background: rgba(107, 159, 255, 0.15); border: 1px solid #6B9FFF; border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer;">Br√∂st</button>
                        <button type="button" onclick="window.selectMuscleGroup('Rygg')" style="padding: 0.75rem; background: rgba(78, 205, 196, 0.15); border: 1px solid #4ECDC4; border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer;">Rygg</button>
                        <button type="button" onclick="window.selectMuscleGroup('Axlar')" style="padding: 0.75rem; background: rgba(255, 179, 102, 0.15); border: 1px solid #FFB366; border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer;">Axlar</button>
                        <button type="button" onclick="window.selectMuscleGroup('Biceps')" style="padding: 0.75rem; background: rgba(168, 230, 207, 0.15); border: 1px solid #A8E6CF; border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer;">Biceps</button>
                        <button type="button" onclick="window.selectMuscleGroup('Triceps')" style="padding: 0.75rem; background: rgba(201, 167, 255, 0.15); border: 1px solid #C9A7FF; border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer;">Triceps</button>
                        <button type="button" onclick="window.selectMuscleGroup('Ben')" style="padding: 0.75rem; background: rgba(125, 211, 252, 0.15); border: 1px solid #7DD3FC; border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer;">Ben</button>
                        <button type="button" onclick="window.selectMuscleGroup('Rumpa')" style="padding: 0.75rem; background: rgba(255, 179, 230, 0.15); border: 1px solid #FFB3E6; border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer;">Rumpa</button>
                        <button type="button" onclick="window.selectMuscleGroup('Mage')" style="padding: 0.75rem; background: rgba(253, 183, 119, 0.15); border: 1px solid #FDB777; border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer;">Mage</button>
                    </div>
                </div>
            </div>
            
            <!-- STEP 2: Reps -->
            <div id="exerciseStep2" style="display: none;">
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--surface-elevated); border-radius: 8px; flex-shrink: 0;">
                    <span style="color: var(--text-muted); font-size: 0.75rem;">√ñvning:</span>
                    <span id="selectedExerciseName" style="font-weight: 600; margin-left: 0.5rem;"></span>
                    <button onclick="window.goToStep1()" style="float: right; background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.8rem;">‚Üê Tillbaka</button>
                </div>
                
                <!-- MOBIL: Wheel picker f√∂r reps + set -->
                <div id="mobileRepsSetPicker" style="display: none;">
                    <!-- Stor instruktion √∂verst -->
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 1rem; font-weight: 500; color: var(--text-muted); margin-bottom: 1rem;">V√§lj reps √ó set</div>
                        <div style="font-size: 3rem; font-weight: 800; color: var(--accent); line-height: 1;">
                            <span id="wheelRepsValue">10-12</span>
                            <span style="color: var(--text-muted); font-size: 1.5rem; font-weight: 400;"> √ó </span>
                            <span id="wheelSetsValue">3</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; align-items: flex-start; gap: 0.75rem; margin-bottom: 1.5rem;">
                        <!-- REPS wheel -->
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.4rem; font-weight: 600;">Reps</div>
                            <div style="position: relative; height: 160px; width: 85px; overflow: hidden; border-radius: 12px; background: var(--surface-elevated);">
                                <!-- Highlight med border -->
                                <div style="position: absolute; top: 50%; left: 4px; right: 4px; height: 50px; transform: translateY(-50%); background: rgba(0, 229, 160, 0.15); border: 2px solid var(--accent); border-radius: 8px; pointer-events: none; z-index: 1;"></div>
                                <div id="wheelRepsAdd" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; position: relative; z-index: 2;" onscroll="window.onWheelRepsAddScroll(this)">
                                    <div style="height: 55px;"></div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.4rem;" data-value="1-2">1-2</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.4rem;" data-value="2-4">2-4</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.4rem;" data-value="4-6">4-6</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.4rem;" data-value="6-8">6-8</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.4rem;" data-value="8-10">8-10</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.4rem;" data-value="10-12">10-12</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.4rem;" data-value="12-15">12-15</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.4rem;" data-value="15-20">15-20</div>
                                    <div style="height: 55px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SET wheel -->
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.4rem; font-weight: 600;">Set</div>
                            <div style="position: relative; height: 160px; width: 75px; overflow: hidden; border-radius: 12px; background: var(--surface-elevated);">
                                <!-- Highlight med border -->
                                <div style="position: absolute; top: 50%; left: 4px; right: 4px; height: 50px; transform: translateY(-50%); background: rgba(0, 229, 160, 0.15); border: 2px solid var(--accent); border-radius: 8px; pointer-events: none; z-index: 1;"></div>
                                <div id="wheelSetsAdd" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; position: relative; z-index: 2;" onscroll="window.onWheelSetsAddScroll(this)">
                                    <div style="height: 55px;"></div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.5rem;" data-value="1">1</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.5rem;" data-value="2">2</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.5rem;" data-value="3">3</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.5rem;" data-value="4">4</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.5rem;" data-value="5">5</div>
                                    <div class="wheel-item" style="height: 50px; font-size: 1.5rem;" data-value="6">6</div>
                                    <div style="height: 55px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Toggle for all weeks vs current week only -->
                    <div id="allWeeksToggleMobile" onclick="toggleAllWeeks()" style="display: none; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem; background: var(--surface-elevated); border-radius: 8px; cursor: pointer; user-select: none;">
                            <div id="allWeeksTrackMobile" style="width: 36px; height: 20px; background: var(--accent); border-radius: 10px; position: relative; transition: background 0.2s; flex-shrink: 0;">
                                <div id="allWeeksThumbMobile" style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 18px; transition: all 0.2s;"></div>
                            </div>
                            <span style="font-size: 0.8rem; color: var(--text);">L√§gg till f√∂r alla veckor</span>
                        </div>
                    </div>
                    
                    <button onclick="window.addExerciseFromWheelPicker()" style="width: 100%; padding: 1rem; background: var(--accent); border: none; border-radius: 12px; color: var(--primary); font-size: 1.1rem; font-weight: 700; cursor: pointer;">
                        L√§gg till ‚úì
                    </button>
                </div>
                
                <!-- DESKTOP: Original knappar f√∂r reps -->
                <div id="desktopRepsPicker" class="form-group">
                    <label>V√§lj reps</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
                        <button type="button" onclick="window.selectRepsAndContinue('4-6')" class="reps-btn" style="padding: 0.75rem 0.5rem; background: var(--surface-elevated); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95rem; cursor: pointer; transition: all 0.15s;">4-6</button>
                        <button type="button" onclick="window.selectRepsAndContinue('6-8')" class="reps-btn" style="padding: 0.75rem 0.5rem; background: var(--surface-elevated); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95rem; cursor: pointer; transition: all 0.15s;">6-8</button>
                        <button type="button" onclick="window.selectRepsAndContinue('8-10')" class="reps-btn" style="padding: 0.75rem 0.5rem; background: var(--surface-elevated); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95rem; cursor: pointer; transition: all 0.15s;">8-10</button>
                        <button type="button" onclick="window.selectRepsAndContinue('10-12')" class="reps-btn" style="padding: 0.75rem 0.5rem; background: var(--surface-elevated); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95rem; cursor: pointer; transition: all 0.15s;">10-12</button>
                        <button type="button" onclick="window.selectRepsAndContinue('12-15')" class="reps-btn" style="padding: 0.75rem 0.5rem; background: var(--surface-elevated); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95rem; cursor: pointer; transition: all 0.15s;">12-15</button>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" id="exerciseReps" placeholder="Eller skriv eget..." style="flex: 1;" oninput="window.checkCustomReps()">
                        <button id="customRepsBtn" class="btn btn-primary" onclick="window.goToStep3()" style="display: none; padding: 0.5rem 1rem;">N√§sta</button>
                    </div>
                </div>
            </div>
            
            <!-- STEP 3: Sets (endast desktop) -->
            <div id="exerciseStep3" style="display: none;">
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--surface-elevated); border-radius: 8px;">
                    <div><span style="color: var(--text-muted); font-size: 0.75rem;">√ñvning:</span> <span id="selectedExerciseName2" style="font-weight: 600; margin-left: 0.5rem;"></span></div>
                    <div><span style="color: var(--text-muted); font-size: 0.75rem;">Reps:</span> <span id="selectedReps" style="font-weight: 600; margin-left: 0.5rem; color: var(--accent);"></span></div>
                    <button onclick="window.goToStep2()" style="float: right; background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.8rem; margin-top: -2rem;">‚Üê Tillbaka</button>
                </div>
                
                <div class="form-group">
                    <label>V√§lj antal set</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                        <button type="button" onclick="window.selectSetsAndAdd(2)" class="sets-btn" style="padding: 0.75rem 1.25rem; background: var(--surface-elevated); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1.1rem; cursor: pointer; transition: all 0.15s; flex: 1;">2</button>
                        <button type="button" onclick="window.selectSetsAndAdd(3)" class="sets-btn" style="padding: 0.75rem 1.25rem; background: var(--surface-elevated); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1.1rem; cursor: pointer; transition: all 0.15s; flex: 1;">3</button>
                        <button type="button" onclick="window.selectSetsAndAdd(4)" class="sets-btn" style="padding: 0.75rem 1.25rem; background: var(--surface-elevated); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1.1rem; cursor: pointer; transition: all 0.15s; flex: 1;">4</button>
                        <button type="button" onclick="window.selectSetsAndAdd(5)" class="sets-btn" style="padding: 0.75rem 1.25rem; background: var(--surface-elevated); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1.1rem; cursor: pointer; transition: all 0.15s; flex: 1;">5</button>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" id="customSetsInput" placeholder="Eller skriv antal..." min="1" max="10" style="flex: 1;" oninput="window.checkCustomSets()">
                        <button id="customSetsBtn" class="btn btn-primary" onclick="window.addWithCustomSets()" style="display: none; padding: 0.5rem 1rem;">L√§gg till</button>
                    </div>
                </div>
                
                <!-- Toggle for all weeks vs current week only -->
                <div style="margin-top: 1rem; margin-bottom: 1rem;">
                    <div id="allWeeksToggle" onclick="toggleAllWeeks()" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem; background: var(--surface-elevated); border-radius: 8px; cursor: pointer; user-select: none;">
                        <div id="allWeeksTrack" style="width: 36px; height: 20px; background: var(--accent); border-radius: 10px; position: relative; transition: background 0.2s; flex-shrink: 0;">
                            <div id="allWeeksThumb" style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 18px; transition: all 0.2s;"></div>
                        </div>
                        <span id="allWeeksLabel" style="font-size: 0.8rem; color: var(--text);">L√§gg till f√∂r alla veckor</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 0.75rem; display: none;" id="saveToLibrarySection">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.85rem; color: var(--text-muted);">
                    <input type="checkbox" id="saveToLibrary" style="cursor: pointer;">
                    <span>üíæ Spara till bibliotek</span>
                </label>
            </div>
        </div>
        
        <!-- Fixed bottom bar f√∂r valda √∂vningar -->
        <div id="selectedExercisesBar" style="display: none; position: absolute; bottom: 0; left: 0; right: 0; padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)); background: var(--surface-elevated); border-top: 1px solid var(--border); z-index: 10;">
            <div style="max-width: 500px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span id="selectedCount" style="color: var(--accent); font-weight: 600;">0 √∂vningar valda</span>
                </div>
                <button id="proceedSelectedBtn" onclick="window.proceedWithSelectedExercises()" style="width: 100%; padding: 1rem; background: var(--accent); border: none; border-radius: 10px; color: var(--primary); font-weight: 700; font-size: 1rem; cursor: pointer;">Forts√§tt</button>
            </div>
        </div>
    </div>

    <!-- Profile/Menu Modal -->
    <div class="modal" id="menuModal">
        <div class="modal-content" style="max-width: 360px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Meny</h3>
                <button class="close-btn" onclick="window.closeMenuModal()">√ó</button>
            </div>
            <div id="menuContent"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content" style="max-width: 360px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3>V√§lj profiltyp</h3>
                <button class="close-btn" onclick="window.closeLoginModal()">√ó</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.75rem; padding: 1rem 0;">
                <button onclick="window.createProfile('standard')" style="padding: 1.25rem; background: var(--surface); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
                    <div style="font-weight: 600; color: var(--text); font-size: 1rem; margin-bottom: 0.25rem;">üè† Egen tr√§ning</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Logga egen tr√§ning, skapa program, tracka progress</div>
                </button>
                <button onclick="window.createProfile('client')" style="padding: 1.25rem; background: var(--surface); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
                    <div style="font-weight: 600; color: var(--text); font-size: 1rem; margin-bottom: 0.25rem;">üë§ Klient</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">F√• program fr√•n din PT, logga tr√§ning</div>
                </button>
                <button onclick="window.createProfile('pt')" style="padding: 1.25rem; background: var(--surface); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
                    <div style="font-weight: 600; color: var(--text); font-size: 1rem; margin-bottom: 0.25rem;">üíº PT / Tr√§nare</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Hantera klienter, skapa och skicka program</div>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Setup Modal (for creating new profile) -->
    <div class="modal" id="profileSetupModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="profileSetupTitle">Skapa profil</h3>
                <button class="close-btn" onclick="window.closeProfileSetupModal()">√ó</button>
            </div>
            <div id="profileSetupContent"></div>
        </div>
    </div>

    <!-- Client Form Modal -->
    <div class="modal" id="clientFormModal">
        <div class="modal-content" style="max-width: 400px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--surface-elevated); padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border);">
                <h3>Fyll i formul√§r</h3>
                <button class="close-btn" onclick="window.closeClientFormModal()">√ó</button>
            </div>
            <div id="clientFormContent"></div>
        </div>
    </div>

    <!-- PT Dashboard Modal -->
    <div class="modal" id="ptDashboardModal">
        <div class="modal-content" style="max-width: 500px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--surface-elevated); padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border);">
                <h3>Mina klienter</h3>
                <button class="close-btn" onclick="window.closePTDashboardModal()">√ó</button>
            </div>
            <div id="ptDashboardContent"></div>
        </div>
    </div>

    <script>
        // Selected exercise data for step flow (needs to be at top for all functions to access)
        let selectedExerciseData = {
            name: '',
            muscleGroup: '',
            reps: '',
            sets: 3
        };
        
        // Exercise library
        // Default exercise library
        const defaultExerciseLibrary = {
            'Br√∂st': ['B√§nkpress', 'Lutande b√§nkpress', 'B√§nkpress med hantlar', 'Lutande hantelpress', 'Br√∂stpress i maskin', 'Kabel-flyes', 'Pec deck', 'Armh√§vningar', 'Dips', 'Ned√•tlutande b√§nkpress'],
            'Rygg': ['Marklyft', 'Latsdrag', 'Chins', 'Skivst√•ngsrodd', 'Sittande rodd i kabel', 'Enarms rodd med hantel', 'T-bar rodd', 'Pull-over', 'Face pulls', 'Ryggresningar'],
            'Axlar': ['Milit√§rpress', 'Axelpress med hantlar', 'Sidolyft med hantlar', 'Frontlyft', 'Omv√§nda flyes', 'Face pulls', 'Arnoldpress', 'Upright rows', 'Axelpress i maskin', 'Axelpress i kabel'],
            'Biceps': ['Skivst√•ngscurl', 'Hantelcurl', 'Hammarcurl', 'Preacher curl', 'Curl i kabel', 'Concentration curl', 'EZ-st√•ng curl', 'Lutande hantelcurl', 'Chins med smalt grepp', 'Spider curl'],
            'Triceps': ['Smal b√§nkpress', 'Dips', 'Pushdowns i kabel', 'Skull crushers', 'Triceps √∂ver huvudet', 'Kickbacks', 'Tricepsmaskin', 'Smala armh√§vningar', 'Fransk press', 'Enarms triceps i kabel'],
            'Framsida l√•r': ['Kn√§b√∂j', 'Frontb√∂j', 'Benpress', 'Hack squat', 'Utfall fram√•t', 'Bulgariska split squats', 'Step-ups', 'Benspark', 'Sissy squats', 'Goblet squats'],
            'Baksida l√•r': ['Marklyft', 'Rum√§nska marklyft', 'Liggande l√•rcurl', 'Sittande l√•rcurl', 'Good mornings', 'Glute-ham raises', 'Kettlebell swings', 'Stela marklyft', 'Enbens marklyft', 'Drag bak√•t i kabel'],
            'Rumpa': ['Hip thrust', 'Kn√§b√∂j', 'Marklyft', 'Bulgariska split squats', 'Glute bridges', 'Kickbacks i kabel', 'Step-ups', 'Frog pumps', 'Utfall bak√•t', 'Drag bak√•t i kabel'],
            'Vader': ['St√•ende vadpress', 'Sittande vadpress', 'Vadpress i smithmaskin', 'Enbens vadpress', 'Donkey calf raises', 'Hopprep', 'Farmers walk p√• t√•', 'Box jumps', 'Vadpress i benpress', 'Explosiva t√•hopp'],
            'Mage': ['Plankan', 'H√§ngande benlyft', 'Crunches', 'Crunch i kabel', 'Russian twists', 'Ab wheel', 'Sit-ups', 'Cykelcrunches', 'Mountain climbers', 'Pallof press']
        };
        
        // Simple storage using localStorage
        const storage = {
            save: (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
            },
            load: (key) => {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            },
            delete: (key) => {
                localStorage.removeItem(key);
            }
        };
        
        // Load exercise library from localStorage or use default
        let exerciseLibrary = storage.load('exerciseLibrary') || JSON.parse(JSON.stringify(defaultExerciseLibrary));
        
        // Load program templates from localStorage with categorization
        let programTemplates = storage.load('programTemplates') || [];
        
        // Built-in program templates - prioriterade tr√§ningsprogram
        const builtInTemplates = [
            // TJEJ ‚Äì STYRKA ‚Äì NYB√ñRJARE ‚Äì 2 DAGAR
            {
                name: 'Styrka Nyb√∂rjare 2 dagar',
                gender: 'Kvinna',
                type: 'Styrka',
                level: 'Nyb√∂rjare',
                weeksCount: 8,
                isBuiltIn: true,
                days: [
                    { name: 'UPPER', exercises: [
                        {name:'Axelpress med hantlar',muscleGroup:'Axlar',reps:'8-12',sets:3},
                        {name:'Latsdrag',muscleGroup:'Rygg',reps:'8-12',sets:3},
                        {name:'B√§nkpress med hantlar',muscleGroup:'Br√∂st',reps:'8-12',sets:3},
                        {name:'Sidolyft med hantlar',muscleGroup:'Axlar',reps:'12-15',sets:3},
                        {name:'Pushdowns i kabel',muscleGroup:'Triceps',reps:'10-15',sets:3}
                    ]},
                    { name: 'LOWER', exercises: [
                        {name:'Kn√§b√∂j',muscleGroup:'Ben',reps:'8-12',sets:3},
                        {name:'Hip thrust',muscleGroup:'Ben',reps:'10-12',sets:3},
                        {name:'Liggande l√•rcurl',muscleGroup:'Ben',reps:'10-12',sets:3},
                        {name:'Step-ups',muscleGroup:'Ben',reps:'10-12',sets:3},
                        {name:'St√•ende vadpress',muscleGroup:'Ben',reps:'12-15',sets:3},
                        {name:'Plankan',muscleGroup:'Core',reps:'30-60s',sets:3}
                    ]}
                ]
            },
            
            // TJEJ ‚Äì STYRKA ‚Äì MEDEL ‚Äì 4 DAGAR
            {
                name: 'Styrka Medel 4 dagar',
                gender: 'Kvinna',
                type: 'Styrka',
                level: 'Medel',
                weeksCount: 8,
                isBuiltIn: true,
                days: [
                    { name: 'UPPER A', exercises: [
                        {name:'Axelpress med hantlar',muscleGroup:'Axlar',reps:'8-10',sets:4},
                        {name:'Sittande rodd i kabel',muscleGroup:'Rygg',reps:'8-10',sets:4},
                        {name:'Lutande hantelpress',muscleGroup:'Br√∂st',reps:'8-10',sets:3},
                        {name:'Sidolyft med hantlar',muscleGroup:'Axlar',reps:'12-15',sets:3},
                        {name:'Enarms triceps i kabel',muscleGroup:'Triceps',reps:'10-12',sets:3}
                    ]},
                    { name: 'LOWER A', exercises: [
                        {name:'Kn√§b√∂j',muscleGroup:'Ben',reps:'6-10',sets:4},
                        {name:'Hip thrust',muscleGroup:'Ben',reps:'8-12',sets:4},
                        {name:'Sittande l√•rcurl',muscleGroup:'Ben',reps:'10-12',sets:3},
                        {name:'Utfall bak√•t',muscleGroup:'Ben',reps:'10-12',sets:3},
                        {name:'Vadpress i benpress',muscleGroup:'Ben',reps:'12-15',sets:3}
                    ]},
                    { name: 'UPPER B', exercises: [
                        {name:'Arnoldpress',muscleGroup:'Axlar',reps:'8-10',sets:4},
                        {name:'Latsdrag',muscleGroup:'Rygg',reps:'8-10',sets:4},
                        {name:'Kabel-flyes',muscleGroup:'Br√∂st',reps:'10-12',sets:3},
                        {name:'Face pulls',muscleGroup:'Axlar',reps:'12-15',sets:3},
                        {name:'Hantelcurl',muscleGroup:'Biceps',reps:'10-12',sets:3}
                    ]},
                    { name: 'LOWER B', exercises: [
                        {name:'Benpress',muscleGroup:'Ben',reps:'8-12',sets:4},
                        {name:'Rum√§nska marklyft',muscleGroup:'Ben',reps:'8-10',sets:4},
                        {name:'Bulgariska split squats',muscleGroup:'Ben',reps:'10-12',sets:3},
                        {name:'Enbens vadpress',muscleGroup:'Ben',reps:'12-15',sets:3},
                        {name:'Crunches',muscleGroup:'Core',reps:'15-20',sets:3}
                    ]}
                ]
            },
            
            // TJEJ ‚Äì DEFF ‚Äì 3 DAGAR
            {
                name: 'Deff 3 dagar',
                gender: 'Kvinna',
                type: 'Styrka',
                level: 'Nyb√∂rjare',
                weeksCount: 8,
                isBuiltIn: true,
                days: [
                    { name: 'DAG 1', exercises: [
                        {name:'Goblet squats',muscleGroup:'Ben',reps:'12-15',sets:3},
                        {name:'Step-ups',muscleGroup:'Ben',reps:'12-15',sets:3},
                        {name:'Sidolyft med hantlar',muscleGroup:'Axlar',reps:'12-15',sets:3},
                        {name:'Mountain climbers',muscleGroup:'Core',reps:'30-45s',sets:3}
                    ]},
                    { name: 'DAG 2', exercises: [
                        {name:'Hip thrust',muscleGroup:'Ben',reps:'12-15',sets:3},
                        {name:'Latsdrag',muscleGroup:'Rygg',reps:'12-15',sets:3},
                        {name:'Armh√§vningar',muscleGroup:'Br√∂st',reps:'8-12',sets:3},
                        {name:'Russian twists',muscleGroup:'Core',reps:'15-20',sets:3}
                    ]},
                    { name: 'DAG 3', exercises: [
                        {name:'Utfall fram√•t',muscleGroup:'Ben',reps:'12-15',sets:3},
                        {name:'Kickbacks i kabel',muscleGroup:'Ben',reps:'12-15',sets:3},
                        {name:'Face pulls',muscleGroup:'Axlar',reps:'12-15',sets:3},
                        {name:'Plankan',muscleGroup:'Core',reps:'45-60s',sets:3}
                    ]}
                ]
            },
            
            // KILLE ‚Äì STYRKA ‚Äì NYB√ñRJARE ‚Äì 3 DAGAR
            {
                name: 'Styrka Nyb√∂rjare 3 dagar',
                gender: 'Man',
                type: 'Styrka',
                level: 'Nyb√∂rjare',
                weeksCount: 8,
                isBuiltIn: true,
                days: [
                    { name: 'DAG 1', exercises: [
                        {name:'B√§nkpress',muscleGroup:'Br√∂st',reps:'6-10',sets:4},
                        {name:'Skivst√•ngsrodd',muscleGroup:'Rygg',reps:'6-10',sets:4},
                        {name:'Axelpress i maskin',muscleGroup:'Axlar',reps:'8-12',sets:3}
                    ]},
                    { name: 'DAG 2', exercises: [
                        {name:'Kn√§b√∂j',muscleGroup:'Ben',reps:'6-10',sets:4},
                        {name:'Marklyft',muscleGroup:'Rygg',reps:'5-8',sets:4},
                        {name:'St√•ende vadpress',muscleGroup:'Ben',reps:'12-15',sets:3}
                    ]},
                    { name: 'DAG 3', exercises: [
                        {name:'Latsdrag',muscleGroup:'Rygg',reps:'8-12',sets:3},
                        {name:'Smal b√§nkpress',muscleGroup:'Triceps',reps:'8-10',sets:3},
                        {name:'Skivst√•ngscurl',muscleGroup:'Biceps',reps:'8-12',sets:3},
                        {name:'Plankan',muscleGroup:'Core',reps:'45-60s',sets:3}
                    ]}
                ]
            },
            
            // KILLE ‚Äì BULK ‚Äì MEDEL ‚Äì 5 DAGAR
            {
                name: 'Bulk Medel 5 dagar',
                gender: 'Man',
                type: 'Styrka',
                level: 'Medel',
                weeksCount: 8,
                isBuiltIn: true,
                days: [
                    { name: 'PUSH', exercises: [
                        {name:'B√§nkpress',muscleGroup:'Br√∂st',reps:'6-8',sets:4},
                        {name:'Axelpress med hantlar',muscleGroup:'Axlar',reps:'8-10',sets:4},
                        {name:'Sidolyft med hantlar',muscleGroup:'Axlar',reps:'12-15',sets:3},
                        {name:'Pushdowns i kabel',muscleGroup:'Triceps',reps:'10-12',sets:3}
                    ]},
                    { name: 'PULL', exercises: [
                        {name:'Marklyft',muscleGroup:'Rygg',reps:'5-6',sets:4},
                        {name:'Latsdrag',muscleGroup:'Rygg',reps:'8-10',sets:4},
                        {name:'Skivst√•ngsrodd',muscleGroup:'Rygg',reps:'8-10',sets:4},
                        {name:'EZ-st√•ng curl',muscleGroup:'Biceps',reps:'10-12',sets:3}
                    ]},
                    { name: 'LEGS', exercises: [
                        {name:'Kn√§b√∂j',muscleGroup:'Ben',reps:'6-8',sets:4},
                        {name:'Rum√§nska marklyft',muscleGroup:'Ben',reps:'8-10',sets:4},
                        {name:'Benpress',muscleGroup:'Ben',reps:'10-12',sets:4},
                        {name:'St√•ende vadpress',muscleGroup:'Ben',reps:'12-15',sets:4}
                    ]},
                    { name: 'ARMAR/AXLAR', exercises: [
                        {name:'Face pulls',muscleGroup:'Axlar',reps:'12-15',sets:3},
                        {name:'Hantelcurl',muscleGroup:'Biceps',reps:'10-12',sets:3},
                        {name:'Skull crushers',muscleGroup:'Triceps',reps:'10-12',sets:3}
                    ]},
                    { name: 'CORE', exercises: [
                        {name:'H√§ngande benlyft',muscleGroup:'Core',reps:'10-15',sets:4},
                        {name:'Ab wheel',muscleGroup:'Core',reps:'10-12',sets:3}
                    ]}
                ]
            }
        ];
        
        
        
        // Program types that can be edited
        let programTypes = storage.load('programTypes') || [
            'Styrka', 'Kroppsvikt', 'Calisthenics'
        ];
        
        // Save library to localStorage
        function saveExerciseLibrary() {
            storage.save('exerciseLibrary', exerciseLibrary);
        }
        
        // Muscle group color map
        function getMuscleColor(muscleGroup) {
            const muscleColors = {
                'Br√∂st': '#6B9FFF',           // Bl√•
                'Rygg': '#4ECDC4',            // Turkos
                'Axlar': '#FFB366',           // Varm orange
                'Biceps': '#A8E6CF',          // Mintgr√∂n
                'Triceps': '#C9A7FF',         // Lila
                'Ben': '#7DD3FC',             // Ljusbl√•
                'Framsida l√•r': '#7DD3FC',    // Ljusbl√•
                'Baksida l√•r': '#B4A7D6',     // Lila
                'Rumpa': '#FFB3E6',           // Ljusrosa
                'Vader': '#95E1D3',           // Mint
                'Mage': '#FDB777',            // Persika/orange
                'Core': '#FDB777',            // Persika/orange (alias)
                'Hela kroppen': '#B4A7D6'     // Lila
            };
            return muscleColors[muscleGroup] || '#00e5a0';
        }
        
        // App state
        let programs = storage.load('programs') || [];
        let currentProgram = null;
        let currentWeek = 1;
        let currentDay = null;
        let currentMobileDay = null; // Track which day is open on mobile (null = show day list)
        let editModes = {}; // Track edit mode for each day
        let programListEditMode = false; // Track edit mode for program list
        let addToAllWeeks = true; // Toggle for adding exercise to all weeks vs current only
        
        // Free training state
        let freeTrainingMode = false;
        let freeTrainingDays = storage.load('freeTrainingDays') || []; // Array of saved free training days
        let currentFreeDay = null; // Currently open free day (null = new day, index = existing day)
        let tempFreeWeight = null; // Temporary weight storage for step-based input
        let ptMode = storage.load('ptMode') || false; // PT mode for admin access
        let collapsedDays = {}; // Track which days are collapsed (default: all collapsed)
        let libraryEditMode = false; // Track edit mode for exercise library
        let activeExercises = {}; // Track which exercise is active for input (format: "dayIndex-exIndex")
        let activeSet = null; // Track active set for input (format: "dayIndex-exIndex-setIndex")
        let inputStep = 'weight'; // Track input step: 'weight' or 'reps' (for new entries)
        
        // Workout mode (helsk√§rmsl√§ge f√∂r loggning)
        let workoutModeActive = false;
        let restTimerSeconds = 0;
        let restTimerInterval = null;
        let restTimerRunning = false;
        
        // Profile system
        let profiles = storage.load('profiles') || [];
        let currentProfile = storage.load('currentProfile') || null;
        
        // Profile types: 'standard', 'client', 'pt'
        // Client has unique ID, limited permissions
        // PT can manage clients, create programs for them
        
        function generateClientId() {
            return 'C' + Math.random().toString(36).substr(2, 8).toUpperCase();
        }
        
        function generatePTId() {
            return 'PT' + Math.random().toString(36).substr(2, 6).toUpperCase();
        }
        
        // Profile functions
        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }
        
        function showLoginModal() {
            renderLoginContent();
            document.getElementById('loginModal').classList.add('show');
        }
        
        function renderLoginContent() {
            const modal = document.getElementById('loginModal');
            const content = modal.querySelector('.modal-content');
            
            let html = `
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>${profiles.length > 0 ? 'V√§lj profil' : 'Skapa profil'}</h3>
                    ${currentProfile ? `<button class="close-btn" onclick="window.closeLoginModal()">√ó</button>` : ''}
                </div>
            `;
            
            // Show existing profiles
            if (profiles.length > 0) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Dina profiler</div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 250px; overflow-y: auto;">
                `;
                
                profiles.forEach((p, i) => {
                    const typeIcon = p.type === 'pt' ? 'üíº' : p.type === 'client' ? 'üë§' : 'üè†';
                    const typeName = p.type === 'pt' ? 'PT' : p.type === 'client' ? 'Klient' : 'Egen';
                    const isActive = currentProfile && currentProfile.id === p.id;
                    const bgColor = isActive ? 'rgba(0, 229, 160, 0.1)' : 'var(--surface)';
                    const borderColor = isActive ? 'var(--accent)' : 'var(--border)';
                    
                    html += `
                        <button onclick="window.selectExistingProfile(${i})" style="padding: 1rem; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.5rem;">${typeIcon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text);">${p.name}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${typeName}${p.uniqueId ? ' ‚Ä¢ ' + p.uniqueId : ''}</div>
                                </div>
                                ${isActive ? '<span style="color: var(--accent); font-size: 1.2rem;">‚úì</span>' : ''}
                            </div>
                        </button>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                        <div style="flex: 1; height: 1px; background: var(--border);"></div>
                        <span style="color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase;">Eller skapa ny</span>
                        <div style="flex: 1; height: 1px; background: var(--border);"></div>
                    </div>
                `;
            }
            
            // Show create new profile options
            html += `
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button onclick="window.createProfile('standard')" style="padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
                        <span style="font-size: 1.2rem;">üè†</span>
                        <div>
                            <div style="font-weight: 500; color: var(--text); font-size: 0.9rem;">Egen tr√§ning</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Logga tr√§ning, skapa program</div>
                        </div>
                    </button>
                    <button onclick="window.createProfile('client')" style="padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
                        <span style="font-size: 1.2rem;">üë§</span>
                        <div>
                            <div style="font-weight: 500; color: var(--text); font-size: 0.9rem;">Klient</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">F√• program fr√•n din PT</div>
                        </div>
                    </button>
                    <button onclick="window.createProfile('pt')" style="padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
                        <span style="font-size: 1.2rem;">üíº</span>
                        <div>
                            <div style="font-weight: 500; color: var(--text); font-size: 0.9rem;">PT / Tr√§nare</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Hantera klienter</div>
                        </div>
                    </button>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        function selectExistingProfile(index) {
            if (index < 0 || index >= profiles.length) return;
            
            // Save current profile data first
            if (currentProfile) {
                saveProfileData();
            }
            
            // Switch to selected profile
            currentProfile = profiles[index];
            storage.save('currentProfile', currentProfile);
            
            // Load new profile data
            loadProfileData();
            
            closeLoginModal();
            
            // Update UI
            updateModeButton();
            render();
        }
        
        window.selectExistingProfile = selectExistingProfile;
        
        function showMenuModal() {
            renderMenuContent();
            document.getElementById('menuModal').classList.add('show');
        }
        
        function closeMenuModal() {
            document.getElementById('menuModal').classList.remove('show');
        }
        
        function closeProfileSetupModal() {
            document.getElementById('profileSetupModal').classList.remove('show');
            // Om vi inte har en aktiv profil, visa login modal igen
            if (!currentProfile) {
                showLoginModal();
            }
        }
        
        function closeClientFormModal() {
            document.getElementById('clientFormModal').classList.remove('show');
        }
        
        function closePTDashboardModal() {
            document.getElementById('ptDashboardModal').classList.remove('show');
        }
        
        function renderMenuContent() {
            const menuContent = document.getElementById('menuContent');
            
            if (!currentProfile) {
                menuContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">Ingen profil aktiv</p>
                        <button onclick="window.showLoginModal(); window.closeMenuModal();" class="btn btn-primary" style="width: 100%;">Logga in</button>
                    </div>
                `;
                return;
            }
            
            const profile = currentProfile;
            const profileTypeNames = {
                'standard': 'üè† Egen tr√§ning',
                'client': 'üë§ Klient',
                'pt': 'üíº PT / Tr√§nare'
            };
            
            let html = `
                <div style="padding: 1rem; background: var(--surface); border-radius: 12px; margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: var(--text); font-size: 1rem;">${profile.name || 'Anv√§ndare'}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">${profileTypeNames[profile.type] || profile.type}</div>
                    ${profile.uniqueId ? `<div style="font-size: 0.7rem; color: var(--accent); margin-top: 0.25rem;">ID: ${profile.uniqueId}</div>` : ''}
                </div>
            `;
            
            // PT-specific options
            if (profile.type === 'pt') {
                html += `
                    <button onclick="window.openPTDashboard()" style="width: 100%; padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; text-align: left; margin-bottom: 0.5rem; color: var(--text);">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.2rem;">üë•</span>
                            <div>
                                <div style="font-weight: 500;">Mina klienter</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${(profile.clients || []).length} klienter</div>
                            </div>
                        </div>
                    </button>
                `;
            }
            
            // Client-specific options
            if (profile.type === 'client') {
                const hasNewPrograms = (profile.pendingPrograms || []).length > 0;
                html += `
                    <button onclick="window.openClientInbox()" style="width: 100%; padding: 1rem; background: var(--surface); border: 1px solid ${hasNewPrograms ? 'var(--accent)' : 'var(--border)'}; border-radius: 10px; cursor: pointer; text-align: left; margin-bottom: 0.5rem; color: var(--text); position: relative;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.2rem;">üì•</span>
                            <div>
                                <div style="font-weight: 500;">Program fr√•n PT</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${hasNewPrograms ? (profile.pendingPrograms || []).length + ' nya' : 'Inga nya'}</div>
                            </div>
                        </div>
                        ${hasNewPrograms ? `<span style="position: absolute; top: -5px; right: -5px; background: var(--accent); color: var(--primary); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600;">${(profile.pendingPrograms || []).length}</span>` : ''}
                    </button>
                `;
                
                // Show form button if not filled
                if (!profile.formCompleted) {
                    html += `
                        <button onclick="window.openClientForm()" style="width: 100%; padding: 1rem; background: rgba(0, 229, 160, 0.1); border: 1px solid var(--accent); border-radius: 10px; cursor: pointer; text-align: left; margin-bottom: 0.5rem; color: var(--text);">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.2rem;">üìù</span>
                                <div>
                                    <div style="font-weight: 500; color: var(--accent);">Fyll i formul√§r</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Hj√§lp din PT att skapa ditt program</div>
                                </div>
                            </div>
                        </button>
                    `;
                }
            }
            
            // Switch profile / Logout / Delete profile
            html += `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem;">
                    <button onclick="window.switchProfile()" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text); font-size: 0.85rem;">
                        Byt profil
                    </button>
                    <button onclick="window.logout()" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--danger); font-size: 0.85rem;">
                        Logga ut
                    </button>
                </div>
                <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button onclick="window.deleteCurrentProfile()" style="padding: 0.4rem 0.8rem; background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 0.7rem; opacity: 0.5;">
                        Ta bort profil
                    </button>
                </div>
            `;
            
            menuContent.innerHTML = html;
        }
        
        function deleteCurrentProfile() {
            if (!currentProfile) return;
            
            if (!confirm('Ta bort profil?')) return;
            if (!confirm('Alla dina loggar kommer att raderas. Vill du √§nd√• g√• vidare?')) return;
            
            // Remove profile from array
            const index = profiles.findIndex(p => p.id === currentProfile.id);
            if (index !== -1) {
                profiles.splice(index, 1);
                storage.save('profiles', profiles);
            }
            
            // Clear current profile
            currentProfile = null;
            storage.save('currentProfile', null);
            
            closeMenuModal();
            showLoginModal();
        }
        
        window.deleteCurrentProfile = deleteCurrentProfile;
        
        function createProfile(type) {
            closeLoginModal();
            
            const setupModal = document.getElementById('profileSetupModal');
            const setupContent = document.getElementById('profileSetupContent');
            const setupTitle = document.getElementById('profileSetupTitle');
            
            const titles = {
                'standard': 'Skapa profil - Egen tr√§ning',
                'client': 'Skapa profil - Klient',
                'pt': 'Skapa profil - PT'
            };
            
            setupTitle.textContent = titles[type] || 'Skapa profil';
            
            let html = `
                <div style="padding: 0.5rem 0;">
                    <div class="form-group">
                        <label>Ditt namn</label>
                        <input type="text" id="profileName" placeholder="F√∂rnamn" maxlength="30" style="width: 100%;">
                    </div>
            `;
            
            // L√§gg till K√∂n och Niv√• f√∂r standard-profiler
            if (type === 'standard') {
                html += `
                    <div class="form-group">
                        <label>K√∂n</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" id="genderMan" onclick="window.selectProfileGender('man')" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer;">Man</button>
                            <button type="button" id="genderWoman" onclick="window.selectProfileGender('woman')" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer;">Kvinna</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tr√§ningsniv√•</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" id="levelBeginner" onclick="window.selectProfileLevel('beginner')" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-size: 0.85rem;">Nyb√∂rjare</button>
                            <button type="button" id="levelIntermediate" onclick="window.selectProfileLevel('intermediate')" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-size: 0.85rem;">Medel</button>
                            <button type="button" id="levelAdvanced" onclick="window.selectProfileLevel('advanced')" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-size: 0.85rem;">Avancerad</button>
                        </div>
                    </div>
                `;
            }
            
            if (type === 'client') {
                html += `
                    <div style="background: rgba(0, 229, 160, 0.1); border: 1px solid var(--accent); border-radius: 10px; padding: 1rem; margin: 1rem 0;">
                        <div style="font-size: 0.85rem; color: var(--text);">
                            <strong>Ditt unika klient-ID genereras automatiskt.</strong><br>
                            <span style="color: var(--text-muted);">Dela detta ID med din PT s√• att hen kan skicka program till dig.</span>
                        </div>
                    </div>
                `;
            }
            
            if (type === 'pt') {
                html += `
                    <div style="background: rgba(0, 229, 160, 0.1); border: 1px solid var(--accent); border-radius: 10px; padding: 1rem; margin: 1rem 0;">
                        <div style="font-size: 0.85rem; color: var(--text);">
                            <strong>Som PT kan du:</strong><br>
                            <span style="color: var(--text-muted);">‚Ä¢ L√§gga till klienter via deras ID<br>‚Ä¢ Skapa och skicka program<br>‚Ä¢ Se klienters progress</span>
                        </div>
                    </div>
                `;
            }
            
            html += `
                    <button onclick="window.saveNewProfile('${type}')" class="btn btn-primary" style="width: 100%; padding: 1rem; margin-top: 1rem;">
                        Skapa profil
                    </button>
                </div>
            `;
            
            setupContent.innerHTML = html;
            setupModal.classList.add('show');
            
            // Reset profile creation state
            window.newProfileGender = null;
            window.newProfileLevel = null;
            
            setTimeout(() => {
                document.getElementById('profileName')?.focus();
            }, 100);
        }
        
        // Profil-val f√∂r k√∂n och niv√•
        function selectProfileGender(gender) {
            window.newProfileGender = gender;
            document.getElementById('genderMan').style.background = gender === 'man' ? 'var(--accent)' : 'var(--surface)';
            document.getElementById('genderMan').style.borderColor = gender === 'man' ? 'var(--accent)' : 'var(--border)';
            document.getElementById('genderMan').style.color = gender === 'man' ? 'var(--primary)' : 'var(--text)';
            document.getElementById('genderWoman').style.background = gender === 'woman' ? 'var(--accent)' : 'var(--surface)';
            document.getElementById('genderWoman').style.borderColor = gender === 'woman' ? 'var(--accent)' : 'var(--border)';
            document.getElementById('genderWoman').style.color = gender === 'woman' ? 'var(--primary)' : 'var(--text)';
        }
        
        function selectProfileLevel(level) {
            window.newProfileLevel = level;
            ['beginner', 'intermediate', 'advanced'].forEach(l => {
                const btn = document.getElementById('level' + l.charAt(0).toUpperCase() + l.slice(1));
                if (btn) {
                    btn.style.background = l === level ? 'var(--accent)' : 'var(--surface)';
                    btn.style.borderColor = l === level ? 'var(--accent)' : 'var(--border)';
                    btn.style.color = l === level ? 'var(--primary)' : 'var(--text)';
                }
            });
        }
        
        window.selectProfileGender = selectProfileGender;
        window.selectProfileLevel = selectProfileLevel;
        
        function saveNewProfile(type) {
            const name = document.getElementById('profileName').value.trim();
            
            if (!name) {
                alert('Ange ditt namn');
                return;
            }
            
            const newProfile = {
                id: Date.now().toString(),
                name: name,
                type: type,
                createdAt: new Date().toISOString(),
                programs: [],
                freeTrainingDays: [],
                isAdmin: profiles.length === 0, // First user is admin
                gender: window.newProfileGender || null,
                level: window.newProfileLevel || null
            };
            
            if (type === 'client') {
                newProfile.uniqueId = generateClientId();
                newProfile.formCompleted = false;
                newProfile.formData = null;
                newProfile.pendingPrograms = [];
                newProfile.ptId = null;
            }
            
            if (type === 'pt') {
                newProfile.uniqueId = generatePTId();
                newProfile.clients = [];
            }
            
            profiles.push(newProfile);
            storage.save('profiles', profiles);
            
            currentProfile = newProfile;
            storage.save('currentProfile', currentProfile);
            
            closeProfileSetupModal();
            
            // Load profile data and render
            loadProfileData();
            renderDaySelector();
            populateProgramTypes();
            updateModeButton();
            updateColorScheme();
            render();
            setupEventListeners();
            
            // Show welcome message for client
            if (type === 'client') {
                setTimeout(() => {
                    alert(`V√§lkommen ${name}!\n\nDitt klient-ID √§r: ${newProfile.uniqueId}\n\nDela detta med din PT s√• att hen kan skicka program till dig.`);
                }, 300);
            }
        }
        
        function loadProfileData() {
            if (!currentProfile) return;
            
            // Load profile-specific data
            programs = currentProfile.programs || [];
            freeTrainingDays = currentProfile.freeTrainingDays || [];
            
            // Set ptMode based on profile type
            if (currentProfile.type === 'client') {
                ptMode = false; // Clients can't access PT mode
            } else if (currentProfile.type === 'standard') {
                ptMode = storage.load('ptMode_' + currentProfile.id) || false;
            } else if (currentProfile.type === 'pt') {
                ptMode = true; // PTs always have full access
            }
        }
        
        function saveProfileData() {
            if (!currentProfile) return;
            
            currentProfile.programs = programs;
            currentProfile.freeTrainingDays = freeTrainingDays;
            
            // Update in profiles array
            const index = profiles.findIndex(p => p.id === currentProfile.id);
            if (index !== -1) {
                profiles[index] = currentProfile;
                storage.save('profiles', profiles);
            }
            
            storage.save('currentProfile', currentProfile);
        }
        
        // Override storage.save for programs and freeTrainingDays to auto-save to profile
        const originalStorageSave = storage.save;
        storage.save = function(key, data) {
            if (key === 'programs' && currentProfile) {
                currentProfile.programs = data;
                saveProfileData();
            } else if (key === 'freeTrainingDays' && currentProfile) {
                currentProfile.freeTrainingDays = data;
                saveProfileData();
            } else {
                originalStorageSave(key, data);
            }
        };
        
        function switchProfile() {
            closeMenuModal();
            showLoginModal();
        }
        
        function switchToProfile(index) {
            if (index < 0 || index >= profiles.length) return;
            
            // Save current profile data first
            saveProfileData();
            
            // Switch to new profile
            currentProfile = profiles[index];
            storage.save('currentProfile', currentProfile);
            
            // Load new profile data
            loadProfileData();
            
            closeMenuModal();
            render();
        }
        
        function logout() {
            saveProfileData();
            currentProfile = null;
            storage.save('currentProfile', null);
            closeMenuModal();
            showLoginModal();
        }
        
        // Client-specific functions
        function openClientForm() {
            closeMenuModal();
            renderClientForm();
            document.getElementById('clientFormModal').classList.add('show');
        }
        
        let clientFormStep = 1;
        let clientFormData = {};
        
        function renderClientForm() {
            const content = document.getElementById('clientFormContent');
            
            const steps = [
                { field: 'intro', label: 'Intro', type: 'intro' },
                { field: 'firstName', label: 'F√∂rnamn', type: 'text', placeholder: 'Ditt f√∂rnamn' },
                { field: 'lastName', label: 'Efternamn', type: 'text', placeholder: 'Ditt efternamn' },
                { field: 'age', label: '√Ölder', type: 'number', placeholder: 'Din √•lder' },
                { field: 'gender', label: 'K√∂n', type: 'choice', options: ['Man', 'Kvinna'] },
                { field: 'height', label: 'L√§ngd (cm)', type: 'number', placeholder: 't.ex. 175' },
                { field: 'weight', label: 'Nuvarande vikt (kg)', type: 'number', placeholder: 't.ex. 75' },
                { field: 'goal', label: 'Vad √§r ditt prim√§ra m√•l?', type: 'choice', options: ['Bygga muskler', 'Br√§nna fett'] },
                { field: 'daysPerWeek', label: 'Hur m√•nga pass i veckan?', type: 'choice', options: ['2', '3', '4', '5', '6'] },
                { field: 'sessionLength', label: 'Hur l√§nge vill du tr√§na?', type: 'choice', options: ['30 min', '45 min', '60 min'] },
                { field: 'experience', label: 'Din erfarenhet?', type: 'choice', options: ['Nyb√∂rjare', 'Medel', 'Avancerad'] },
                { field: 'yearsTraining', label: 'Hur l√§nge har du tr√§nat?', type: 'choice', options: ['0-1 √•r', '1-2 √•r', '3+ √•r'] },
                { field: 'activityLevel', label: 'Aktivitetsniv√• idag?', type: 'choice', options: ['Stilla sittande', 'N√•got r√∂rlig', 'Aktiv', 'Mycket aktiv'] },
                { field: 'comments', label: '√ñvriga kommentarer', type: 'textarea', placeholder: 'Skador, begr√§nsningar, √∂nskem√•l...' }
            ];
            
            const step = steps[clientFormStep - 1];
            const progress = ((clientFormStep - 1) / (steps.length - 1)) * 100;
            
            let html = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="height: 4px; background: var(--surface); border-radius: 2px; overflow: hidden;">
                        <div style="height: 100%; width: ${progress}%; background: var(--accent); transition: width 0.3s;"></div>
                    </div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; text-align: center;">Steg ${clientFormStep} av ${steps.length}</div>
                </div>
            `;
            
            if (step.type === 'intro') {
                html += `
                    <div style="text-align: center; padding: 1rem 0;">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üìã</div>
                        <p style="color: var(--text); font-size: 1rem; line-height: 1.5;">
                            Det h√§r beh√∂ver jag som PT f√∂r att bygga ditt tr√§ningsprogram.
                        </p>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
                            Det tar ungef√§r 2 minuter att fylla i!
                        </p>
                    </div>
                    <button onclick="window.nextClientFormStep()" class="btn btn-primary" style="width: 100%; padding: 1rem; margin-top: 1rem;">
                        B√∂rja ‚Üí
                    </button>
                `;
            } else if (step.type === 'text' || step.type === 'number') {
                html += `
                    <div class="form-group">
                        <label style="font-size: 1.1rem; margin-bottom: 1rem; display: block;">${step.label}</label>
                        <input type="${step.type}" id="formInput" value="${clientFormData[step.field] || ''}" placeholder="${step.placeholder || ''}" style="width: 100%; padding: 1rem; font-size: 1.1rem;" ${step.type === 'number' ? 'inputmode="numeric"' : ''} oninput="window.updateClientFormData('${step.field}', this.value)">
                    </div>
                    ${renderFormNavButtons()}
                `;
            } else if (step.type === 'choice') {
                html += `
                    <div class="form-group">
                        <label style="font-size: 1.1rem; margin-bottom: 1rem; display: block;">${step.label}</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            ${step.options.map(opt => `
                                <button onclick="window.selectClientFormOption('${step.field}', '${opt}')" style="padding: 1rem; background: ${clientFormData[step.field] === opt ? 'var(--accent)' : 'var(--surface)'}; border: 2px solid ${clientFormData[step.field] === opt ? 'var(--accent)' : 'var(--border)'}; border-radius: 10px; cursor: pointer; color: ${clientFormData[step.field] === opt ? 'var(--primary)' : 'var(--text)'}; font-size: 1rem; transition: all 0.2s;">
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    ${renderFormNavButtons()}
                `;
            } else if (step.type === 'textarea') {
                html += `
                    <div class="form-group">
                        <label style="font-size: 1.1rem; margin-bottom: 1rem; display: block;">${step.label}</label>
                        <textarea id="formInput" placeholder="${step.placeholder || ''}" style="width: 100%; padding: 1rem; font-size: 1rem; min-height: 120px; resize: vertical;" oninput="window.updateClientFormData('${step.field}', this.value)">${clientFormData[step.field] || ''}</textarea>
                    </div>
                    <button onclick="window.submitClientForm()" class="btn btn-primary" style="width: 100%; padding: 1rem; margin-top: 1rem;">
                        ‚úì Skicka formul√§r
                    </button>
                    <button onclick="window.prevClientFormStep()" style="width: 100%; padding: 0.75rem; margin-top: 0.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text-muted);">
                        ‚Üê Tillbaka
                    </button>
                `;
            }
            
            content.innerHTML = html;
            
            // Focus input
            setTimeout(() => {
                const input = document.getElementById('formInput');
                if (input) input.focus();
            }, 100);
        }
        
        function renderFormNavButtons() {
            return `
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    ${clientFormStep > 1 ? `
                        <button onclick="window.prevClientFormStep()" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text-muted);">
                            ‚Üê Tillbaka
                        </button>
                    ` : ''}
                    <button onclick="window.nextClientFormStep()" class="btn btn-primary" style="flex: 2; padding: 0.75rem;">
                        N√§sta ‚Üí
                    </button>
                </div>
            `;
        }
        
        function updateClientFormData(field, value) {
            clientFormData[field] = value;
        }
        
        function selectClientFormOption(field, value) {
            clientFormData[field] = value;
            // Auto-advance after selection
            setTimeout(() => nextClientFormStep(), 200);
        }
        
        function nextClientFormStep() {
            clientFormStep++;
            renderClientForm();
        }
        
        function prevClientFormStep() {
            if (clientFormStep > 1) {
                clientFormStep--;
                renderClientForm();
            }
        }
        
        function submitClientForm() {
            currentProfile.formCompleted = true;
            currentProfile.formData = clientFormData;
            saveProfileData();
            
            closeClientFormModal();
            clientFormStep = 1;
            clientFormData = {};
            
            alert('Formul√§r skickat! Din PT kan nu se dina svar och skapa ett anpassat program.');
        }
        
        function openClientInbox() {
            closeMenuModal();
            // Show pending programs
            const pending = currentProfile.pendingPrograms || [];
            
            if (pending.length === 0) {
                alert('Inga nya program. Din PT har inte skickat n√•gra program √§nnu.');
                return;
            }
            
            // Show first pending program
            const program = pending[0];
            if (confirm(`Du har f√•tt ett nytt program: "${program.name}"\n\nVill du acceptera det?`)) {
                // Accept program
                programs.push(program);
                currentProfile.pendingPrograms = pending.slice(1);
                saveProfileData();
                render();
                alert('Program accepterat! Du hittar det under "Dina program".');
            }
        }
        
        // PT-specific functions
        function openPTDashboard() {
            closeMenuModal();
            renderPTDashboard();
            document.getElementById('ptDashboardModal').classList.add('show');
        }
        
        function renderPTDashboard() {
            const content = document.getElementById('ptDashboardContent');
            const clients = currentProfile.clients || [];
            
            let html = `
                <div style="margin-bottom: 1.5rem;">
                    <div class="form-group" style="margin-bottom: 0.5rem;">
                        <label style="font-size: 0.85rem;">L√§gg till klient</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="addClientId" placeholder="Klient-ID (t.ex. C12ABC34)" style="flex: 1; text-transform: uppercase;" maxlength="10">
                            <button onclick="window.addClientById()" class="btn btn-primary" style="padding: 0.5rem 1rem;">L√§gg till</button>
                        </div>
                    </div>
                </div>
            `;
            
            if (clients.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üë•</div>
                        <p>Inga klienter √§nnu</p>
                        <p style="font-size: 0.8rem;">Be dina klienter skapa ett konto och dela sitt ID med dig.</p>
                    </div>
                `;
            } else {
                html += `<div style="display: flex; flex-direction: column; gap: 0.75rem;">`;
                
                clients.forEach((client, index) => {
                    const clientProfile = profiles.find(p => p.uniqueId === client.id);
                    const hasForm = clientProfile?.formCompleted;
                    const programCount = clientProfile?.programs?.length || 0;
                    
                    html += `
                        <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text);">${client.name || clientProfile?.name || 'Klient'}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">ID: ${client.id}</div>
                                </div>
                                <button onclick="window.removeClient(${index})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 0.8rem;">Ta bort</button>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.75rem;">
                                ${hasForm ? `
                                    <button onclick="window.viewClientForm('${client.id}')" style="padding: 0.4rem 0.75rem; background: var(--surface-elevated); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text); font-size: 0.75rem;">
                                        üìã Formul√§r
                                    </button>
                                ` : `
                                    <span style="padding: 0.4rem 0.75rem; background: rgba(255,150,50,0.1); border: 1px solid rgba(255,150,50,0.3); border-radius: 6px; color: #ffa040; font-size: 0.75rem;">
                                        ‚è≥ V√§ntar p√• formul√§r
                                    </span>
                                `}
                                <button onclick="window.sendProgramToClient('${client.id}')" style="padding: 0.4rem 0.75rem; background: var(--accent); border: none; border-radius: 6px; cursor: pointer; color: var(--primary); font-size: 0.75rem; font-weight: 500;">
                                    üì§ Skicka program
                                </button>
                                <span style="padding: 0.4rem 0.75rem; background: var(--surface-elevated); border-radius: 6px; color: var(--text-muted); font-size: 0.75rem;">
                                    ${programCount} program
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            content.innerHTML = html;
        }
        
        function addClientById() {
            const input = document.getElementById('addClientId');
            const clientId = input.value.trim().toUpperCase();
            
            if (!clientId) {
                alert('Ange ett klient-ID');
                return;
            }
            
            // Find client profile
            const clientProfile = profiles.find(p => p.uniqueId === clientId && p.type === 'client');
            
            if (!clientProfile) {
                alert('Klient-ID hittades inte. Kontrollera att ID:t √§r korrekt och att klienten har skapat ett konto.');
                return;
            }
            
            // Check if already added
            if (currentProfile.clients?.some(c => c.id === clientId)) {
                alert('Denna klient √§r redan tillagd.');
                return;
            }
            
            // Add client
            if (!currentProfile.clients) currentProfile.clients = [];
            currentProfile.clients.push({
                id: clientId,
                name: clientProfile.name,
                addedAt: new Date().toISOString()
            });
            
            // Link PT to client
            clientProfile.ptId = currentProfile.uniqueId;
            
            // Update profiles
            const clientIndex = profiles.findIndex(p => p.id === clientProfile.id);
            if (clientIndex !== -1) {
                profiles[clientIndex] = clientProfile;
            }
            
            saveProfileData();
            storage.save('profiles', profiles);
            
            input.value = '';
            renderPTDashboard();
            
            alert(`${clientProfile.name} har lagts till som klient!`);
        }
        
        function removeClient(index) {
            if (!confirm('Ta bort denna klient?')) return;
            
            const client = currentProfile.clients[index];
            
            // Unlink PT from client
            const clientProfile = profiles.find(p => p.uniqueId === client.id);
            if (clientProfile) {
                clientProfile.ptId = null;
                const clientIndex = profiles.findIndex(p => p.id === clientProfile.id);
                if (clientIndex !== -1) {
                    profiles[clientIndex] = clientProfile;
                }
            }
            
            currentProfile.clients.splice(index, 1);
            saveProfileData();
            storage.save('profiles', profiles);
            renderPTDashboard();
        }
        
        function viewClientForm(clientId) {
            const clientProfile = profiles.find(p => p.uniqueId === clientId);
            if (!clientProfile?.formData) {
                alert('Klienten har inte fyllt i formul√§ret √§n.');
                return;
            }
            
            const form = clientProfile.formData;
            const formText = `
Namn: ${form.firstName || ''} ${form.lastName || ''}
√Ölder: ${form.age || '-'}
K√∂n: ${form.gender || '-'}
L√§ngd: ${form.height || '-'} cm
Vikt: ${form.weight || '-'} kg

M√•l: ${form.goal || '-'}
Pass/vecka: ${form.daysPerWeek || '-'}
Passl√§ngd: ${form.sessionLength || '-'}

Erfarenhet: ${form.experience || '-'}
Tr√§nat: ${form.yearsTraining || '-'}
Aktivitetsniv√•: ${form.activityLevel || '-'}

Kommentarer: ${form.comments || 'Inga'}
            `.trim();
            
            alert(formText);
        }
        
        function sendProgramToClient(clientId) {
            if (programs.length === 0) {
                alert('Du har inga program att skicka. Skapa ett program f√∂rst.');
                return;
            }
            
            // Simple selection - show list of programs
            const programList = programs.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
            const selection = prompt(`V√§lj program att skicka:\n\n${programList}\n\nAnge nummer:`);
            
            if (!selection) return;
            
            const programIndex = parseInt(selection) - 1;
            if (isNaN(programIndex) || programIndex < 0 || programIndex >= programs.length) {
                alert('Ogiltigt val');
                return;
            }
            
            const programToSend = JSON.parse(JSON.stringify(programs[programIndex]));
            programToSend.sentBy = currentProfile.uniqueId;
            programToSend.sentAt = new Date().toISOString();
            
            // Find client and add to pending
            const clientProfile = profiles.find(p => p.uniqueId === clientId);
            if (!clientProfile) {
                alert('Kunde inte hitta klienten.');
                return;
            }
            
            if (!clientProfile.pendingPrograms) clientProfile.pendingPrograms = [];
            clientProfile.pendingPrograms.push(programToSend);
            
            // Update profiles
            const clientIndex = profiles.findIndex(p => p.id === clientProfile.id);
            if (clientIndex !== -1) {
                profiles[clientIndex] = clientProfile;
                storage.save('profiles', profiles);
            }
            
            alert(`Program "${programToSend.name}" skickat till ${clientProfile.name}!`);
        }
        
        // Export profile functions
        window.showLoginModal = showLoginModal;
        window.closeLoginModal = closeLoginModal;
        window.showMenuModal = showMenuModal;
        window.closeMenuModal = closeMenuModal;
        window.closeProfileSetupModal = closeProfileSetupModal;
        window.closeClientFormModal = closeClientFormModal;
        window.closePTDashboardModal = closePTDashboardModal;
        window.createProfile = createProfile;
        window.saveNewProfile = saveNewProfile;
        window.switchProfile = switchProfile;
        window.switchToProfile = switchToProfile;
        window.logout = logout;
        window.openClientForm = openClientForm;
        window.nextClientFormStep = nextClientFormStep;
        window.prevClientFormStep = prevClientFormStep;
        window.updateClientFormData = updateClientFormData;
        window.selectClientFormOption = selectClientFormOption;
        window.submitClientForm = submitClientForm;
        window.openClientInbox = openClientInbox;
        window.openPTDashboard = openPTDashboard;
        window.addClientById = addClientById;
        window.removeClient = removeClient;
        window.viewClientForm = viewClientForm;
        window.sendProgramToClient = sendProgramToClient;
        
        // DOM elements
        const appContent = document.getElementById('app-content');
        const createModal = document.getElementById('createModal');
        const exerciseModal = document.getElementById('exerciseModal');
        const templateLibraryModal = document.getElementById('templateLibraryModal');
        const daySelector = document.getElementById('daySelector');
        
        // Initialize
        function init() {
            // Check if we have a current profile
            if (!currentProfile) {
                // Show login modal
                showLoginModal();
                return;
            }
            
            // Load profile-specific data
            loadProfileData();
            
            renderDaySelector();
            populateProgramTypes();
            updateModeButton();
            updateColorScheme();
            render();
            setupEventListeners();
            
            // Prevent zoom on double-tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
            
            // Prevent pinch zoom
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Prevent zoom on gesturestart (Safari)
            document.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            });
            
            // Re-render on resize for responsive layout
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (currentProgram !== null) {
                        render();
                    }
                }, 250);
            });
        }
        
        function togglePTMode() {
            const wasClientMode = !ptMode;
            ptMode = !ptMode;
            storage.save('ptMode', ptMode);
            
            // Visa popup f√∂rsta g√•ngen PT-l√§ge aktiveras
            if (ptMode && wasClientMode) {
                const hasSeenPTPopup = localStorage.getItem('hasSeenPTPopup_' + (currentProfile?.id || 'default'));
                if (!hasSeenPTPopup) {
                    localStorage.setItem('hasSeenPTPopup_' + (currentProfile?.id || 'default'), 'true');
                    alert('Nu kan du skapa, namnge och √§ndra tr√§ningspass!\n\nTryck igen f√∂r att √•terg√• till klient-l√§ge n√§r du bara vill f√∂lja och logga i programmet.');
                }
            }
            
            // Exit any edit modes when switching to client mode
            if (!ptMode) {
                editModes = {};
                programListEditMode = false;
            }
            updateModeButton();
            updateColorScheme();
            render();
        }
        
        function updateModeButton() {
            const label = document.getElementById('modeLabel');
            const track = document.getElementById('toggleTrack');
            const thumb = document.getElementById('toggleThumb');
            
            if (ptMode) {
                label.textContent = 'PT';
                label.style.color = 'var(--accent)';
                label.style.fontWeight = '600';
                track.style.background = 'var(--accent)';
                thumb.style.left = '18px';
                thumb.style.background = 'white';
            } else {
                label.textContent = 'Klient';
                label.style.color = 'var(--text-muted)';
                label.style.fontWeight = '500';
                track.style.background = 'var(--border)';
                thumb.style.left = '2px';
                thumb.style.background = 'var(--text-muted)';
            }
        }
        
        function updateColorScheme() {
            const root = document.documentElement;
            if (ptMode) {
                // PT-l√§ge: Lite ljusare/varmare toner
                root.style.setProperty('--primary', '#0f1530');
                root.style.setProperty('--secondary', '#1f2445');
                root.style.setProperty('--surface', '#191e38');
                root.style.setProperty('--surface-elevated', '#242942');
                root.style.setProperty('--border', '#353a52');
            } else {
                // Klient-l√§ge: Standard m√∂rkt tema
                root.style.setProperty('--primary', '#0a0e27');
                root.style.setProperty('--secondary', '#1a1f3a');
                root.style.setProperty('--surface', '#141829');
                root.style.setProperty('--surface-elevated', '#1e2438');
                root.style.setProperty('--border', '#2a3142');
            }
        }
        
        function populateProgramTypes() {
            const typeSelect = document.getElementById('programType');
            if (!typeSelect) return; // Element removed in new modal
            
            // Clear and populate program type dropdown
            typeSelect.innerHTML = '<option value="">V√§lj typ</option>';
            
            programTypes.forEach(type => {
                const opt1 = document.createElement('option');
                opt1.value = type;
                opt1.textContent = type;
                typeSelect.appendChild(opt1);
            });
        }
        
        function addNewProgramType() {
            const newType = prompt('Ange nytt programtyp:');
            if (newType && newType.trim() && !programTypes.includes(newType.trim())) {
                programTypes.push(newType.trim());
                storage.save('programTypes', programTypes);
                populateProgramTypes();
                document.getElementById('programType').value = newType.trim();
            }
        }
        
        function selectGender(gender) {
            document.getElementById('programGender').value = gender;
            // Update button styles
            document.querySelectorAll('.gender-btn').forEach(btn => {
                if (btn.dataset.value === gender) {
                    btn.style.background = 'var(--accent)';
                    btn.style.borderColor = 'var(--accent)';
                    btn.style.color = 'var(--primary)';
                } else {
                    btn.style.background = 'var(--surface)';
                    btn.style.borderColor = 'var(--border)';
                    btn.style.color = 'var(--text)';
                }
            });
            filterAndShowTemplates();
        }
        
        function selectLevel(level) {
            document.getElementById('programLevel').value = level;
            // Update button styles
            document.querySelectorAll('.level-btn').forEach(btn => {
                if (btn.dataset.value === level) {
                    btn.style.background = 'var(--accent)';
                    btn.style.borderColor = 'var(--accent)';
                    btn.style.color = 'var(--primary)';
                } else {
                    btn.style.background = 'var(--surface)';
                    btn.style.borderColor = 'var(--border)';
                    btn.style.color = 'var(--text)';
                }
            });
            filterAndShowTemplates();
        }
        
        function filterAndShowTemplates() {
            const gender = document.getElementById('programGender').value;
            const type = document.getElementById('programType').value;
            const level = document.getElementById('programLevel').value;
            const selectedDay = document.querySelector('.day-option.selected');
            const days = selectedDay ? parseInt(selectedDay.dataset.days) : null;
            
            // Filter BOTH user templates AND built-in templates
            const allTemplates = [...programTemplates, ...builtInTemplates];
            const filteredTemplates = allTemplates.filter(template => {
                if (gender && template.gender !== gender) return false;
                if (type && template.type !== type) return false;
                if (level && template.level !== level) return false;
                if (days && template.days.length !== days) return false;
                return true;
            });
            
            // Update the library button
            const libraryBtn = document.getElementById('openLibraryBtn');
            const countBadge = document.getElementById('libraryCountBadge');
            if (libraryBtn && countBadge) {
                countBadge.textContent = filteredTemplates.length;
                libraryBtn.disabled = filteredTemplates.length === 0;
            }
            
            // Store for use in modal
            window.currentFilteredTemplates = filteredTemplates;
            
            // Also update inline templates (user-created only)
            const userFiltered = programTemplates.filter(template => {
                if (gender && template.gender !== gender) return false;
                if (type && template.type !== type) return false;
                if (level && template.level !== level) return false;
                if (days && template.days.length !== days) return false;
                return true;
            });
            
            const container = document.getElementById('inlineTemplates');
            const content = document.getElementById('inlineTemplateContent');
            const countSpan = document.getElementById('templateCount');
            
            if (userFiltered.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            countSpan.textContent = `${userFiltered.length} mall${userFiltered.length > 1 ? 'ar' : ''}`;
            
            let html = '';
            userFiltered.forEach(template => {
                const originalIndex = programTemplates.indexOf(template);
                html += `
                    <button onclick="loadProgramTemplate(${originalIndex})" style="padding: 0.75rem; background: var(--surface); border: 1px solid var(--accent); border-radius: 6px; color: var(--text); cursor: pointer; text-align: left; font-size: 0.85rem; transition: all 0.2s; width: 100%;">
                        <div style="font-weight: 600;">${template.name}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                            ${template.days.length} dagar ‚Ä¢ ${template.weeksCount} veckor
                        </div>
                    </button>
                `;
            });
            
            content.innerHTML = html;
        }
        
        function openTemplateLibraryModal() {
            const filtered = window.currentFilteredTemplates || [];
            const gender = document.getElementById('programGender').value;
            const type = document.getElementById('programType').value;
            const level = document.getElementById('programLevel').value;
            const selectedDay = document.querySelector('.day-option.selected');
            const days = selectedDay ? parseInt(selectedDay.dataset.days) : null;
            
            // Update filter info
            let filterHtml = '<span style="color: var(--text-muted); margin-right: 0.5rem;">Filter:</span>';
            if (gender) filterHtml += `<span class="filter-tag">${gender}</span>`;
            if (type) filterHtml += `<span class="filter-tag">${type}</span>`;
            if (level) filterHtml += `<span class="filter-tag">${level}</span>`;
            if (days) filterHtml += `<span class="filter-tag">${days} dagar</span>`;
            if (!gender && !type && !level && !days) filterHtml += '<span style="color: var(--text-muted);">Inga filter (visar alla)</span>';
            document.getElementById('filterInfo').innerHTML = filterHtml;
            
            // Populate template grid
            const grid = document.getElementById('templateGrid');
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><p>üòï Inga mallar matchar dina filter</p></div>';
            } else {
                let html = '';
                filtered.forEach((template, index) => {
                    const dayNames = template.days.map(d => d.name).join(', ');
                    const exCount = template.days.reduce((sum, d) => sum + d.exercises.length, 0);
                    const isBuiltIn = template.isBuiltIn ? '<span style="font-size: 0.65rem; background: rgba(0,229,160,0.2); color: var(--accent); padding: 0.1rem 0.3rem; border-radius: 3px; margin-left: 0.5rem;">Inbyggd</span>' : '';
                    
                    html += `
                        <div class="template-card" onclick="selectTemplateFromLibrary(${index})">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600;">${template.name || (template.type + ' - ' + template.level)}</span>
                                ${isBuiltIn}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">
                                ${template.gender} ‚Ä¢ ${template.type} ‚Ä¢ ${template.level}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">
                                ${template.days.length} dagar ‚Ä¢ ${exCount} √∂vningar
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                                ${dayNames}
                            </div>
                        </div>
                    `;
                });
                grid.innerHTML = html;
            }
            
            document.getElementById('templateLibraryModal').classList.add('show');
        }
        
        function selectTemplateFromLibrary(index) {
            const template = window.currentFilteredTemplates[index];
            
            // Fill in the form
            document.getElementById('programName').value = template.name || (template.type + ' - ' + template.level);
            document.getElementById('weeksCount').value = template.weeksCount || 8;
            
            // Select gender
            if (template.gender) {
                selectGender(template.gender);
            }
            
            // Select type
            if (template.type) {
                document.getElementById('programType').value = template.type;
            }
            
            // Select level
            if (template.level) {
                selectLevel(template.level);
            }
            
            // Select day count
            const dayOptions = document.querySelectorAll('.day-option');
            dayOptions.forEach(opt => {
                opt.classList.remove('selected');
                if (parseInt(opt.dataset.days) === template.days.length) {
                    opt.classList.add('selected');
                }
            });
            
            // Store template to apply
            window.pendingTemplate = template;
            
            // Close library modal
            document.getElementById('templateLibraryModal').classList.remove('show');
            
            filterAndShowTemplates();
        }
        
        function renderDaySelector() {
            // Day selector removed - now using step-based modal
            const ds = document.getElementById('daySelector');
            if (!ds) return;
            ds.innerHTML = '';
            for (let i = 1; i <= 7; i++) {
                const option = document.createElement('div');
                option.className = 'day-option';
                option.textContent = `${i} dag${i > 1 ? 'ar' : ''}`;
                option.dataset.days = i;
                option.onclick = () => {
                    document.querySelectorAll('.day-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    filterAndShowTemplates();
                };
                ds.appendChild(option);
            }
        }
        
        function setupEventListeners() {
            // Close modals
            const closeModalBtn = document.getElementById('closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.onclick = () => {
                    createModal.classList.remove('show');
                };
            }
            
            // Funktion f√∂r att √•terst√§lla exercise modal till ursprungligt l√§ge
            function resetExerciseModal() {
                // √Öterst√§ll select mode
                exerciseSelectMode = false;
                selectedExercises = [];
                const selectedBar = document.getElementById('selectedExercisesBar');
                if (selectedBar) selectedBar.style.display = 'none';
                
                // √Öterst√§ll bibliotek
                const library = document.getElementById('exerciseLibrary');
                const toggleIcon = document.getElementById('libraryToggleIcon');
                const toggleText = document.getElementById('libraryToggleText');
                const toggleBtn = document.getElementById('toggleLibraryBtn');
                if (library) library.style.display = 'none';
                if (toggleIcon) toggleIcon.textContent = 'üìö';
                if (toggleText) toggleText.textContent = '√ñvningar';
                if (toggleBtn) {
                    toggleBtn.style.background = 'var(--accent)';
                    toggleBtn.style.color = 'var(--primary)';
                }
                
                // √Öterst√§ll steg till steg 1
                const step1 = document.getElementById('exerciseStep1');
                const step1b = document.getElementById('exerciseStep1b');
                const step2 = document.getElementById('exerciseStep2');
                const step3 = document.getElementById('exerciseStep3');
                if (step1) step1.style.display = 'block';
                if (step1b) step1b.style.display = 'none';
                if (step2) step2.style.display = 'none';
                if (step3) step3.style.display = 'none';
                
                // Visa modal-header igen
                const modalHeader = document.getElementById('exerciseModalHeader');
                if (modalHeader) modalHeader.style.display = 'flex';
                
                // Rensa inputs
                const exerciseName = document.getElementById('exerciseName');
                const exerciseReps = document.getElementById('exerciseReps');
                if (exerciseName) exerciseName.value = '';
                if (exerciseReps) exerciseReps.value = '';
                
                const step1NextBtn = document.getElementById('step1NextBtn');
                if (step1NextBtn) step1NextBtn.style.display = 'none';
                
                // √Öterst√§ll batch data
                window.pendingBatchExercises = null;
                selectedExerciseData = { name: '', muscleGroup: '', reps: '', sets: 3, isBatch: false, isManualEntry: false };
            }
            
            window.resetExerciseModal = resetExerciseModal;
            
            const closeExerciseModalBtn = document.getElementById('closeExerciseModalBtn');
            if (closeExerciseModalBtn) {
                closeExerciseModalBtn.onclick = () => {
                    resetExerciseModal();
                    exerciseModal.classList.remove('show');
                };
            }
            
            // Close template library modal
            const closeTemplateLibraryBtn = document.getElementById('closeTemplateLibraryBtn');
            if (closeTemplateLibraryBtn) {
                closeTemplateLibraryBtn.onclick = () => {
                    document.getElementById('templateLibraryModal').classList.remove('show');
                };
            }
            
            // Handle keyboard visibility - position input bar correctly (without affecting scroll)
            function updateInputBarPosition() {
                const inputBar = document.getElementById('freeInputBar');
                if (!inputBar) return;
                
                if (window.visualViewport) {
                    const viewport = window.visualViewport;
                    // Position the bar at the bottom of the visual viewport (above keyboard)
                    const bottom = window.innerHeight - (viewport.offsetTop + viewport.height);
                    inputBar.style.bottom = Math.max(0, bottom) + 'px';
                }
            }
            
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', updateInputBarPosition);
            }
            
            // Toggle exercise library
            const toggleLibraryBtn = document.getElementById('toggleLibraryBtn');
            if (toggleLibraryBtn) {
                toggleLibraryBtn.onclick = () => {
                const library = document.getElementById('exerciseLibrary');
                const toggleIcon = document.getElementById('libraryToggleIcon');
                const toggleText = document.getElementById('libraryToggleText');
                const toggleBtn = document.getElementById('toggleLibraryBtn');
                const selectedBar = document.getElementById('selectedExercisesBar');
                const proceedBtn = document.getElementById('proceedSelectedBtn');
                
                if (library.style.display === 'none') {
                    library.style.display = 'block';
                    toggleIcon.textContent = '‚úï';
                    toggleText.textContent = 'St√§ng';
                    toggleBtn.style.background = 'rgba(255, 107, 107, 0.2)';
                    toggleBtn.style.color = '#ff6b6b';
                    
                    // Aktivera select mode direkt
                    exerciseSelectMode = true;
                    selectedExercises = [];
                    selectedBar.style.display = 'block';
                    document.getElementById('selectedCount').textContent = 'V√§lj √∂vningar (max 10)';
                    if (proceedBtn) {
                        proceedBtn.disabled = true;
                        proceedBtn.style.opacity = '0.5';
                        proceedBtn.style.cursor = 'not-allowed';
                    }
                    
                    populateExerciseLibrary();
                    
                    // Smooth scroll to library
                    setTimeout(() => {
                        library.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                } else {
                    library.style.display = 'none';
                    toggleIcon.textContent = 'üìö';
                    toggleText.textContent = '√ñvningar';
                    toggleBtn.style.background = 'var(--accent)';
                    toggleBtn.style.color = 'var(--primary)';
                    
                    // Reset select mode
                    exerciseSelectMode = false;
                    selectedExercises = [];
                    selectedBar.style.display = 'none';
                }
            };
            }
            
            // Global event delegation for delete buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-exercise-btn')) {
                    const dayIndex = parseInt(e.target.dataset.day);
                    const exIndex = parseInt(e.target.dataset.exercise);
                    console.log('Delete button clicked:', dayIndex, exIndex);
                    deleteExercise(dayIndex, exIndex);
                }
            });
            
            // Old createProgramBtn handler removed - now using createProgramFromSteps()
        }
        
        function toggleAllWeeks() {
            addToAllWeeks = !addToAllWeeks;
            updateAllWeeksToggle();
        }
        
        function updateAllWeeksToggle() {
            const track = document.getElementById('allWeeksTrack');
            const thumb = document.getElementById('allWeeksThumb');
            const label = document.getElementById('allWeeksLabel');
            
            if (!track || !thumb || !label) return;
            
            if (addToAllWeeks) {
                track.style.background = 'var(--accent)';
                thumb.style.left = '18px';
                thumb.style.background = 'white';
                label.textContent = 'L√§gg till f√∂r alla veckor';
                label.style.color = 'var(--text)';
            } else {
                track.style.background = 'var(--border)';
                thumb.style.left = '2px';
                thumb.style.background = 'var(--text-muted)';
                label.textContent = 'Endast denna vecka (V' + currentWeek + ')';
                label.style.color = 'var(--text-muted)';
            }
        }
        
        function selectReps(value) {
            const input = document.getElementById('exerciseReps');
            input.value = value;
            
            // Update button styling
            document.querySelectorAll('.reps-btn').forEach(btn => {
                if (btn.dataset.reps === value) {
                    btn.style.background = 'var(--accent)';
                    btn.style.borderColor = 'var(--accent)';
                    btn.style.color = 'var(--primary)';
                } else {
                    btn.style.background = 'var(--surface-elevated)';
                    btn.style.borderColor = 'var(--border)';
                    btn.style.color = 'var(--text)';
                }
            });
        }
        
        // Make toggleAllWeeks globally accessible
        window.toggleAllWeeks = toggleAllWeeks;
        window.selectReps = selectReps;
        
        function render() {
            // Save scroll positions before rendering
            const scrollPositions = {};
            document.querySelectorAll('[data-scroll-container]').forEach(container => {
                const id = container.getAttribute('data-scroll-container');
                scrollPositions[id] = container.scrollLeft;
            });
            
            // Show/hide main header based on whether we're in a program or free training
            // TEMPORARILY HIDDEN
            const mainHeader = document.getElementById('mainHeader');
            if (mainHeader) {
                mainHeader.style.display = 'none'; // Hidden for now
            }
            
            if (freeTrainingMode) {
                renderFreeTraining();
            } else if (currentProgram === null) {
                renderProgramList();
            } else {
                renderWorkoutBuilder();
                
                // Restore scroll positions after rendering
                setTimeout(() => {
                    document.querySelectorAll('[data-scroll-container]').forEach(container => {
                        const id = container.getAttribute('data-scroll-container');
                        if (scrollPositions[id] !== undefined) {
                            container.scrollLeft = scrollPositions[id];
                        }
                    });
                }, 0);
            }
        }
        
        function renderProgramList() {
            const isClient = currentProfile?.type === 'client';
            const isPT = currentProfile?.type === 'pt';
            const programsTitle = isClient ? 'Dina Program' : 'Mina Program';
            const hasNewPrograms = isClient && (currentProfile?.pendingPrograms || []).length > 0;
            
            // Check if client can add programs (they can't)
            const canCreateProgram = !isClient && ptMode;
            const canAccessFreeTraining = !isClient;
            
            if (programs.length === 0) {
                let html = `
                    <div class="workout-builder">
                        <div class="builder-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="font-size: 1.15rem; margin: 0;">${programsTitle}</h2>
                            ${isClient && hasNewPrograms ? `
                                <button onclick="window.openClientInbox()" style="position: relative; background: none; border: none; cursor: pointer; padding: 0.5rem;">
                                    <span style="font-size: 1.3rem;">üì•</span>
                                    <span style="position: absolute; top: 0; right: 0; background: var(--accent); color: var(--primary); width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600;">${(currentProfile?.pendingPrograms || []).length}</span>
                                </button>
                            ` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">üèãÔ∏è</div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--text);">${canCreateProgram ? (isPT ? 'Skapa ditt f√∂rsta tr√§ningsschema' : 'L√§gg till ditt f√∂rsta tr√§ningsschema') : 'Inga program tillg√§ngliga'}</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">${canCreateProgram ? (isPT ? 'B√∂rja planera klienternas tr√§ning genom att skapa ett anpassat schema' : 'B√∂rja planera din tr√§ning genom att skapa ett anpassat schema') : (isClient ? 'V√§ntar p√• program fr√•n din PT' : 'Aktivera PT-l√§ge och bygg ditt egna schema')}</p>
                            ${canCreateProgram ? `<button class="btn btn-primary" onclick="openCreateModal()" style="padding: 0.75rem 1.5rem;">
                                + ${isPT ? 'Skapa tr√§ningsschema' : 'L√§gg till tr√§ningsschema'}
                            </button>` : ''}
                            ${isClient && !currentProfile?.formCompleted ? `
                                <button onclick="window.openClientForm()" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                                    üìù Fyll i formul√§r
                                </button>
                                <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.75rem;">Hj√§lp din PT att skapa ditt program</p>
                            ` : ''}
                        </div>
                `;
                
                // Only show free training for non-clients
                if (canAccessFreeTraining) {
                    html += `
                        <!-- Divider and Free Training -->
                        <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                            <div style="flex: 1; height: 1px; background: var(--border);"></div>
                            <span style="color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;">Eller</span>
                            <div style="flex: 1; height: 1px; background: var(--border);"></div>
                        </div>
                        
                        ${currentProfile && currentProfile.type === 'standard' ? `
                        <!-- √ñverraska mig-knapp -->
                        <div onclick="window.openSurpriseModal()" style="background: linear-gradient(135deg, rgba(0, 229, 160, 0.15) 0%, rgba(0, 180, 130, 0.1) 100%); border: 1px solid rgba(0, 229, 160, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='rgba(0, 229, 160, 0.3)'">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="font-size: 1.5rem;">üé≤</div>
                                <div>
                                    <div style="font-weight: 600; color: var(--accent);">√ñverraska mig!</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Om du inte vet vad du ska tr√§na</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div onclick="window.startFreeTraining()" style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; cursor: pointer; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: rgba(0, 229, 160, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <span style="font-size: 1.2rem;">üìù</span>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text);">Logga tr√§ningspass</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Logga utan schema</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
                appContent.innerHTML = html;
                return;
            }
            
            // Has programs - render program list with menu
            const canEditPrograms = !isClient && ptMode;
            
            let html = `
                <div class="workout-builder">
                    <div class="builder-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="font-size: 1.15rem; margin: 0;">${isClient ? 'Dina Program' : 'Mina Program'}</h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${isClient && hasNewPrograms ? `
                                <button onclick="window.openClientInbox()" style="position: relative; background: none; border: none; cursor: pointer; padding: 0.5rem;">
                                    <span style="font-size: 1.3rem;">üì•</span>
                                    <span style="position: absolute; top: 0; right: 0; background: var(--accent); color: var(--primary); width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600;">${(currentProfile?.pendingPrograms || []).length}</span>
                                </button>
                            ` : ''}
                            ${canCreateProgram ? `<button class="btn btn-primary" onclick="openCreateModal()" style="padding: 0.4rem 0.75rem; font-size: 0.85rem;">+ Nytt program</button>` : ''}
                            ${canEditPrograms ? `<button class="btn ${programListEditMode ? 'btn-primary' : 'btn-secondary'}" onclick="toggleProgramListEditMode()" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;">${programListEditMode ? '‚úì' : '‚úèÔ∏è'}</button>` : ''}
                        </div>
                    </div>
                    
                    <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">V√§lj program</div>
            `;
                
                programs.forEach((program, index) => {
                    // Find last activity date
                    let lastActivityDate = program.lastActivity ? new Date(program.lastActivity) : null;
                    let daysSinceActivity = null;
                    
                    if (lastActivityDate) {
                        const now = new Date();
                        const diffTime = now - lastActivityDate;
                        daysSinceActivity = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    }
                    
                    // Determine status display
                    let statusText, statusBg, statusColor, showLabel;
                    if (daysSinceActivity === null) {
                        statusText = 'Ny';
                        statusBg = 'rgba(100, 100, 255, 0.2)';
                        statusColor = '#8888ff';
                        showLabel = false;
                    } else if (daysSinceActivity === 0) {
                        statusText = 'IDAG';
                        statusBg = 'rgba(0, 229, 160, 0.2)';
                        statusColor = 'var(--accent)';
                        showLabel = true;
                    } else if (daysSinceActivity === 1) {
                        statusText = '1 DAG';
                        statusBg = 'rgba(0, 229, 160, 0.15)';
                        statusColor = 'var(--accent)';
                        showLabel = true;
                    } else if (daysSinceActivity <= 7) {
                        statusText = `${daysSinceActivity} DAGAR`;
                        statusBg = daysSinceActivity <= 3 ? 'rgba(0, 229, 160, 0.15)' : (daysSinceActivity <= 5 ? 'rgba(255, 200, 0, 0.15)' : 'rgba(255, 150, 0, 0.15)');
                        statusColor = daysSinceActivity <= 3 ? 'var(--accent)' : (daysSinceActivity <= 5 ? '#ffcc00' : '#ff9900');
                        showLabel = true;
                    } else {
                        statusText = '7+ DAGAR';
                        statusBg = 'rgba(255, 80, 80, 0.15)';
                        statusColor = '#ff6666';
                        showLabel = true;
                    }
                    
                    // Get program properties
                    const levelText = program.level || 'Alla niv√•er';
                    const daysPerWeek = program.days.length;
                    const weeksCount = program.weeksCount;
                    
                    // CSS triangle play icon
                    const playIcon = `<div style="width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-left: 12px solid var(--accent); margin-left: 2px;"></div>`;
                    
                    html += `
                        <div class="program-item" data-program-index="${index}" style="position: relative; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 0.75rem; overflow: visible; ${programListEditMode ? 'cursor: grab;' : 'cursor: pointer;'} transition: all 0.2s;" ${programListEditMode ? '' : `onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'"`} ${programListEditMode ? `draggable="true" ondragstart="window.handleProgramDragStart(event, ${index})" ondragend="window.handleProgramDragEnd(event)" ondragover="window.handleProgramDragOver(event)" ondragenter="window.handleProgramDragEnter(event, ${index})" ondragleave="window.handleProgramDragLeave(event)" ondrop="window.handleProgramDrop(event, ${index})"` : ''}>
                            ${programListEditMode ? `<button onclick="event.stopPropagation(); deleteProgram(${index})" style="position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: var(--danger); border: 2px solid var(--primary); color: white; font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">√ó</button>` : ''}
                            <div style="padding: 1.25rem; cursor: ${programListEditMode ? 'grab' : 'pointer'};" onclick="${programListEditMode ? '' : `openProgram(${index})`}">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0;">
                                        ${programListEditMode ? `<span style="color: var(--text-muted); font-size: 1.2rem; cursor: grab;">‚ò∞</span>` : playIcon}
                                        ${programListEditMode ? `
                                            <input type="text" value="${program.name}" 
                                                   onchange="renameProgramInline(${index}, this.value)" 
                                                   onclick="event.stopPropagation()"
                                                   ontouchstart="event.stopPropagation()"
                                                   style="font-size: 1.2rem; font-weight: 600; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; padding: 0.25rem 0.5rem; color: var(--text); flex: 1; min-width: 0;">
                                        ` : `
                                            <span style="font-weight: 700; font-size: 1.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text);">${program.name}</span>
                                        `}
                                    </div>
                                    ${!programListEditMode ? `
                                        <div style="display: flex; align-items: center; gap: 0.4rem; flex-shrink: 0;">
                                            ${showLabel ? `<span style="font-size: 0.6rem; color: var(--text-muted); opacity: 0.6;">Genomf√∂rt</span>` : ''}
                                            <div style="background: ${statusBg}; color: ${statusColor}; padding: 0.3rem 0.5rem; border-radius: 5px; font-size: 0.65rem; font-weight: 700; text-align: center;">
                                                ${statusText}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                ${!programListEditMode ? `
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <span style="background: rgba(0, 229, 160, 0.12); color: var(--accent); padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                            ${daysPerWeek} dagar/vecka
                                        </span>
                                        <span style="background: rgba(100, 150, 255, 0.12); color: #88aaff; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                            ${weeksCount} veckor
                                        </span>
                                        <span style="background: rgba(255, 180, 100, 0.12); color: #ffbb66; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                            ${levelText}
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                // Divider and Free Training section - only for non-clients
                if (canAccessFreeTraining) {
                    html += `
                        <div style="display: flex; align-items: center; gap: 1rem; margin: 1.5rem 0 1rem;">
                            <div style="flex: 1; height: 1px; background: var(--border);"></div>
                            <span style="color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;">Eller</span>
                            <div style="flex: 1; height: 1px; background: var(--border);"></div>
                        </div>
                        
                        ${currentProfile && currentProfile.type === 'standard' ? `
                        <!-- √ñverraska mig-knapp -->
                        <div onclick="window.openSurpriseModal()" style="background: linear-gradient(135deg, rgba(0, 229, 160, 0.15) 0%, rgba(0, 180, 130, 0.1) 100%); border: 1px solid rgba(0, 229, 160, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='rgba(0, 229, 160, 0.3)'">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="font-size: 1.5rem;">üé≤</div>
                                <div>
                                    <div style="font-weight: 600; color: var(--accent);">√ñverraska mig!</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Om du inte vet vad du ska tr√§na</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div onclick="window.startFreeTraining()" style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; cursor: pointer; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: rgba(0, 229, 160, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <span style="font-size: 1.2rem;">üìù</span>
                                </div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1.1rem; color: var(--text);">Logga tr√§ningspass</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Logga utan program</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
                appContent.innerHTML = html;
        }
        
        function renderWorkoutBuilder() {
            const program = programs[currentProgram];
            const hasEditMode = Object.values(editModes).some(v => v);
            
            // Responsiv breddber√§kning
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 768;
            const isVerySmall = screenWidth <= 400;
            
            // P√• mobil: visa antingen daglista eller √∂vningslista
            if (isMobile) {
                if (currentMobileDay === null) {
                    // MOBILE: Visa lista med dagar
                    renderMobileDayList(program);
                } else {
                    // MOBILE: Visa √∂vningar f√∂r vald dag
                    renderMobileExerciseView(program, currentMobileDay);
                }
                return;
            }
            
            // DESKTOP: Original layout med alla dagar synliga
            renderDesktopView(program, hasEditMode);
        }
        
        function renderMobileDayList(program) {
            const hasEditMode = Object.values(editModes).some(v => v);
            const anyDayInEditMode = Object.values(editModes).some(v => v);
            const canSaveAsTemplate = currentProfile?.type !== 'client';
            const canEdit = currentProfile?.type !== 'client' && ptMode;
            
            let html = `
                <div class="workout-builder">
                    <div class="builder-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="closeProgram()" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;">‚Üê</button>
                            <h2 style="font-size: 1.15rem; margin: 0;">${program.name}</h2>
                        </div>
                        <div style="display: flex; gap: 0.35rem; align-items: center;">
                            ${canSaveAsTemplate ? `<button onclick="saveProgramAsTemplate()" style="padding: 0.4rem 0.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text-muted); font-size: 0.9rem;" title="Spara som mall">üíæ</button>` : ''}
                            ${canEdit ? `<button class="btn ${anyDayInEditMode ? 'btn-primary' : 'btn-secondary'}" onclick="window.toggleAllEditMode()" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;" title="Redigera">${anyDayInEditMode ? '‚úì' : '‚úèÔ∏è'}</button>` : ''}
                        </div>
                    </div>
                    
                    <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">V√§lj tr√§ningspass</div>
            `;
            
            program.days.forEach((day, dayIndex) => {
                const exerciseCount = day.exercises.length;
                const isEditMode = editModes[dayIndex];
                
                // Samla unika muskelgrupper f√∂r denna dag
                const muscleGroups = [...new Set(day.exercises.map(ex => ex.muscleGroup).filter(mg => mg))];
                
                // CSS triangle play icon f√∂r dagkort
                const dayPlayIcon = `<div style="width: 0; height: 0; border-top: 7px solid transparent; border-bottom: 7px solid transparent; border-left: 10px solid var(--accent);"></div>`;
                
                html += `
                    <div class="day-item" data-day-index="${dayIndex}" style="position: relative; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 0.75rem; overflow: visible; transition: all 0.2s; cursor: pointer;" ${isEditMode ? `ondragover="window.handleDayDragOver(event)" ondragenter="window.handleDayDragEnter(event, ${dayIndex})" ondragleave="window.handleDayDragLeave(event)" ondrop="window.handleDayDrop(event, ${dayIndex})"` : `onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'"`}>
                        ${isEditMode ? `<button onclick="event.stopPropagation(); window.deleteDay(${dayIndex})" style="position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: var(--danger); border: 2px solid var(--primary); color: white; font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">√ó</button>` : ''}
                        <div style="padding: 1rem; cursor: pointer;" onclick="${isEditMode ? '' : `window.openMobileDay(${dayIndex})`}">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: ${muscleGroups.length > 0 && !isEditMode ? '0.75rem' : '0'};">
                                ${isEditMode ? `<span draggable="true" ondragstart="window.handleDayDragStart(event, ${dayIndex})" ondragend="window.handleDayDragEnd(event)" ontouchstart="window.handleDayTouchStart(event, ${dayIndex})" ontouchmove="window.handleDayTouchMove(event)" ontouchend="window.handleDayTouchEnd(event)" style="color: var(--text-muted); font-size: 1rem; cursor: grab; padding: 0.25rem; touch-action: none;">‚ò∞</span>` : dayPlayIcon}
                                ${isEditMode ? `
                                    <input type="text" value="${day.name}" onchange="window.renameDayInline(${dayIndex}, this.value)" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" style="font-size: 1rem; font-weight: 600; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; padding: 0.25rem 0.5rem; color: var(--text); text-transform: uppercase; width: 150px; touch-action: auto;">
                                ` : `
                                    <div>
                                        <div style="font-weight: 600; font-size: 1.1rem;">${day.name.toUpperCase()}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${exerciseCount} √∂vningar</div>
                                    </div>
                                `}
                            </div>
                            ${!isEditMode && muscleGroups.length > 0 ? `
                                <div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">
                                    ${muscleGroups.map(mg => {
                                        const color = getMuscleColor(mg);
                                        return `<span style="background: ${color}20; color: ${color}; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.65rem; font-weight: 500;">${mg}</span>`;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            // Check if user can add day (use variables from top of function)
            const canAddDay = canEdit;
            
            // L√§gg till dag-knapp - tydligt separerad med annan stil
            if (canSaveAsTemplate || canAddDay) {
                html += `<div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">`;
                
                // Spara som mall knapp
                if (canSaveAsTemplate) {
                    html += `
                        <div onclick="window.saveProgramAsTemplate()" style="padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: var(--text-muted); margin-bottom: 0.75rem; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)';" onmouseleave="this.style.borderColor='var(--border)'; this.style.color='var(--text-muted)';">
                            <span style="font-size: 1rem;">üíæ</span>
                            <span style="font-size: 0.85rem;">Spara som mall</span>
                        </div>
                    `;
                }
                
                // Nytt tr√§ningspass knapp (endast f√∂r de som kan l√§gga till)
                if (canAddDay) {
                    html += `
                        <div onclick="window.addDay()" style="padding: 1rem; background: rgba(0, 229, 160, 0.05); border: 1px solid rgba(0, 229, 160, 0.2); border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: var(--accent); transition: all 0.2s;" onmouseenter="this.style.background='rgba(0, 229, 160, 0.1)'; this.style.borderColor='var(--accent)';" onmouseleave="this.style.background='rgba(0, 229, 160, 0.05)'; this.style.borderColor='rgba(0, 229, 160, 0.2)';">
                            <span style="font-size: 1.2rem;">+</span>
                            <span style="font-size: 0.9rem; font-weight: 500;">Nytt tr√§ningspass</span>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            html += `</div>`;
            appContent.innerHTML = html;
        }
        
        function renderMobileExerciseView(program, dayIndex) {
            const day = program.days[dayIndex];
            const hasEditMode = Object.values(editModes).some(v => v);
            const isEditMode = editModes[dayIndex];
            const canSaveAsTemplate = currentProfile?.type !== 'client';
            const canEdit = currentProfile?.type !== 'client' && ptMode;
            const isMobile = window.innerWidth <= 768;
            
            // ======= WORKOUT MODE (Helsk√§rm f√∂r loggning) =======
            if (workoutModeActive && isMobile && activeSet) {
                renderWorkoutMode(dayIndex);
                return;
            }
            
            // Calculate visible weeks for bottom navigation
            const totalWeeks = program.weeksCount;
            const startWeek = Math.max(1, currentWeek - 1);
            const endWeek = Math.min(totalWeeks, startWeek + 3);
            const adjustedStart = Math.max(1, endWeek - 3);
            const showLeftArrow = adjustedStart > 1;
            const showRightArrow = endWeek < totalWeeks;
            
            let html = `
                <div class="workout-builder">
                    <div class="builder-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="window.closeMobileDay()" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;">‚Üê</button>
                            ${isEditMode && canEdit ? `
                                <input type="text" value="${day.name}" onchange="window.renameDayInline(${dayIndex}, this.value)" style="font-size: 1rem; font-weight: 600; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; padding: 0.25rem 0.5rem; color: var(--text); text-transform: uppercase; max-width: 120px;">
                            ` : `
                                <h2 style="font-size: 1.1rem; margin: 0;">${day.name.toUpperCase()}</h2>
                            `}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            ${canSaveAsTemplate ? `<button onclick="window.saveProgramAsTemplate()" style="padding: 0.4rem 0.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text-muted); font-size: 0.9rem;" title="Spara som mall">üíæ</button>` : ''}
                            ${canEdit ? `<button class="btn ${isEditMode ? 'btn-primary' : 'btn-secondary'}" onclick="window.toggleEditMode(${dayIndex})" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;">${isEditMode ? '‚úì' : '‚úèÔ∏è'}</button>` : ''}
                        </div>
                    </div>
            `;
            
            if (day.exercises.length === 0) {
                html += `
                    <div class="empty-exercises" style="cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onclick="window.openExerciseModal(${dayIndex})">
                        <span style="color: var(--accent); font-size: 1.2rem;">+</span>
                        <span>L√§gg till √∂vning</span>
                    </div>
                `;
            } else {
                // Header row
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 0.4rem 0.75rem; margin-bottom: 0.35rem; color: var(--text-muted); font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        <span>√ñvning</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <span style="width: 45px; text-align: center;">Reps</span>
                            <span style="width: 30px; text-align: center;">Set</span>
                        </div>
                    </div>
                `;
                
                // Filter exercises for current week (skip week-specific exercises from other weeks, and exercises added after this week)
                const visibleExercises = day.exercises.filter(ex => {
                    const showForWeek = !ex.weekOnly || ex.weekOnly === currentWeek;
                    const wasAddedBeforeOrAtWeek = !ex.addedAtWeek || ex.addedAtWeek <= currentWeek;
                    return showForWeek && wasAddedBeforeOrAtWeek;
                });
                
                visibleExercises.forEach((exercise, visibleIndex) => {
                    // Find original index for logs
                    const exIndex = day.exercises.indexOf(exercise);
                    const isExpanded = activeExercises[`${dayIndex}-${exIndex}`];
                    const exerciseSets = exercise.sets;
                    
                    // Check if all sets are completed for this exercise
                    const weekData = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
                    const loggedSets = weekData.sets || {};
                    let completedSetsCount = 0;
                    for (let s = 0; s < exerciseSets; s++) {
                        if (loggedSets[s]) completedSetsCount++;
                    }
                    const isComplete = completedSetsCount >= exerciseSets;
                    
                    // Styling based on completion - subtle for completed exercises
                    const cardBg = isComplete ? 'var(--surface)' : 'var(--surface)';
                    const cardBorder = isComplete ? 'rgba(0, 229, 160, 0.3)' : 'var(--border)';
                    const nameColor = isComplete ? 'var(--text-muted)' : 'var(--text)';
                    const checkMark = isComplete ? '‚úì ' : '';
                    
                    // I klientl√§ge: bara visa delete-knapp, ingen drag/redigering
                    const showDragHandle = isEditMode && ptMode;
                    const showEditableFields = isEditMode && ptMode;
                    
                    html += `
                        <div class="exercise-item" data-day="${dayIndex}" data-exercise="${exIndex}" style="position: relative; background: ${cardBg}; border: 1px solid ${cardBorder}; border-radius: 8px; margin-bottom: 0.5rem; overflow: visible; transition: all 0.2s;" ${showDragHandle ? `ondragover="window.handleDragOver(event)" ondragenter="window.handleDragEnter(event, ${dayIndex}, ${exIndex})" ondragleave="window.handleDragLeave(event)" ondrop="window.handleDrop(event, ${dayIndex}, ${exIndex})"` : ''}>
                            ${isEditMode ? `<button onclick="event.stopPropagation(); window.deleteExercise(${dayIndex}, ${exIndex})" style="position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: var(--danger); border: 2px solid var(--primary); color: white; font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">√ó</button>` : ''}
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; ${isComplete ? 'opacity: 0.7;' : ''}" ${!isMobile && !isEditMode ? `onclick="window.toggleExerciseActive(${dayIndex}, ${exIndex})" style="cursor: pointer;"` : ''}>
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0;">
                                    ${showDragHandle ? `<span draggable="true" ondragstart="window.handleDragStart(event, ${dayIndex}, ${exIndex})" ondragend="window.handleDragEnd(event)" ontouchstart="window.handleTouchStart(event, ${dayIndex}, ${exIndex})" ontouchmove="window.handleTouchMove(event)" ontouchend="window.handleTouchEnd(event)" onclick="event.stopPropagation()" style="color: var(--text-muted); font-size: 0.9rem; cursor: grab; padding: 0.25rem; touch-action: none;">‚ò∞</span>` : `<span style="color: ${isComplete ? 'var(--accent)' : 'var(--text-muted)'}; font-size: 0.75rem;">${isComplete ? '‚úì' : '‚óã'}</span>`}
                                    <div style="display: flex; flex-direction: column; gap: 0.1rem; min-width: 0;">
                                        <span style="font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: ${nameColor};">${exercise.name}</span>
                                        <span style="font-size: 0.7rem; color: ${getMuscleColor(exercise.muscleGroup)};">${exercise.muscleGroup}</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
                                    ${showEditableFields ? `
                                        <input type="text" value="${exercise.reps}" onchange="window.updateExerciseReps(${dayIndex}, ${exIndex}, this.value)" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" onmousedown="event.stopPropagation()" draggable="false" style="font-size: 0.8rem; color: var(--accent); width: 45px; text-align: center; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; padding: 0.2rem; touch-action: auto; cursor: text;">
                                        <input type="number" value="${exercise.sets}" min="1" max="10" onchange="window.updateExerciseSets(${dayIndex}, ${exIndex}, this.value)" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" onmousedown="event.stopPropagation()" draggable="false" style="font-size: 0.8rem; color: var(--accent); width: 35px; text-align: center; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; padding: 0.2rem; touch-action: auto; cursor: text;">
                                    ` : `
                                        <span style="font-size: 0.85rem; color: var(--accent); width: 45px; text-align: center;">${exercise.reps}</span>
                                        <span style="font-size: 0.85rem; color: ${isComplete ? 'var(--accent)' : 'var(--text-muted)'}; width: 30px; text-align: center;">${completedSetsCount}/${exercise.sets}</span>
                                    `}
                                </div>
                            </div>
                    `;
                    
                    // Expanded content (set logging) - ENDAST f√∂r desktop
                    if (isExpanded && !isMobile) {
                        const weekData = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
                        const sets = weekData.sets || {};
                        
                        // Find all logged set indices (including extra sets beyond target)
                        const loggedSetIndices = Object.keys(sets).filter(k => sets[k]).map(Number).sort((a, b) => a - b);
                        const maxLoggedIndex = loggedSetIndices.length > 0 ? Math.max(...loggedSetIndices) : -1;
                        
                        // Total sets to show = max of target sets or highest logged index + 1
                        const totalSetsToShow = Math.max(exerciseSets, maxLoggedIndex + 1);
                        
                        // Find the first empty set index (within target)
                        let firstEmptySetIndex = 0;
                        for (let i = 0; i < exerciseSets; i++) {
                            if (!sets[i]) {
                                firstEmptySetIndex = i;
                                break;
                            }
                            firstEmptySetIndex = i + 1;
                        }
                        
                        // Check if we have any filled sets
                        const hasFilledSets = loggedSetIndices.length > 0;
                        const allTargetSetsComplete = firstEmptySetIndex >= exerciseSets;
                        
                        html += `
                            <div style="padding: 0.75rem; border-top: 1px solid var(--border); background: var(--surface-elevated);">
                        `;
                        
                        // Show filled sets in a row
                        if (hasFilledSets) {
                            // Calculate sizes based on number of sets to display
                            const numSets = totalSetsToShow;
                            const isCompact = numSets > 4;
                            const isVeryCompact = numSets > 6;
                            
                            // Dynamic sizing based on set count
                            let boxPadding, labelSize, valueSize, gap;
                            if (isVeryCompact) {
                                boxPadding = '0.3rem 0.25rem';
                                labelSize = '0.45rem';
                                valueSize = '0.7rem';
                                gap = '0.2rem';
                            } else if (isCompact) {
                                boxPadding = '0.4rem 0.35rem';
                                labelSize = '0.5rem';
                                valueSize = '0.8rem';
                                gap = '0.25rem';
                            } else if (allTargetSetsComplete) {
                                boxPadding = '0.6rem 0.5rem';
                                labelSize = '0.6rem';
                                valueSize = '1rem';
                                gap = '0.35rem';
                            } else {
                                boxPadding = '0.4rem 0.5rem';
                                labelSize = '0.55rem';
                                valueSize = '0.85rem';
                                gap = '0.35rem';
                            }
                            
                            // Vertical layout for logged sets
                            html += `<div style="display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 0.5rem;">`;
                            
                            // Show all logged sets (including extra ones beyond target)
                            const maxSetToShow = Math.max(exerciseSets - 1, maxLoggedIndex);
                            for (let s = 0; s <= maxSetToShow; s++) {
                                const set = sets[s];
                                const setKey = `${dayIndex}-${exIndex}-${s}`;
                                const isActiveSet = activeSet === setKey;
                                const isExtraSet = s >= exerciseSets; // Beyond target
                                
                                // Only show if: it's a target set, OR it's an extra set that has been logged
                                if (!set && isExtraSet) continue;
                                
                                if (set && !isActiveSet) {
                                    // Logged set - clean styling (completed)
                                    const labelText = isExtraSet ? `+${s - exerciseSets + 1}` : `Set ${s + 1}`;
                                    
                                    html += `
                                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;" onclick="event.stopPropagation(); window.activateSet(${dayIndex}, ${exIndex}, ${s})">
                                            <span style="font-size: 0.7rem; color: var(--text-muted); min-width: 35px;">${labelText}</span>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text);">${set.weight}kg √ó ${set.reps}</span>
                                        </div>
                                    `;
                                } else if (set && isActiveSet) {
                                    // Editing existing set - compact in row
                                    html += `
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.2rem; padding: 0.4rem; background: rgba(0, 229, 160, 0.25); border: 2px solid var(--accent); border-radius: 6px; min-width: 75px;">
                                            <span style="font-size: 0.55rem; color: var(--accent); font-weight: 600;">${isExtraSet ? '+' + (s - exerciseSets + 1) : 'SET ' + (s + 1)}</span>
                                            <div style="display: flex; gap: 0.2rem; align-items: center;">
                                                <input type="number" inputmode="decimal" id="weight-${dayIndex}-${exIndex}-${s}" value="${set.weight}" step="0.5" min="0" max="999" onclick="event.stopPropagation()" onkeypress="if(event.key==='Enter'){document.getElementById('reps-${dayIndex}-${exIndex}-${s}').focus()}" style="width: 40px; padding: 0.3rem; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; color: var(--text); text-align: center; font-size: 0.8rem; font-weight: 600;">
                                                <span style="color: var(--text-muted);">√ó</span>
                                                <input type="number" inputmode="numeric" id="reps-${dayIndex}-${exIndex}-${s}" value="${set.reps}" min="1" max="999" onclick="event.stopPropagation()" onkeypress="if(event.key==='Enter'){window.logSetAtPosition(${dayIndex}, ${exIndex}, ${s})}" style="width: 40px; padding: 0.3rem; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; color: var(--text); text-align: center; font-size: 0.8rem; font-weight: 600;">
                                            </div>
                                            <div style="display: flex; gap: 0.2rem; margin-top: 0.1rem;">
                                                <button onclick="event.stopPropagation(); window.logSetAtPosition(${dayIndex}, ${exIndex}, ${s})" style="padding: 0.2rem 0.4rem; background: var(--accent); border: none; border-radius: 3px; color: var(--primary); font-size: 0.6rem; font-weight: 600; cursor: pointer;">OK</button>
                                                <button onclick="event.stopPropagation(); window.clearSet(${dayIndex}, ${exIndex}, ${currentWeek}, ${s})" style="padding: 0.2rem 0.3rem; background: rgba(255,80,80,0.8); border: none; border-radius: 3px; color: white; font-size: 0.6rem; cursor: pointer;">√ó</button>
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                            html += `</div>`;
                        }
                        
                        // Check if there's an extra set being added
                        const activeSetParts = activeSet ? activeSet.split('-').map(Number) : null;
                        const isAddingExtraSet = activeSetParts && 
                            activeSetParts[0] === dayIndex && 
                            activeSetParts[1] === exIndex && 
                            activeSetParts[2] >= exerciseSets &&
                            !sets[activeSetParts[2]];
                        
                        // Show the next empty set input (big and centered) - for target sets OR extra set
                        const nextEmptySet = firstEmptySetIndex < exerciseSets ? firstEmptySetIndex : null;
                        const isNextSetActive = nextEmptySet !== null && activeSet === `${dayIndex}-${exIndex}-${nextEmptySet}`;
                        
                        // Determine which set to show input for
                        const showInputForSet = isAddingExtraSet ? activeSetParts[2] : nextEmptySet;
                        const isInputActive = isAddingExtraSet || isNextSetActive;
                        const setLabel = isAddingExtraSet ? 'EXTRA SET' : `SET ${showInputForSet + 1} av ${exerciseSets}`;
                        
                        if (showInputForSet !== null && !sets[showInputForSet]) {
                            if (isInputActive) {
                                if (inputStep === 'weight') {
                                    // Step 1: Weight input
                                    html += `
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(0, 229, 160, 0.08); border: 2px ${isAddingExtraSet ? 'dashed' : 'solid'} var(--accent); border-radius: 12px;">
                                            <span style="font-size: 0.8rem;"><span style="color: var(--text-muted);">M√•l:</span> <span style="color: var(--accent); font-weight: 600;">${exercise.reps} reps</span> </span>
                                            <input type="number" inputmode="decimal" id="weight-${dayIndex}-${exIndex}-${showInputForSet}" placeholder="0 kg" value="" step="0.5" min="0" max="999" onclick="event.stopPropagation()" onkeypress="if(event.key==='Enter'){window.confirmWeight(${dayIndex}, ${exIndex}, ${showInputForSet})}" style="width: 100px; padding: 0.75rem; background: var(--surface); border: 2px solid var(--accent); border-radius: 8px; color: var(--text); text-align: center; font-size: 1.75rem; font-weight: 700;">
                                            <button onclick="event.stopPropagation(); window.confirmWeight(${dayIndex}, ${exIndex}, ${showInputForSet})" style="width: 100px; padding: 0.5rem; background: var(--accent); border: none; border-radius: 6px; color: var(--primary); font-size: 0.9rem; font-weight: 600; cursor: pointer;">Logga</button>
                                            <span style="font-size: 0.7rem; color: var(--text-muted);">${setLabel}</span>
                                        </div>
                                    `;
                                } else if (inputStep === 'reps') {
                                    // Step 2: Reps input with weight shown
                                    html += `
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(0, 229, 160, 0.08); border: 2px ${isAddingExtraSet ? 'dashed' : 'solid'} var(--accent); border-radius: 12px;">
                                            <span style="font-size: 0.8rem;"><span style="color: var(--text-muted);">M√•l:</span> <span style="color: var(--accent); font-weight: 600;">${exercise.reps} reps</span> </span>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="number" inputmode="decimal" id="weight-${dayIndex}-${exIndex}-${showInputForSet}" value="" step="0.5" min="0" max="999" onclick="event.stopPropagation()" style="width: 65px; padding: 0.5rem; background: var(--surface-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--accent); text-align: center; font-size: 1.1rem; font-weight: 600;">
                                                <span style="color: var(--text-muted); font-size: 1.25rem;">√ó</span>
                                                <input type="number" inputmode="numeric" id="reps-${dayIndex}-${exIndex}-${showInputForSet}" placeholder="reps" value="" min="1" max="999" onclick="event.stopPropagation()" onkeypress="if(event.key==='Enter'){window.logSetAtPosition(${dayIndex}, ${exIndex}, ${showInputForSet})}" style="width: 65px; padding: 0.75rem; background: var(--surface); border: 2px solid var(--accent); border-radius: 8px; color: var(--text); text-align: center; font-size: 1.75rem; font-weight: 700;">
                                            </div>
                                            <button onclick="event.stopPropagation(); window.logSetAtPosition(${dayIndex}, ${exIndex}, ${showInputForSet})" style="width: 100px; padding: 0.5rem; background: var(--accent); border: none; border-radius: 6px; color: var(--primary); font-size: 0.9rem; font-weight: 600; cursor: pointer;">Logga</button>
                                            <span style="font-size: 0.7rem; color: var(--text-muted);">${setLabel}</span>
                                        </div>
                                    `;
                                }
                            } else if (!isAddingExtraSet) {
                                // Placeholder - inviting tap target
                                html += `
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; padding: 1.25rem; background: var(--surface); border: 2px dashed var(--border); border-radius: 12px; cursor: pointer;" onclick="event.stopPropagation(); window.activateSet(${dayIndex}, ${exIndex}, ${nextEmptySet})">
                                        <span style="font-size: 0.8rem;"><span style="color: var(--text-muted);">M√•l:</span> <span style="color: var(--text); font-weight: 500;">${exercise.reps} reps</span> </span>
                                        <span style="font-size: 1.5rem; color: var(--text-muted);">+</span>
                                        <span style="font-size: 0.75rem; color: var(--text-muted);">Logga set ${nextEmptySet + 1}</span>
                                    </div>
                                `;
                            }
                        } else if (firstEmptySetIndex >= exerciseSets && !isAddingExtraSet) {
                            // All sets completed! Just show + set button discretely
                            html += `
                                <div style="display: flex; justify-content: center; padding: 0.25rem 0;">
                                    <button onclick="event.stopPropagation(); window.addExtraSet(${dayIndex}, ${exIndex})" style="padding: 0.3rem 0.6rem; background: var(--surface); border: 1px dashed var(--border); border-radius: 4px; color: var(--text-muted); font-size: 0.7rem; cursor: pointer;">+ set</button>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
            }
            
            // L√§gg till √∂vning-knapp - alltid synlig men mer diskret i klientl√§ge
            if (day.exercises.length > 0) {
                if (ptMode) {
                    html += `
                        <div onclick="window.openExerciseModal(${dayIndex})" style="margin-top: 0.75rem; padding: 0.6rem; border: 2px dashed var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.4rem; color: var(--text-muted); transition: all 0.2s;">
                            <span style="font-size: 1rem;">+</span>
                            <span style="font-size: 0.8rem;">L√§gg till √∂vning</span>
                        </div>
                    `;
                } else {
                    // Klientl√§ge - mycket diskret
                    html += `
                        <div onclick="window.openExerciseModal(${dayIndex})" style="margin-top: 0.5rem; padding: 0.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.3rem; color: var(--text-muted); opacity: 0.5; font-size: 0.7rem;">
                            <span>+</span>
                            <span>L√§gg till √∂vning</span>
                        </div>
                    `;
                }
            }
            
            // Check if all exercises are complete for this day
            const allExercisesComplete = day.exercises.length > 0 && day.exercises.every((exercise, exIndex) => {
                const weekData = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
                const sets = weekData.sets || {};
                let completedCount = 0;
                for (let s = 0; s < exercise.sets; s++) {
                    if (sets[s]) completedCount++;
                }
                return completedCount >= exercise.sets;
            });
            
            // Check if day is manually marked as complete
            const dayWorkout = program.weeks[currentWeek - 1].workouts[dayIndex];
            const isManuallyComplete = dayWorkout.completed === true;
            const isDayComplete = allExercisesComplete || isManuallyComplete;
            
            // Filter exercises for current week
            const visibleExercisesForBottom = day.exercises.filter(ex => {
                const showForWeek = !ex.weekOnly || ex.weekOnly === currentWeek;
                const wasAddedBeforeOrAtWeek = !ex.addedAtWeek || ex.addedAtWeek <= currentWeek;
                return showForWeek && wasAddedBeforeOrAtWeek;
            });
            
            // Kolla om det finns of√§rdiga √∂vningar (f√∂r Starta pass-knapp)
            let hasIncompleteExercises = false;
            visibleExercisesForBottom.forEach(ex => {
                const exIndex = day.exercises.indexOf(ex);
                const weekData = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
                const exLogs = weekData.sets || {};
                let completed = 0;
                for (let s = 0; s < ex.sets; s++) {
                    if (exLogs[s]) completed++;
                }
                if (completed < ex.sets) hasIncompleteExercises = true;
            });
            
            // Bottom section: Starta pass + Klar button + Week navigation
            html += `
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            `;
            
            // STARTA PASS-knapp p√• mobil om det finns √∂vningar och of√§rdiga
            if (isMobile && visibleExercisesForBottom.length > 0 && hasIncompleteExercises) {
                html += `
                    <button onclick="window.startWorkoutMode()" style="width: 100%; padding: 1.25rem; margin-bottom: 1rem; background: linear-gradient(135deg, var(--accent), #00c896); border: none; border-radius: 14px; color: var(--primary); font-size: 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 229, 160, 0.3);">
                        ‚ñ∂ Starta pass
                    </button>
                `;
            }
            
            // Klar button - always show, but different states
            if (allExercisesComplete) {
                // All exercises complete - show as confirmed complete
                html += `
                    <div style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; background: rgba(0, 229, 160, 0.2); border: 2px solid var(--accent); border-radius: 8px; color: var(--accent); font-size: 0.9rem; font-weight: 500; text-align: center;">
                        ‚úì Alla √∂vningar klara!
                    </div>
                `;
            } else {
                // Not all complete - show toggle button
                html += `
                    <button onclick="window.toggleDayComplete(${dayIndex})" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; background: ${isManuallyComplete ? 'rgba(0, 229, 160, 0.3)' : 'var(--surface)'}; border: 2px ${isManuallyComplete ? 'solid' : 'dashed'} ${isManuallyComplete ? 'var(--accent)' : 'var(--border)'}; border-radius: 8px; color: ${isManuallyComplete ? 'var(--accent)' : 'var(--text-muted)'}; font-size: 0.9rem; font-weight: 500; cursor: pointer;">
                        ${isManuallyComplete ? '‚úì Markerad som klar' : 'Klar?'}
                    </button>
                `;
            }
            
            // Week navigation at bottom - always show at least 4 weeks
            const bottomWeeksToShow = Math.max(4, totalWeeks);
            const bottomStartWeek = Math.max(1, Math.min(currentWeek - 1, totalWeeks - 3));
            const bottomEndWeek = Math.min(totalWeeks, bottomStartWeek + 3);
            const bottomShowLeftArrow = bottomStartWeek > 1;
            const bottomShowRightArrow = bottomEndWeek < totalWeeks;
            
            html += `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Vecka</span>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 0.25rem;">
                        ${bottomShowLeftArrow ? `<button onclick="window.selectWeek(${bottomStartWeek - 1})" style="background: none; border: none; color: var(--text-muted); font-size: 1.1rem; padding: 0.3rem; cursor: pointer;">‚Äπ</button>` : ''}
                        ${Array.from({length: bottomEndWeek - bottomStartWeek + 1}, (_, i) => bottomStartWeek + i).map(w => {
                            // Check completion status for this week's day
                            const wDayWorkout = program.weeks[w - 1].workouts[dayIndex];
                            const wManuallyComplete = wDayWorkout.completed === true;
                            const wAllComplete = day.exercises.length > 0 && day.exercises.every((exercise, exIndex) => {
                                const wData = program.weeks[w - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
                                const wSets = wData.sets || {};
                                let count = 0;
                                for (let s = 0; s < exercise.sets; s++) {
                                    if (wSets[s]) count++;
                                }
                                return count >= exercise.sets;
                            });
                            const wComplete = wAllComplete || wManuallyComplete;
                            
                            let bgColor, textColor, borderColor, borderWidth;
                            const isCurrentWeek = w === currentWeek;
                            
                            // Determine completion state
                            if (wAllComplete) {
                                // Fully complete - solid green
                                bgColor = 'var(--accent)';
                                textColor = 'var(--primary)';
                                borderColor = isCurrentWeek ? 'white' : 'var(--accent)';
                                borderWidth = isCurrentWeek ? '2px' : '1px';
                            } else if (wManuallyComplete) {
                                // Manually marked complete - transparent green
                                bgColor = 'rgba(0, 229, 160, 0.3)';
                                textColor = 'var(--accent)';
                                borderColor = isCurrentWeek ? 'white' : 'var(--accent)';
                                borderWidth = isCurrentWeek ? '2px' : '1px';
                            } else if (isCurrentWeek) {
                                // Current week, not complete - white border to show selection
                                bgColor = 'var(--surface-elevated)';
                                textColor = 'var(--text)';
                                borderColor = 'white';
                                borderWidth = '2px';
                            } else {
                                // Other weeks, not complete
                                bgColor = 'transparent';
                                textColor = 'var(--text-muted)';
                                borderColor = 'var(--border)';
                                borderWidth = '1px';
                            }
                            
                            return `<div onclick="window.selectWeek(${w})" style="padding: 0.4rem 0.6rem; font-size: 0.75rem; font-weight: ${isCurrentWeek ? '600' : '400'}; background: ${bgColor}; color: ${textColor}; border-radius: 4px; cursor: pointer; border: ${borderWidth} solid ${borderColor};">V${w}</div>`;
                        }).join('')}
                        ${bottomShowRightArrow ? `<button onclick="window.selectWeek(${bottomEndWeek + 1})" style="background: none; border: none; color: var(--text-muted); font-size: 1.1rem; padding: 0.3rem; cursor: pointer;">‚Ä∫</button>` : ''}
                        ${!bottomShowRightArrow && ptMode ? `<button onclick="window.addWeek()" style="background: none; border: 1px dashed var(--border); color: var(--text-muted); font-size: 0.7rem; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; margin-left: 0.1rem;">+</button>` : ''}
                    </div>
                </div>
                </div>
            `;
            
            html += `</div>`;
            appContent.innerHTML = html;
        }
        
        // ===== FREE TRAINING FUNCTIONS =====
        
        function startFreeTraining() {
            freeTrainingMode = true;
            currentProgram = null;
            
            // If we have saved days, show the list, otherwise start new day and open exercise modal
            if (freeTrainingDays.length > 0) {
                currentFreeDay = null; // Show day list
                render();
            } else {
                // Start new day directly and open exercise modal
                startNewFreeDay();
            }
        }
        
        function exitFreeTraining() {
            freeTrainingMode = false;
            currentFreeDay = null;
            activeExercises = {};
            activeSet = null;
            render();
        }
        
        function openFreeDay(index) {
            currentFreeDay = index;
            activeExercises = {};
            activeSet = null;
            render();
        }
        
        function startNewFreeDay() {
            // Create new day immediately
            const newDay = {
                name: new Date().toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' }),
                date: new Date().toISOString(),
                exercises: []
            };
            freeTrainingDays.push(newDay);
            storage.save('freeTrainingDays', freeTrainingDays);
            
            currentFreeDay = freeTrainingDays.length - 1;
            freeTrainingMode = true;
            activeExercises = {};
            activeSet = null;
            
            // Open exercise modal directly
            openFreeExerciseModal();
        }
        
        function renderFreeTraining() {
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 768;
            
            if (currentFreeDay === null) {
                // Show list of saved days
                renderFreeDayList();
            } else if (currentFreeDay === 'new') {
                // Show new empty day
                renderNewFreeDay();
            } else {
                // Show existing day
                renderExistingFreeDay(currentFreeDay);
            }
        }
        
        function renderFreeDayList() {
            // Sort by date, newest first
            const sortedDays = [...freeTrainingDays].sort((a, b) => new Date(b.date) - new Date(a.date));
            const isEditMode = editModes['freeList'] || false;
            
            let html = `
                <div class="workout-builder">
                    <div class="builder-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="window.exitFreeTraining()" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;">‚Üê</button>
                            <h2 style="font-size: 1.15rem; margin: 0;">Logga tr√§ningspass</h2>
                        </div>
                        <button class="btn ${isEditMode ? 'btn-primary' : 'btn-secondary'}" onclick="window.toggleFreeListEditMode()" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;">${isEditMode ? '‚úì' : '‚úèÔ∏è'}</button>
                    </div>
                    
                    <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Dina tr√§ningspass</div>
            `;
            
            sortedDays.forEach((day, sortedIndex) => {
                // Find original index for onclick
                const originalIndex = freeTrainingDays.indexOf(day);
                const date = new Date(day.date);
                const dateStr = date.toLocaleDateString('sv-SE', { weekday: 'short', month: 'short', day: 'numeric' });
                const muscleGroups = [...new Set(day.exercises.map(ex => ex.muscleGroup).filter(mg => mg))];
                
                // Kolla om passet √§r genomf√∂rt (alla √∂vningar har alla sets loggade)
                const isDayComplete = day.exercises.length > 0 && day.exercises.every(ex => {
                    const logs = ex.logs || {};
                    let completed = 0;
                    for (let s = 0; s < ex.sets; s++) {
                        if (logs[s]) completed++;
                    }
                    return completed >= ex.sets;
                });
                
                // Styling f√∂r genomf√∂rt pass
                const cardBg = isDayComplete ? 'var(--surface)' : 'var(--surface)';
                const cardBorder = isDayComplete ? 'var(--border)' : 'var(--border)';
                const cardOpacity = isDayComplete ? '0.6' : '1';
                const titleColor = isDayComplete ? 'var(--text-muted)' : 'var(--text)';
                const iconColor = isDayComplete ? 'var(--text-muted)' : 'var(--accent)';
                
                html += `
                    <div style="position: relative; background: ${cardBg}; border: 1px solid ${cardBorder}; border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; opacity: ${cardOpacity};" onmouseenter="this.style.borderColor='var(--accent)'; this.style.opacity='1';" onmouseleave="this.style.borderColor='${cardBorder}'; this.style.opacity='${cardOpacity}';" onclick="${isEditMode ? '' : `window.openFreeDay(${originalIndex})`}">
                        ${isEditMode ? `<button onclick="event.stopPropagation(); window.deleteFreeDay(${originalIndex})" style="position: absolute; top: -6px; right: -6px; width: 22px; height: 22px; border-radius: 50%; background: var(--danger); border: 2px solid var(--primary); color: white; font-size: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">√ó</button>` : ''}
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: ${muscleGroups.length > 0 ? '0.75rem' : '0'};">
                            ${isDayComplete 
                                ? `<span style="color: var(--accent); font-size: 1rem;">‚úì</span>`
                                : `<div style="width: 0; height: 0; border-top: 7px solid transparent; border-bottom: 7px solid transparent; border-left: 10px solid ${iconColor};"></div>`
                            }
                            <div>
                                <div style="font-weight: 600; font-size: 1rem; color: ${titleColor};">${day.name || dateStr}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${day.exercises.length} √∂vningar${isDayComplete ? ' ‚Ä¢ Genomf√∂rt' : ''}</div>
                            </div>
                            ${!isEditMode && day.exercises.length > 0 ? `
                                <button onclick="event.stopPropagation(); window.saveDayAsProgram(${originalIndex})" style="margin-left: auto; padding: 0.3rem 0.5rem; background: var(--surface-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 0.3rem;" onmouseenter="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)';" onmouseleave="this.style.borderColor='var(--border)'; this.style.color='var(--text-muted)';">
                                    <span>üíæ</span>
                                    <span>Spara</span>
                                </button>
                            ` : ''}
                        </div>
                        ${muscleGroups.length > 0 ? `
                            <div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">
                                ${muscleGroups.map(mg => {
                                    const color = getMuscleColor(mg);
                                    return `<span style="background: ${color}20; color: ${color}; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.65rem; font-weight: 500;">${mg}</span>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // Spacer f√∂r fixed bottom bar
            html += `<div style="height: 160px;"></div>`;
            
            html += `</div>`;
            
            // Fixed bottom bar - l√§tt√•tkomlig f√∂r tummen
            html += `
                <div style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface-elevated); border-top: 1px solid var(--border); padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)); z-index: 100;">
                    <div style="max-width: 500px; margin: 0 auto; display: flex; gap: 0.5rem; align-items: center;">
                        <button onclick="window.startNewFreeDay()" style="width: 100%; padding: 1.1rem; background: var(--accent); border: none; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: var(--primary); font-weight: 600; font-size: 1rem;">
                            <span style="font-size: 1.2rem;">+</span>
                            <span>Nytt tr√§ningspass</span>
                        </button>
                    </div>
                </div>
            `;
            
            appContent.innerHTML = html;
        }
        
        function renderNewFreeDay() {
            let html = `
                <div class="workout-builder">
                    <div class="builder-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="window.backFromFreeDay()" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;">‚Üê</button>
                            <h2 style="font-size: 1.1rem; margin: 0;">Ny tr√§ning</h2>
                        </div>
                    </div>
                    
                    <div onclick="window.openFreeExerciseModal()" style="padding: 2rem; border: 2px dashed var(--border); border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; color: var(--text-muted); text-align: center;">
                        <span style="font-size: 2rem; color: var(--accent);">+</span>
                        <span style="font-size: 1rem;">L√§gg till √∂vning</span>
                        <span style="font-size: 0.75rem; opacity: 0.7;">B√∂rja logga ditt tr√§ningspass</span>
                    </div>
                </div>
            `;
            appContent.innerHTML = html;
        }
        
        function renderExistingFreeDay(index) {
            const day = freeTrainingDays[index];
            const dayIndex = index; // For consistency with program UI
            const isEditMode = editModes['free'] || false;
            const isMobile = window.innerWidth <= 768;
            
            // ======= WORKOUT MODE (Helsk√§rm f√∂r loggning) =======
            if (workoutModeActive && isMobile && activeSet) {
                renderWorkoutMode(index);
                return;
            }
            
            let html = `
                <div class="workout-builder">
                    <div class="builder-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="window.backFromFreeDay()" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;">‚Üê</button>
                            <h2 style="font-size: 1.1rem; margin: 0;">${day.name || 'Tr√§ningspass'}</h2>
                            <button onclick="window.showTrainingInfo()" style="width: 24px; height: 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.75rem;">?</button>
                        </div>
                        <button class="btn ${isEditMode ? 'btn-primary' : 'btn-secondary'}" onclick="window.toggleFreeEditMode()" style="padding: 0.4rem 0.5rem; font-size: 0.9rem;">${isEditMode ? '‚úì' : '‚úèÔ∏è'}</button>
                    </div>
            `;
            
            if (day.exercises.length === 0) {
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1rem; text-align: center; min-height: 40vh;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">üèãÔ∏è</div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--text);">Inga √∂vningar √§nnu</h3>
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Tryck p√• knappen nedan f√∂r att l√§gga till din f√∂rsta √∂vning</p>
                    </div>
                `;
            } else {
                // Header row - same as program
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 0.4rem 0.75rem; margin-bottom: 0.35rem; color: var(--text-muted); font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        <span>√ñvning</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <span style="width: 45px; text-align: center;">Reps</span>
                            <span style="width: 30px; text-align: center;">Set</span>
                        </div>
                    </div>
                `;
                
                // Render exercises - same UI as program
                day.exercises.forEach((exercise, exIndex) => {
                    const isExpanded = activeExercises[`free-${exIndex}`];
                    const exerciseSets = exercise.sets;
                    const logs = exercise.logs || {};
                    
                    // Count completed sets
                    let completedSetsCount = 0;
                    for (let s = 0; s < exerciseSets; s++) {
                        if (logs[s]) completedSetsCount++;
                    }
                    const isComplete = completedSetsCount >= exerciseSets;
                    
                    // Styling based on completion - subtle for completed exercises
                    const cardBg = isComplete ? 'var(--surface)' : 'var(--surface)';
                    const cardBorder = isComplete ? 'rgba(0, 229, 160, 0.3)' : 'var(--border)';
                    const nameColor = isComplete ? 'var(--text-muted)' : 'var(--text)';
                    const screenIsMobile = window.innerWidth <= 768;
                    
                    // Bygg staplade logg-rutor f√∂r mobil - vertikalt
                    const loggedSetIndices = Object.keys(logs).filter(k => logs[k]).map(Number).sort((a, b) => a - b);
                    let stackedLogsHtml = '';
                    if (loggedSetIndices.length > 0 && screenIsMobile && !isEditMode) {
                        stackedLogsHtml = `<div style="display: flex; flex-direction: column; gap: 0.25rem; padding: 0.5rem 0.75rem 0.75rem; border-top: 1px solid var(--border);">`;
                        loggedSetIndices.forEach(s => {
                            stackedLogsHtml += `<div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 0.7rem; color: var(--text-muted); width: 25px;">S${s+1}</span>
                                <div style="flex: 1; background: var(--surface-elevated); border: 1px solid var(--accent); border-radius: 6px; padding: 0.4rem 0.6rem; text-align: center;">
                                    <span style="color: var(--accent); font-weight: 600; font-size: 0.85rem;">${logs[s].weight} kg √ó ${logs[s].reps}</span>
                                </div>
                            </div>`;
                        });
                        stackedLogsHtml += `</div>`;
                    }
                    
                    html += `
                        <div class="free-exercise-item" data-free-exercise="${exIndex}" style="position: relative; background: ${cardBg}; border: 1px solid ${cardBorder}; border-radius: 8px; margin-bottom: 0.5rem; overflow: visible; ${isEditMode ? 'cursor: grab;' : ''}" ${isEditMode ? `draggable="true" ondragstart="window.handleFreeExerciseDragStart(event, ${exIndex})" ondragend="window.handleFreeExerciseDragEnd(event)" ondragover="window.handleFreeExerciseDragOver(event)" ondragenter="window.handleFreeExerciseDragEnter(event, ${exIndex})" ondragleave="window.handleFreeExerciseDragLeave(event)" ondrop="window.handleFreeExerciseDrop(event, ${index}, ${exIndex})"` : ''}>
                            ${isEditMode ? `<button onclick="event.stopPropagation(); window.deleteFreeExercise(${index}, ${exIndex})" style="position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: var(--danger); border: 2px solid var(--primary); color: white; font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">√ó</button>` : ''}
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; ${isEditMode ? 'cursor: grab;' : ''} ${isComplete ? 'opacity: 0.7;' : ''}" ${!screenIsMobile && !isEditMode ? `onclick="window.toggleFreeExercise(${exIndex})"` : ''}>
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0;">
                                    ${isEditMode ? `<span ontouchstart="window.handleFreeExerciseTouchStart(event, ${index}, ${exIndex})" ontouchmove="window.handleFreeExerciseTouchMove(event)" ontouchend="window.handleFreeExerciseTouchEnd(event)" style="color: var(--text-muted); font-size: 0.9rem; cursor: grab; padding: 0.25rem; touch-action: none;">‚ò∞</span>` : `<span style="color: ${isComplete ? 'var(--accent)' : 'var(--text-muted)'}; font-size: 0.75rem;">${isComplete ? '‚úì' : '‚óã'}</span>`}
                                    <div style="display: flex; flex-direction: column; gap: 0.1rem; min-width: 0;">
                                        <span style="font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: ${nameColor};">${exercise.name}</span>
                                        <span style="font-size: 0.7rem; color: ${getMuscleColor(exercise.muscleGroup)};">${exercise.muscleGroup}</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
                                    ${isEditMode ? `
                                        <input type="text" value="${exercise.reps}" onchange="window.updateFreeExerciseReps(${index}, ${exIndex}, this.value)" onclick="event.stopPropagation()" style="font-size: 0.8rem; color: var(--accent); width: 45px; text-align: center; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; padding: 0.2rem;">
                                        <input type="number" value="${exercise.sets}" min="1" max="10" onchange="window.updateFreeExerciseSets(${index}, ${exIndex}, this.value)" onclick="event.stopPropagation()" style="font-size: 0.8rem; color: var(--accent); width: 35px; text-align: center; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; padding: 0.2rem;">
                                    ` : `
                                        <span style="font-size: 0.85rem; color: var(--accent); width: 45px; text-align: center;">${exercise.reps}</span>
                                        <span style="font-size: 0.85rem; color: ${isComplete ? 'var(--accent)' : 'var(--text-muted)'}; width: 30px; text-align: center;">${completedSetsCount}/${exercise.sets}</span>
                                    `}
                                </div>
                            </div>
                            ${stackedLogsHtml}
                    `;
                    
                    // Expanded content (set logging) - ENDAST f√∂r desktop eller edit mode
                    if (isExpanded && !screenIsMobile) {
                        // Find all logged set indices
                        const loggedSetIndices = Object.keys(logs).filter(k => logs[k]).map(Number).sort((a, b) => a - b);
                        const maxLoggedIndex = loggedSetIndices.length > 0 ? Math.max(...loggedSetIndices) : -1;
                        const totalSetsToShow = Math.max(exerciseSets, maxLoggedIndex + 1);
                        
                        // Find first empty set
                        let firstEmptySetIndex = 0;
                        for (let i = 0; i < exerciseSets; i++) {
                            if (!logs[i]) {
                                firstEmptySetIndex = i;
                                break;
                            }
                            firstEmptySetIndex = i + 1;
                        }
                        
                        const hasFilledSets = loggedSetIndices.length > 0;
                        const allTargetSetsComplete = firstEmptySetIndex >= exerciseSets;
                        
                        html += `<div style="padding: 0.75rem; border-top: 1px solid var(--border); background: var(--surface-elevated);">`;
                        
                        // Show filled sets
                        if (hasFilledSets) {
                            const numSets = totalSetsToShow;
                            const isCompact = numSets > 4;
                            const isVeryCompact = numSets > 6;
                            
                            let boxPadding, labelSize, valueSize, gap;
                            if (isVeryCompact) {
                                boxPadding = '0.3rem 0.25rem'; labelSize = '0.45rem'; valueSize = '0.7rem'; gap = '0.2rem';
                            } else if (isCompact) {
                                boxPadding = '0.4rem 0.35rem'; labelSize = '0.5rem'; valueSize = '0.8rem'; gap = '0.25rem';
                            } else if (allTargetSetsComplete) {
                                boxPadding = '0.6rem 0.5rem'; labelSize = '0.6rem'; valueSize = '1rem'; gap = '0.35rem';
                            } else {
                                boxPadding = '0.4rem 0.5rem'; labelSize = '0.55rem'; valueSize = '0.85rem'; gap = '0.35rem';
                            }
                            
                            // Vertical layout for logged sets (same as program)
                            html += `<div style="display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 0.5rem;">`;
                            
                            const maxSetToShow = Math.max(exerciseSets - 1, maxLoggedIndex);
                            
                            for (let s = 0; s <= maxSetToShow; s++) {
                                const set = logs[s];
                                const isExtraSet = s >= exerciseSets;
                                const isActiveSetNow = activeSet === `free-${exIndex}-${s}`;
                                
                                if (set) {
                                    const labelText = isExtraSet ? `+${s - exerciseSets + 1}` : `Set ${s + 1}`;
                                    
                                    if (isActiveSetNow) {
                                        html += `
                                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(0, 229, 160, 0.15); border: 2px solid var(--accent); border-radius: 6px;">
                                                <span style="font-size: 0.7rem; color: var(--accent); min-width: 35px; font-weight: 600;">${labelText}</span>
                                                <input type="number" inputmode="decimal" id="free-edit-weight-${exIndex}-${s}" value="${set.weight}" step="0.5" style="width: 50px; padding: 0.3rem; font-size: 0.85rem; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; color: var(--text); text-align: center;">
                                                <span style="color: var(--text-muted);">√ó</span>
                                                <input type="number" inputmode="numeric" id="free-edit-reps-${exIndex}-${s}" value="${set.reps}" style="width: 40px; padding: 0.3rem; font-size: 0.85rem; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; color: var(--text); text-align: center;" onkeypress="if(event.key==='Enter'){window.updateFreeSet(${index}, ${exIndex}, ${s})}">
                                                <button onclick="window.updateFreeSet(${index}, ${exIndex}, ${s})" style="padding: 0.25rem 0.5rem; background: var(--accent); border: none; border-radius: 4px; color: var(--primary); font-size: 0.7rem; font-weight: 600; cursor: pointer;">OK</button>
                                                <button onclick="event.stopPropagation(); window.clearFreeSet(${index}, ${exIndex}, ${s});" style="padding: 0.25rem 0.4rem; background: rgba(255, 80, 80, 0.8); border: none; border-radius: 4px; color: white; font-size: 0.7rem; cursor: pointer;">√ó</button>
                                            </div>
                                        `;
                                    } else {
                                        // Logged set - clean styling (same as program)
                                        html += `
                                            <div onclick="window.activateFreeSet(${exIndex}, ${s})" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                                                <span style="font-size: 0.7rem; color: var(--text-muted); min-width: 35px;">${labelText}</span>
                                                <span style="font-size: 0.9rem; font-weight: 600; color: var(--text);">${set.weight}kg √ó ${set.reps}</span>
                                            </div>
                                        `;
                                    }
                                    } else if (!allTargetSetsComplete) {
                                    // Empty set placeholder - skip for cleaner look
                                }
                            }
                            
                            html += `</div>`;
                        }
                        
                        // Input fields for next set
                        const screenIsMobile = window.innerWidth <= 768;
                        if (!allTargetSetsComplete || activeSet === `free-${exIndex}-extra`) {
                            const nextSetNum = firstEmptySetIndex;
                            const isAddingExtraSet = activeSet === `free-${exIndex}-extra`;
                            const showInputForSet = isAddingExtraSet ? (maxLoggedIndex + 1) : nextSetNum;
                            const isSetActive = activeSet === `free-${exIndex}-${showInputForSet}` || isAddingExtraSet;
                            const setLabel = isAddingExtraSet ? 'EXTRA SET' : `SET ${showInputForSet + 1} av ${exerciseSets}`;
                            
                            if (isSetActive) {
                                if (screenIsMobile) {
                                    // Mobil: Bara visa placeholder - input finns i fixed bar
                                    html += `
                                        <div style="padding: 0.4rem; text-align: center;">
                                            <span style="color: var(--text-muted); font-size: 0.9rem; letter-spacing: 2px;">...</span>
                                        </div>
                                    `;
                                } else {
                                    // Desktop: Visa inline input som tidigare
                                    if (inputStep === 'weight') {
                                        html += `
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(0, 229, 160, 0.08); border: 2px ${isAddingExtraSet ? 'dashed' : 'solid'} var(--accent); border-radius: 12px;">
                                                <span style="font-size: 0.8rem;"><span style="color: var(--text-muted);">M√•l:</span> <span style="color: var(--accent); font-weight: 600;">${exercise.reps} reps</span></span>
                                                <input type="number" inputmode="decimal" id="free-weight-${exIndex}" placeholder="0 kg" value="" step="0.5" min="0" max="999" onclick="event.stopPropagation()" onkeypress="if(event.key==='Enter'){window.confirmFreeWeight(${index}, ${exIndex}, ${showInputForSet})}" style="width: 100px; padding: 0.75rem; background: var(--surface); border: 2px solid var(--accent); border-radius: 8px; color: var(--text); text-align: center; font-size: 1.75rem; font-weight: 700;" autofocus>
                                                <button onclick="event.stopPropagation(); window.confirmFreeWeight(${index}, ${exIndex}, ${showInputForSet})" style="width: 100px; padding: 0.5rem; background: var(--accent); border: none; border-radius: 6px; color: var(--primary); font-size: 0.9rem; font-weight: 600; cursor: pointer;">Logga</button>
                                                <span style="font-size: 0.7rem; color: var(--text-muted);">${setLabel}</span>
                                            </div>
                                        `;
                                    } else {
                                        html += `
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(0, 229, 160, 0.08); border: 2px ${isAddingExtraSet ? 'dashed' : 'solid'} var(--accent); border-radius: 12px;">
                                                <span style="font-size: 0.8rem;"><span style="color: var(--text-muted);">M√•l:</span> <span style="color: var(--accent); font-weight: 600;">${exercise.reps} reps</span></span>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <input type="number" inputmode="decimal" id="free-weight-${exIndex}" value="${tempFreeWeight || ''}" step="0.5" min="0" max="999" onclick="event.stopPropagation()" style="width: 65px; padding: 0.5rem; background: var(--surface-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--accent); text-align: center; font-size: 1.1rem; font-weight: 600;">
                                                    <span style="color: var(--text-muted); font-size: 1.25rem;">√ó</span>
                                                    <input type="number" inputmode="numeric" id="free-reps-${exIndex}" placeholder="reps" value="" min="1" max="999" onclick="event.stopPropagation()" onkeypress="if(event.key==='Enter'){window.logFreeSet(${index}, ${exIndex})}" style="width: 65px; padding: 0.75rem; background: var(--surface); border: 2px solid var(--accent); border-radius: 8px; color: var(--text); text-align: center; font-size: 1.75rem; font-weight: 700;" autofocus>
                                                </div>
                                                <button onclick="event.stopPropagation(); window.logFreeSet(${index}, ${exIndex})" style="width: 100px; padding: 0.5rem; background: var(--accent); border: none; border-radius: 6px; color: var(--primary); font-size: 0.9rem; font-weight: 600; cursor: pointer;">Logga</button>
                                                <span style="font-size: 0.7rem; color: var(--text-muted);">${setLabel}</span>
                                            </div>
                                        `;
                                    }
                                }
                            } else if (!isAddingExtraSet) {
                                // Placeholder - inviting tap target
                                html += `
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; padding: 1.25rem; background: var(--surface); border: 2px dashed var(--border); border-radius: 12px; cursor: pointer;" onclick="event.stopPropagation(); window.activateFreeSetInput(${exIndex}, ${nextSetNum})">
                                        <span style="font-size: 0.8rem;"><span style="color: var(--text-muted);">M√•l:</span> <span style="color: var(--text); font-weight: 500;">${exercise.reps} reps</span> </span>
                                        <span style="font-size: 1.5rem; color: var(--text-muted);">+</span>
                                        <span style="font-size: 0.75rem; color: var(--text-muted);">Logga set ${nextSetNum + 1}</span>
                                    </div>
                                `;
                            }
                        } else if (firstEmptySetIndex >= exerciseSets) {
                            // All complete - just show extra set option
                            html += `
                                <div style="display: flex; justify-content: center; padding: 0.25rem 0;">
                                    <button onclick="event.stopPropagation(); window.activateFreeExtraSet(${exIndex})" style="padding: 0.3rem 0.6rem; background: var(--surface); border: 1px dashed var(--border); border-radius: 4px; color: var(--text-muted); font-size: 0.7rem; cursor: pointer;">+ set</button>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
            }
            
            // Spacer f√∂r fixed bottom bar
            html += `<div style="height: 120px;"></div>`;
            
            html += `</div>`;
            
            // Check if there's an active set to show fixed input bar
            let hasActiveInput = false;
            let activeExIndex = -1;
            let activeSetNum = -1;
            let activeExercise = null;
            
            if (activeSet && activeSet.startsWith('free-')) {
                const parts = activeSet.split('-');
                if (parts.length >= 2) {
                    activeExIndex = parseInt(parts[1]);
                    activeSetNum = parts.length >= 3 ? parseInt(parts[2]) : 0;
                    if (day.exercises[activeExIndex]) {
                        activeExercise = day.exercises[activeExIndex];
                        hasActiveInput = true;
                    }
                }
            }
            
            if (hasActiveInput && activeExercise && !isMobile) {
                // Desktop: Standard bottom bar med inline input
                html += `
                    <div id="freeTrainingBottomBar" style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface-elevated); border-top: 1px solid var(--border); padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)); z-index: 100;">
                        <div style="max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 0.75rem;">
                            <button onclick="window.openFreeExerciseModal()" style="width: 100%; padding: 1rem; background: var(--accent); border: none; border-radius: 12px; color: var(--primary); font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">+</span>
                                <span>L√§gg till √∂vning</span>
                            </button>
                            <button onclick="window.finishFreeTrainingWithPrompt(${index})" style="width: 100%; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text-muted); font-size: 0.9rem; cursor: pointer;">
                                ‚úì Klar med passet
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Standard bottom bar med knappar
                const isMobileView = window.innerWidth <= 768;
                
                // Kolla om det finns of√§rdiga √∂vningar
                let hasIncompleteExercises = false;
                day.exercises.forEach(ex => {
                    const exLogs = ex.logs || {};
                    let completed = 0;
                    for (let s = 0; s < ex.sets; s++) {
                        if (exLogs[s]) completed++;
                    }
                    if (completed < ex.sets) hasIncompleteExercises = true;
                });
                
                if (isMobileView && day.exercises.length > 0 && hasIncompleteExercises) {
                    // Mobil med √∂vningar - visa "Starta pass"-knapp
                    html += `
                        <div id="freeTrainingBottomBar" style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface-elevated); border-top: 1px solid var(--border); padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)); z-index: 100;">
                            <div style="max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 0.75rem;">
                                <button onclick="window.startWorkoutMode()" style="width: 100%; padding: 1.25rem; background: linear-gradient(135deg, var(--accent), #00c896); border: none; border-radius: 14px; color: var(--primary); font-size: 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 229, 160, 0.3);">
                                    ‚ñ∂ Starta pass
                                </button>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="window.openFreeExerciseModal()" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text-muted); font-size: 0.85rem; cursor: pointer;">
                                        + L√§gg till
                                    </button>
                                    <button onclick="window.finishFreeTrainingWithPrompt(${index})" style="flex: 1; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text-muted); font-size: 0.85rem; cursor: pointer;">
                                        ‚úì Klar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Desktop eller inga √∂vningar
                    html += `
                        <div id="freeTrainingBottomBar" style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface-elevated); border-top: 1px solid var(--border); padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)); z-index: 100;">
                            <div style="max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 0.75rem;">
                                <button onclick="window.openFreeExerciseModal()" style="width: 100%; padding: 1rem; background: var(--accent); border: none; border-radius: 12px; color: var(--primary); font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">+</span>
                                    <span>L√§gg till √∂vning</span>
                                </button>
                                <button onclick="window.finishFreeTrainingWithPrompt(${index})" style="width: 100%; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text-muted); font-size: 0.9rem; cursor: pointer;">
                                    ‚úì Klar med passet
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
            
            appContent.innerHTML = html;
        }
        
        function backFromFreeDay() {
            if (freeTrainingDays.length > 0) {
                currentFreeDay = null;
            } else {
                exitFreeTraining();
            }
            render();
        }
        
        function toggleFreeExercise(exIndex) {
            const key = `free-${exIndex}`;
            if (activeExercises[key]) {
                // Deactivate
                delete activeExercises[key];
                activeSet = null;
                inputStep = 'weight';
                tempFreeWeight = null;
            } else {
                // Activate this exercise and find first empty set
                activeExercises = {};
                activeExercises[key] = true;
                
                // Find first empty set position within target
                const day = freeTrainingDays[currentFreeDay];
                const exercise = day.exercises[exIndex];
                const targetSets = exercise.sets;
                const logs = exercise.logs || {};
                
                // Find first empty position within target sets
                let firstEmptySet = null;
                for (let i = 0; i < targetSets; i++) {
                    if (logs[i] === undefined) {
                        firstEmptySet = i;
                        break;
                    }
                }
                
                // Only auto-activate if there's an empty target set
                if (firstEmptySet !== null) {
                    activeSet = `free-${exIndex}-${firstEmptySet}`;
                    inputStep = 'weight';
                    tempFreeWeight = null;
                } else {
                    activeSet = null;
                }
            }
            render();
            
            // Focus the input if we activated a set
            if (activeSet && activeSet.startsWith('free-')) {
                setTimeout(() => {
                    const input = document.getElementById(`free-weight-${exIndex}`);
                    if (input) input.focus();
                }, 50);
            }
        }
        
        function openFreeExerciseModal() {
            currentDay = 'free';
            
            // Reset to step 1
            document.getElementById('exerciseStep1').style.display = 'block';
            document.getElementById('exerciseStep2').style.display = 'none';
            document.getElementById('exerciseStep3').style.display = 'none';
            
            // D√∂lj wheel picker sektionerna
            const mobileRepsSetPicker = document.getElementById('mobileRepsSetPicker');
            const desktopRepsPicker = document.getElementById('desktopRepsPicker');
            if (mobileRepsSetPicker) mobileRepsSetPicker.style.display = 'none';
            if (desktopRepsPicker) desktopRepsPicker.style.display = 'none';
            
            // √ñppna biblioteket direkt
            const library = document.getElementById('exerciseLibrary');
            const toggleIcon = document.getElementById('libraryToggleIcon');
            const toggleBtn = document.getElementById('toggleLibraryBtn');
            
            if (library) library.style.display = 'block';
            if (toggleIcon) toggleIcon.textContent = '‚úï';
            if (toggleBtn) {
                toggleBtn.style.background = 'var(--accent)';
                toggleBtn.style.borderColor = 'var(--accent)';
                toggleBtn.style.color = 'var(--primary)';
            }
            
            // Aktivera batch-select mode (alltid p√•)
            exerciseSelectMode = true;
            selectedExercises = [];
            
            // Visa selected bar
            const selectedBar = document.getElementById('selectedExercisesBar');
            const proceedBtn = document.getElementById('proceedSelectedBtn');
            if (selectedBar) {
                selectedBar.style.display = 'block';
                document.getElementById('selectedCount').textContent = 'V√§lj √∂vningar (max 10)';
            }
            if (proceedBtn) {
                proceedBtn.disabled = true;
                proceedBtn.style.opacity = '0.5';
                proceedBtn.style.cursor = 'not-allowed';
            }
            
            // Populate library
            populateExerciseLibrary();
            
            document.getElementById('exerciseName').value = '';
            document.getElementById('exerciseReps').value = '';
            
            const saveToLibrary = document.getElementById('saveToLibrary');
            if (saveToLibrary) saveToLibrary.checked = false;
            
            const step1NextBtn = document.getElementById('step1NextBtn');
            if (step1NextBtn) step1NextBtn.style.display = 'none';
            
            // Reset selected data
            selectedExerciseData = { name: '', muscleGroup: '', reps: '', sets: 3, isBatch: false, isManualEntry: false };
            
            // Hide all weeks toggle for free training
            const allWeeksToggle = document.getElementById('allWeeksToggle');
            if (allWeeksToggle) allWeeksToggle.style.display = 'none';
            
            exerciseModal.classList.add('show');
        }
        
        function addFreeExercise(name, muscleGroup, reps, sets, isLastInBatch = true) {
            const exercise = {
                name,
                muscleGroup,
                reps,
                sets: parseInt(sets),
                logs: {} // Object like program: { 0: {weight, reps}, 1: {weight, reps}, ... }
            };
            
            let isFirstExercise = false;
            
            if (currentFreeDay === 'new') {
                // Create new day
                const newDay = {
                    date: new Date().toISOString(),
                    name: '',
                    exercises: [exercise]
                };
                freeTrainingDays.unshift(newDay);
                storage.save('freeTrainingDays', freeTrainingDays);
                currentFreeDay = 0;
                isFirstExercise = true;
            } else {
                // Add to existing day
                isFirstExercise = freeTrainingDays[currentFreeDay].exercises.length === 0;
                freeTrainingDays[currentFreeDay].exercises.push(exercise);
                storage.save('freeTrainingDays', freeTrainingDays);
            }
            
            // Only update UI if this is the last in batch or single add
            if (isLastInBatch) {
                // Close all other exercises and open only the new one
                activeExercises = {};
                const newExIndex = freeTrainingDays[currentFreeDay].exercises.length - 1;
                activeExercises[`free-${newExIndex}`] = true;
                
                if (isFirstExercise) {
                    // F√∂rsta √∂vningen - bara expanderad, inte aktiverad input
                    activeSet = null;
                    inputStep = 'weight';
                    tempFreeWeight = null;
                } else {
                    // Efterf√∂ljande √∂vningar - aktivera input direkt
                    activeSet = `free-${newExIndex}-0`;
                    inputStep = 'weight';
                    tempFreeWeight = null;
                }
                
                render();
                
                // Om det inte √§r f√∂rsta √∂vningen - flytta fokus till input
                if (!isFirstExercise) {
                    // Flytta fokus fr√•n temp input till riktig input
                    requestAnimationFrame(() => {
                        const input = document.getElementById(`free-weight-${newExIndex}`);
                        const tempInput = document.getElementById('tempFocusInput');
                        if (input) {
                            input.focus();
                            // Ta bort temp input
                            if (tempInput) {
                                tempInput.remove();
                            }
                        }
                    });
                } else {
                    // Ta bort temp input om den finns
                    const tempInput = document.getElementById('tempFocusInput');
                    if (tempInput) tempInput.remove();
                }
            }
        }
        
        function logFreeSet(dayIndex, exIndex) {
            const weightInput = document.getElementById(`free-weight-${exIndex}`);
            const repsInput = document.getElementById(`free-reps-${exIndex}`);
            
            // Use tempFreeWeight if available (from step-based input)
            const weight = tempFreeWeight !== null ? tempFreeWeight : parseFloat(weightInput?.value) || 0;
            const reps = parseInt(repsInput?.value);
            
            // Validate
            if (weight < 0 || weight > 999) {
                alert('Vikt m√•ste vara mellan 0 och 999 kg');
                return;
            }
            if (!reps || reps <= 0 || reps > 999) {
                alert('Reps m√•ste vara mellan 1 och 999');
                return;
            }
            
            // Create temp input IMMEDIATELY to keep keyboard open
            const tempInput = document.createElement('input');
            tempInput.type = 'number';
            tempInput.inputMode = 'decimal';
            tempInput.style.cssText = 'position: fixed; top: 50%; left: 50%; width: 1px; height: 1px; opacity: 0; pointer-events: none; z-index: 9999;';
            document.body.appendChild(tempInput);
            tempInput.focus();
            
            const day = freeTrainingDays[dayIndex];
            const exercise = day.exercises[exIndex];
            const logs = exercise.logs || {};
            
            // Find next empty set index
            let nextSetIndex = 0;
            for (let i = 0; i < exercise.sets; i++) {
                if (!logs[i]) {
                    nextSetIndex = i;
                    break;
                }
                nextSetIndex = i + 1;
            }
            
            // If all target sets are done, add as extra
            if (nextSetIndex >= exercise.sets) {
                const extraIndices = Object.keys(logs).filter(k => parseInt(k) >= exercise.sets).map(Number);
                nextSetIndex = extraIndices.length > 0 ? Math.max(...extraIndices) + 1 : exercise.sets;
            }
            
            logs[nextSetIndex] = { weight, reps };
            exercise.logs = logs;
            
            storage.save('freeTrainingDays', freeTrainingDays);
            
            // Reset temp weight
            tempFreeWeight = null;
            
            // Find next empty set in current exercise
            let nextEmptySet = null;
            for (let i = 0; i < exercise.sets; i++) {
                if (!logs[i]) {
                    nextEmptySet = i;
                    break;
                }
            }
            
            if (nextEmptySet !== null) {
                // Auto-activate next set in same exercise
                activeSet = `free-${exIndex}-${nextEmptySet}`;
                inputStep = 'weight';
                
                render();
                
                // Focus weight input med preventScroll
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        const input = document.getElementById(`free-weight-${exIndex}`);
                        if (input) {
                            input.focus({ preventScroll: true });
                        }
                        if (document.body.contains(tempInput)) {
                            document.body.removeChild(tempInput);
                        }
                    }, 50);
                });
            } else {
                // All target sets complete for this exercise
                // Check if there's a next incomplete exercise
                let nextIncompleteExIndex = null;
                for (let i = 0; i < day.exercises.length; i++) {
                    if (i === exIndex) continue; // Skip current
                    const nextEx = day.exercises[i];
                    const nextLogs = nextEx.logs || {};
                    let completedCount = 0;
                    for (let s = 0; s < nextEx.sets; s++) {
                        if (nextLogs[s]) completedCount++;
                    }
                    if (completedCount < nextEx.sets) {
                        nextIncompleteExIndex = i;
                        break;
                    }
                }
                
                if (nextIncompleteExIndex !== null) {
                    // Move to next incomplete exercise
                    activeExercises = {};
                    activeExercises[`free-${nextIncompleteExIndex}`] = true;
                    
                    // Find first empty set in next exercise
                    const nextEx = day.exercises[nextIncompleteExIndex];
                    const nextLogs = nextEx.logs || {};
                    for (let s = 0; s < nextEx.sets; s++) {
                        if (!nextLogs[s]) {
                            activeSet = `free-${nextIncompleteExIndex}-${s}`;
                            inputStep = 'weight';
                            break;
                        }
                    }
                    
                    render();
                    
                    // Focus weight input of next exercise med preventScroll
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            const input = document.getElementById(`free-weight-${nextIncompleteExIndex}`);
                            if (input) {
                                input.focus({ preventScroll: true });
                            }
                            if (document.body.contains(tempInput)) {
                                document.body.removeChild(tempInput);
                            }
                        }, 50);
                    });
                } else {
                    // All exercises complete - show options
                    activeSet = null;
                    inputStep = 'weight';
                    activeExercises = {};
                    freeActiveSet = null;
                    
                    if (document.body.contains(tempInput)) {
                        document.body.removeChild(tempInput);
                    }
                    
                    render();
                    
                    // Show completion options
                    setTimeout(() => {
                        showFreeTrainingCompleteOptions(dayIndex, exIndex);
                    }, 100);
                }
            }
        }
        
        function showFreeTrainingCompleteOptions(dayIndex, exIndex) {
            const overlay = document.createElement('div');
            overlay.id = 'freeCompleteOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1001;';
            overlay.innerHTML = `
                <div style="background: var(--surface-elevated); border-radius: 16px; padding: 1.5rem; width: 280px; text-align: center;">
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text);">√ñvning klar!</div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button onclick="window.addAnotherFreeExercise(${dayIndex})" style="padding: 1rem; background: var(--accent); border: none; border-radius: 10px; color: var(--primary); font-size: 1rem; font-weight: 600; cursor: pointer;">Ny √∂vning</button>
                        <button onclick="window.closeExerciseComplete()" style="padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; cursor: pointer;">Klar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function closeExerciseComplete() {
            document.getElementById('freeCompleteOverlay')?.remove();
            // Stanna p√• sidan, g√∂r inget mer
        }
        
        function addAnotherFreeExercise(dayIndex) {
            document.getElementById('freeCompleteOverlay')?.remove();
            currentFreeDay = dayIndex;
            openFreeExerciseModal();
        }
        
        function finishFreeTrainingWithPrompt(dayIndex) {
            document.getElementById('freeCompleteOverlay')?.remove();
            
            const day = freeTrainingDays[dayIndex];
            if (day && day.exercises && day.exercises.length > 0) {
                if (confirm('Vill du spara tr√§ningspasset som ett program?')) {
                    // Skapa program fr√•n fri tr√§ning
                    const programName = prompt('Namn p√• programmet:', day.name) || day.name;
                    
                    const newProgram = {
                        name: programName,
                        days: [{
                            name: day.name,
                            exercises: day.exercises.map(ex => ({
                                name: ex.name,
                                muscleGroup: ex.muscleGroup || '',
                                reps: ex.reps || '8-10',
                                sets: ex.sets || 3
                            }))
                        }],
                        weeksCount: 1,
                        logs: {},
                        createdAt: new Date().toISOString()
                    };
                    
                    // Kopiera loggar till vecka 1
                    day.exercises.forEach((ex, exIndex) => {
                        if (ex.logs) {
                            Object.keys(ex.logs).forEach(setIndex => {
                                const logKey = `1-0-${exIndex}-${setIndex}`;
                                newProgram.logs[logKey] = ex.logs[setIndex];
                            });
                        }
                    });
                    
                    programs.push(newProgram);
                    storage.save('programs', programs);
                    
                    // G√• till startsidan
                    freeTrainingMode = false;
                    currentFreeDay = null;
                    render();
                    return;
                }
            }
            
            // Nej - g√• till fri tr√§ning listan
            currentFreeDay = null;
            render();
        }
        
        function finishFreeTraining() {
            document.getElementById('freeCompleteOverlay')?.remove();
            currentFreeDay = null;
            render();
        }
        
        window.addAnotherFreeExercise = addAnotherFreeExercise;
        window.closeExerciseComplete = closeExerciseComplete;
        window.finishFreeTraining = finishFreeTraining;
        window.finishFreeTrainingWithPrompt = finishFreeTrainingWithPrompt;
        
        function activateFreeSet(exIndex, setIndex) {
            activeSet = `free-${exIndex}-${setIndex}`;
            render();
        }
        
        function activateFreeSetInput(exIndex, setIndex) {
            activeSet = `free-${exIndex}-${setIndex}`;
            inputStep = 'weight';
            tempFreeWeight = null;
            render();
            setTimeout(() => {
                const weightInput = document.getElementById(`free-weight-${exIndex}`);
                if (weightInput) weightInput.focus();
            }, 50);
        }
        
        function confirmFreeWeight(dayIndex, exIndex, setIndex) {
            const weightInput = document.getElementById(`free-weight-${exIndex}`);
            const weight = parseFloat(weightInput.value) || 0; // Allow 0 for bodyweight exercises
            
            // Create temp input to keep keyboard open
            const tempInput = document.createElement('input');
            tempInput.type = 'number';
            tempInput.inputMode = 'decimal';
            tempInput.style.cssText = 'position: fixed; top: 50%; left: 50%; opacity: 0; pointer-events: none;';
            document.body.appendChild(tempInput);
            tempInput.focus();
            
            tempFreeWeight = weight;
            inputStep = 'reps';
            render();
            
            requestAnimationFrame(() => {
                setTimeout(() => {
                    const repsInput = document.getElementById(`free-reps-${exIndex}`);
                    if (repsInput) {
                        repsInput.focus();
                        repsInput.click();
                    }
                    document.body.removeChild(tempInput);
                }, 50);
            });
        }
        
        function activateFreeExtraSet(exIndex) {
            activeSet = `free-${exIndex}-extra`;
            inputStep = 'weight';
            tempFreeWeight = null;
            render();
            setTimeout(() => {
                const weightInput = document.getElementById(`free-weight-${exIndex}`);
                if (weightInput) weightInput.focus();
            }, 50);
        }
        
        function updateFreeSet(dayIndex, exIndex, setIndex) {
            const weightInput = document.getElementById(`free-edit-weight-${exIndex}-${setIndex}`);
            const repsInput = document.getElementById(`free-edit-reps-${exIndex}-${setIndex}`);
            
            const weight = parseFloat(weightInput.value);
            const reps = parseInt(repsInput.value);
            
            if (!weight || !reps) return;
            
            freeTrainingDays[dayIndex].exercises[exIndex].logs[setIndex] = { weight, reps };
            storage.save('freeTrainingDays', freeTrainingDays);
            
            activeSet = null;
            render();
        }
        
        function clearFreeSet(dayIndex, exIndex, setIndex) {
            delete freeTrainingDays[dayIndex].exercises[exIndex].logs[setIndex];
            storage.save('freeTrainingDays', freeTrainingDays);
            activeSet = null;
            render();
        }
        
        function toggleFreeEditMode() {
            editModes['free'] = !editModes['free'];
            render();
        }
        
        function toggleFreeListEditMode() {
            editModes['freeList'] = !editModes['freeList'];
            render();
        }
        
        function deleteFreeExercise(dayIndex, exIndex) {
            if (confirm('Ta bort denna √∂vning?')) {
                freeTrainingDays[dayIndex].exercises.splice(exIndex, 1);
                storage.save('freeTrainingDays', freeTrainingDays);
                activeExercises = {};
                activeSet = null;
                render();
            }
        }
        
        function updateFreeExerciseReps(dayIndex, exIndex, value) {
            freeTrainingDays[dayIndex].exercises[exIndex].reps = value;
            storage.save('freeTrainingDays', freeTrainingDays);
        }
        
        function updateFreeExerciseSets(dayIndex, exIndex, value) {
            freeTrainingDays[dayIndex].exercises[exIndex].sets = parseInt(value) || 1;
            storage.save('freeTrainingDays', freeTrainingDays);
            render();
        }
        
        window.updateFreeExerciseReps = updateFreeExerciseReps;
        window.updateFreeExerciseSets = updateFreeExerciseSets;
        
        function deleteFreeDay(dayIndex) {
            if (confirm('Ta bort hela detta tr√§ningspass?')) {
                freeTrainingDays.splice(dayIndex, 1);
                storage.save('freeTrainingDays', freeTrainingDays);
                
                // St√§ng edit mode
                editModes = {};
                
                // Go back to list or exit if no days left
                if (freeTrainingDays.length > 0) {
                    currentFreeDay = null;
                } else {
                    exitFreeTraining();
                }
                render();
            }
        }
        
        function saveDayAsProgram(dayIndex) {
            const day = freeTrainingDays[dayIndex];
            const date = new Date(day.date);
            const defaultName = day.name || date.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' });
            
            const programName = prompt('Namnge ditt program:', defaultName);
            
            if (programName && programName.trim()) {
                // Create new program from the free training day
                const newProgram = {
                    name: programName.trim(),
                    days: [{
                        name: 'Dag 1',
                        exercises: day.exercises.map(ex => ({
                            name: ex.name,
                            muscleGroup: ex.muscleGroup,
                            reps: ex.reps,
                            sets: ex.sets
                        }))
                    }],
                    weeksCount: 4,
                    weeks: Array.from({length: 4}, () => ({
                        workouts: [{
                            logs: {},
                            completed: false
                        }]
                    })),
                    level: 'Medel',
                    createdAt: new Date().toISOString()
                };
                
                programs.push(newProgram);
                storage.save('programs', programs);
                
                alert(`"${programName.trim()}" har sparats som program!`);
                
                // Exit free training and go to program list
                freeTrainingMode = false;
                currentFreeDay = null;
                render();
            }
        }
        
        function showTrainingInfo() {
            const overlay = document.createElement('div');
            overlay.id = 'trainingInfoOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1001; padding: 1rem;';
            overlay.innerHTML = `
                <div style="background: var(--surface-elevated); border-radius: 16px; padding: 1.5rem; max-width: 340px; width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--text);">üí° Tips f√∂r loggning</div>
                        <button onclick="document.getElementById('trainingInfoOverlay').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">√ó</button>
                    </div>
                    <div style="color: var(--text); font-size: 0.9rem; line-height: 1.6;">
                        <p style="margin-bottom: 1rem;"><strong>Logga working sets:</strong> Warm-up sets rekommenderas men beh√∂ver inte loggas.</p>
                        <p style="margin-bottom: 1rem;"><strong>V√§lj r√§tt vikt:</strong> Sikta p√• en vikt d√§r du n√•r 1-2 reps innan failure.</p>
                        <p><strong>Progressiv √∂verbelastning:</strong> F√∂rs√∂k √∂ka vikt eller reps √∂ver tid f√∂r att bygga styrka och muskler.</p>
                    </div>
                    <button onclick="document.getElementById('trainingInfoOverlay').remove()" style="width: 100%; margin-top: 1.5rem; padding: 1rem; background: var(--accent); border: none; border-radius: 10px; color: var(--primary); font-size: 1rem; font-weight: 600; cursor: pointer;">F√∂rst√•tt!</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        // Surprise modal state
        let surpriseStep = 1;
        let surpriseData = { duration: null, bodyPart: null, muscles: [], gender: null, mode: null };
        
        function openSurpriseModal() {
            surpriseStep = 1;
            surpriseData = { duration: null, bodyPart: null, muscles: [], gender: null, mode: null };
            renderSurpriseModal();
        }
        
        function renderSurpriseModal() {
            let existingOverlay = document.getElementById('surpriseOverlay');
            if (existingOverlay) existingOverlay.remove();
            
            const overlay = document.createElement('div');
            overlay.id = 'surpriseOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: flex-end; justify-content: center; z-index: 1001;';
            
            let content = '';
            const totalSteps = 2; // F√∂renklat: Tid ‚Üí Kroppsdel ‚Üí Klart
            
            if (surpriseStep === 1) {
                content = `
                    <div style="font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 1.25rem; text-align: center;">Hur l√§nge vill du tr√§na?</div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button onclick="window.setSurpriseDuration('30')" style="padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; cursor: pointer;">~30 minuter</button>
                        <button onclick="window.setSurpriseDuration('45')" style="padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; cursor: pointer;">~45 minuter</button>
                        <button onclick="window.setSurpriseDuration('60')" style="padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; cursor: pointer;">~60 minuter</button>
                    </div>
                `;
            } else if (surpriseStep === 2) {
                content = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 1.25rem;">
                        <span style="font-size: 1.1rem; font-weight: 600; color: var(--text);">Vad vill du tr√§na?</span>
                        <button onclick="alert('T√§nk p√• att vila 48 timmar innan du tr√§nar samma muskelgrupp igen.')" style="width: 20px; height: 20px; background: var(--surface); border: 1px solid var(--border); border-radius: 50%; color: var(--text-muted); font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">?</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button onclick="window.setSurpriseBodyPart('upper')" style="padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; cursor: pointer;">√ñverkropp</button>
                        <button onclick="window.setSurpriseBodyPart('lower')" style="padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; cursor: pointer;">Underkropp</button>
                        <button onclick="window.setSurpriseBodyPart('full')" style="padding: 1rem; background: rgba(0, 229, 160, 0.15); border: 1px solid var(--accent); border-radius: 10px; color: var(--accent); font-size: 1rem; font-weight: 600; cursor: pointer;">Helkropp</button>
                    </div>
                `;
            }
            
            // Progress dots
            const dots = [1, 2];
            const currentDotStep = surpriseStep;
            
            overlay.innerHTML = `
                <div style="background: var(--surface-elevated); border-radius: 20px 20px 0 0; padding: 1.5rem; padding-bottom: calc(1.5rem + env(safe-area-inset-bottom, 0px)); width: 100%; max-width: 400px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        ${surpriseStep > 1 ? `<button onclick="window.surpriseBack()" style="background: none; border: none; color: var(--text-muted); font-size: 1rem; cursor: pointer;">‚Üê Tillbaka</button>` : '<div></div>'}
                        <button onclick="document.getElementById('surpriseOverlay').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">√ó</button>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1.25rem;">
                        ${dots.map(s => `<div style="width: 8px; height: 8px; border-radius: 50%; background: ${s === currentDotStep ? 'var(--accent)' : 'var(--border)'};"></div>`).join('')}
                    </div>
                    ${content}
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function setSurpriseDuration(duration) {
            surpriseData.duration = duration;
            surpriseStep = 2;
            renderSurpriseModal();
        }
        
        function setSurpriseBodyPart(part) {
            surpriseData.bodyPart = part;
            // St√§ng wizard och visa resultat
            document.getElementById('surpriseOverlay').remove();
            // TODO: Generera tr√§ningspass baserat p√• surpriseData
            alert(`Kommer snart! Val: ${surpriseData.duration}min, ${part}`);
        }
        
        function surpriseBack() {
            if (surpriseStep > 1) {
                surpriseStep--;
                renderSurpriseModal();
            }
        }
        
        window.openSurpriseModal = openSurpriseModal;
        window.setSurpriseDuration = setSurpriseDuration;
        window.setSurpriseBodyPart = setSurpriseBodyPart;
        window.surpriseBack = surpriseBack;
        
        // Make free training functions global
        window.startFreeTraining = startFreeTraining;
        window.exitFreeTraining = exitFreeTraining;
        window.showTrainingInfo = showTrainingInfo;
        window.openFreeDay = openFreeDay;
        window.startNewFreeDay = startNewFreeDay;
        window.backFromFreeDay = backFromFreeDay;
        window.toggleFreeExercise = toggleFreeExercise;
        window.openFreeExerciseModal = openFreeExerciseModal;
        window.addFreeExercise = addFreeExercise;
        window.logFreeSet = logFreeSet;
        window.activateFreeSet = activateFreeSet;
        window.activateFreeSetInput = activateFreeSetInput;
        window.confirmFreeWeight = confirmFreeWeight;
        window.activateFreeExtraSet = activateFreeExtraSet;
        window.updateFreeSet = updateFreeSet;
        window.clearFreeSet = clearFreeSet;
        window.toggleFreeEditMode = toggleFreeEditMode;
        window.toggleFreeListEditMode = toggleFreeListEditMode;
        window.deleteFreeExercise = deleteFreeExercise;
        window.deleteFreeDay = deleteFreeDay;
        window.saveDayAsProgram = saveDayAsProgram;
        
        function cancelFreeInput() {
            activeSet = null;
            inputStep = 'weight';
            tempFreeWeight = null;
            render();
        }
        window.cancelFreeInput = cancelFreeInput;
        
        // ============ WORKOUT MODE (Helsk√§rmsl√§ge) ============
        
        function getRestTimeForReps(repsStr) {
            // Parsa reps-str√§ng (t.ex. "8-10" -> ta h√∂gsta v√§rdet)
            const parts = repsStr.toString().split('-');
            const maxReps = parseInt(parts[parts.length - 1]) || 10;
            
            if (maxReps <= 4) return 5 * 60; // 5 min
            if (maxReps <= 6) return 3 * 60; // 3 min
            if (maxReps <= 8) return 2 * 60 + 30; // 2:30
            if (maxReps <= 10) return 90; // 1:30
            if (maxReps <= 12) return 60; // 1 min
            return 45; // 45 sek
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function startWorkoutMode() {
            workoutModeActive = true;
            restTimerRunning = false;
            restTimerSeconds = 0;
            if (restTimerInterval) clearInterval(restTimerInterval);
            
            // Best√§m om det √§r fri tr√§ning eller program
            let day, exercises, isProgram = false;
            if (currentFreeDay !== null) {
                day = freeTrainingDays[currentFreeDay];
                exercises = day?.exercises || [];
            } else if (currentProgram !== null && currentMobileDay !== null) {
                const program = programs[currentProgram];
                day = program?.days[currentMobileDay];
                exercises = day?.exercises || [];
                isProgram = true;
            }
            
            if (!day || exercises.length === 0) {
                workoutModeActive = false;
                return;
            }
            
            // Funktion f√∂r att h√§mta loggar f√∂r en √∂vning
            function getLogsForExercise(exIndex) {
                if (!isProgram) {
                    return exercises[exIndex]?.logs || {};
                } else {
                    const program = programs[currentProgram];
                    if (!program?.weeks || !program.weeks[currentWeek - 1]) {
                        return {};
                    }
                    const weekData = program.weeks[currentWeek - 1]?.workouts?.[currentMobileDay]?.logs?.[exIndex];
                    if (!weekData) return {};
                    return weekData.sets || {};
                }
            }
            
            // Hitta f√∂rsta icke-f√§rdiga √∂vningen
            let firstIncompleteEx = 0;
            for (let i = 0; i < exercises.length; i++) {
                const ex = exercises[i];
                const logs = getLogsForExercise(i);
                let completed = 0;
                for (let s = 0; s < ex.sets; s++) {
                    if (logs[s]) completed++;
                }
                if (completed < ex.sets) {
                    firstIncompleteEx = i;
                    break;
                }
            }
            
            // Aktivera f√∂rsta set
            activeExercises = {};
            activeExercises[`free-${firstIncompleteEx}`] = true;
            
            const ex = exercises[firstIncompleteEx];
            if (!ex) {
                workoutModeActive = false;
                return;
            }
            
            const logs = getLogsForExercise(firstIncompleteEx);
            
            // Hitta f√∂rsta tomma set
            let foundEmptySet = false;
            for (let s = 0; s < ex.sets; s++) {
                if (!logs[s]) {
                    activeSet = `free-${firstIncompleteEx}-${s}`;
                    foundEmptySet = true;
                    break;
                }
            }
            
            // Om inget tomt set hittades, s√§tt till f√∂rsta setet √§nd√•
            if (!foundEmptySet) {
                activeSet = `free-${firstIncompleteEx}-0`;
            }
            
            inputStep = 'perform';  // B√∂rja med "g√∂r √∂vningen"-l√§get
            tempFreeWeight = null;
            
            render();
        }
        
        function exitWorkoutMode() {
            workoutModeActive = false;
            if (restTimerInterval) clearInterval(restTimerInterval);
            restTimerRunning = false;
            activeSet = null;
            activeExercises = {};
            
            // Visa tillbaka meny-knappen och PT/klient-toggle
            const menuBtn = document.getElementById('menuBtn');
            const modeSwitch = document.getElementById('modeSwitchBtn');
            if (menuBtn) menuBtn.style.display = 'flex';
            if (modeSwitch) modeSwitch.style.display = 'flex';
            
            render();
        }
        
        function startRestTimer(reps) {
            restTimerSeconds = getRestTimeForReps(reps);
            restTimerRunning = true;
            
            if (restTimerInterval) clearInterval(restTimerInterval);
            
            restTimerInterval = setInterval(() => {
                restTimerSeconds--;
                updateRestTimerDisplay();
                
                if (restTimerSeconds <= 0) {
                    clearInterval(restTimerInterval);
                    restTimerRunning = false;
                    // Vibrera om m√∂jligt
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    render();
                }
            }, 1000);
            
            render();
        }
        
        function updateRestTimerDisplay() {
            const timerEl = document.getElementById('restTimerDisplay');
            if (timerEl) {
                timerEl.textContent = formatTime(restTimerSeconds);
                // √Ñndra f√§rg n√§r det √§r n√§ra slut
                if (restTimerSeconds <= 10) {
                    timerEl.style.color = 'var(--accent)';
                } else {
                    timerEl.style.color = 'var(--text-muted)';
                }
            }
        }
        
        function skipRestTimer() {
            if (restTimerInterval) clearInterval(restTimerInterval);
            restTimerRunning = false;
            restTimerSeconds = 0;
            render();
        }
        
        // Tips-modal state
        let tipModalStep = 0;
        const trainingTips = [
            'V√§rm upp innan du b√∂rjar tr√§na.',
            'G√∂r n√•gra uppv√§rmningsset om du tr√§nar tungt. Dessa beh√∂ver inte loggas.',
            'V√§lj r√§tt vikt: vikten ska vara tillr√§ckligt tung f√∂r att klara angivet antal repetitioner, men ungef√§r 1-2 repetitioner fr√•n failure.'
        ];
        
        function showTrainingInfo() {
            tipModalStep = 0;
            renderTipModal();
        }
        
        function renderTipModal() {
            const isLastTip = tipModalStep >= trainingTips.length - 1;
            const modalHtml = `
                <div id="tipModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;">
                    <div style="background: var(--surface-elevated); border-radius: 16px; padding: 1.5rem; max-width: 350px; width: 100%; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.1rem; color: var(--accent);">Att t√§nka p√•!</h3>
                            <button onclick="window.closeTipModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;">√ó</button>
                        </div>
                        <p style="color: var(--text); font-size: 1rem; line-height: 1.5; margin: 0 0 1.5rem 0;">${trainingTips[tipModalStep]}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; gap: 0.5rem;">
                                ${trainingTips.map((_, i) => `<div style="width: 8px; height: 8px; border-radius: 50%; background: ${i === tipModalStep ? 'var(--accent)' : 'var(--border)'};"></div>`).join('')}
                            </div>
                            <button onclick="window.${isLastTip ? 'closeTipModal' : 'nextTip'}()" style="padding: 0.75rem 1.5rem; background: var(--accent); border: none; border-radius: 10px; color: var(--primary); font-weight: 600; cursor: pointer;">
                                ${isLastTip ? 'F√∂rst√•tt' : '‚Üí'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Ta bort eventuell existerande modal
            const existing = document.getElementById('tipModal');
            if (existing) existing.remove();
            
            // L√§gg till modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function nextTip() {
            tipModalStep++;
            if (tipModalStep < trainingTips.length) {
                renderTipModal();
            } else {
                closeTipModal();
            }
        }
        
        function closeTipModal() {
            const modal = document.getElementById('tipModal');
            if (modal) modal.remove();
        }
        
        window.showTrainingInfo = showTrainingInfo;
        window.nextTip = nextTip;
        window.closeTipModal = closeTipModal;
        
        function showRestTimerInfo() {
            alert('Det h√§r √§r bara riktlinjer f√∂r vila baserat p√• antalet reps √ó set - lyssna alltid p√• kroppen i f√∂rsta hand!');
        }
        
        function showPerformInfo() {
            alert('V√§lj en vikt som √§r tillr√§ckligt tung f√∂r att klara angivet antal repetitioner, men ungef√§r 1-2 repetitioner ifr√•n failure.\n\nOBS: Se till att vara uppv√§rmd innan du b√∂rjar!');
        }
        
        // Toggle f√∂r decimal wheel
        let decimalWheelVisible = false;
        function toggleDecimalWheel() {
            decimalWheelVisible = !decimalWheelVisible;
            const container = document.getElementById('wheelDecimalContainer');
            const btn = document.getElementById('toggleDecimalBtn');
            if (container) {
                container.style.display = decimalWheelVisible ? 'block' : 'none';
                if (decimalWheelVisible) {
                    // Initiera decimal wheel position
                    const wheelDecimal = document.getElementById('wheelDecimal');
                    if (wheelDecimal) {
                        wheelDecimal.scrollTop = 0;
                        highlightWheelItem(wheelDecimal, 0);
                    }
                } else {
                    // Nollst√§ll decimal
                    wheelPickerDecimal = 0;
                    updateWheelLogDisplay();
                }
            }
            if (btn) {
                btn.textContent = decimalWheelVisible ? 'D√∂lj decimaler' : 'Visa decimaler';
            }
        }
        
        // Funktion f√∂r att g√• fr√•n "perform" till "log" l√§ge
        function readyToLog() {
            inputStep = 'log';
            decimalWheelVisible = false;  // Reset decimal visibility
            
            // H√§mta f√∂reg√•ende set f√∂r default-v√§rden
            const parts = activeSet.split('-');
            const exIndex = parseInt(parts[1]);
            const setNum = parseInt(parts[2]) || 0;
            
            let defaultWeight = 0;
            let defaultReps = 10;
            
            // H√§mta loggar
            let logs = {};
            if (currentFreeDay !== null) {
                const day = freeTrainingDays[currentFreeDay];
                const exercise = day.exercises[exIndex];
                logs = exercise?.logs || {};
            } else if (currentProgram !== null) {
                const program = programs[currentProgram];
                if (program?.weeks?.[currentWeek - 1]?.workouts?.[currentMobileDay]?.logs?.[exIndex]) {
                    logs = program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[exIndex].sets || {};
                }
            }
            
            // Om set > 0, anv√§nd f√∂reg√•ende sets v√§rden
            if (setNum > 0 && logs[setNum - 1]) {
                defaultWeight = logs[setNum - 1].weight || 0;
                defaultReps = logs[setNum - 1].reps || 10;
            } else if (setNum === 0 && currentProgram !== null && currentWeek > 1) {
                // F√∂r program: vecka 2+ - h√§mta fr√•n f√∂reg√•ende vecka
                const program = programs[currentProgram];
                const prevWeekLogs = program?.weeks?.[currentWeek - 2]?.workouts?.[currentMobileDay]?.logs?.[exIndex];
                if (prevWeekLogs?.sets) {
                    // Hitta sista loggade set fr√•n f√∂reg√•ende vecka
                    const prevSetIndices = Object.keys(prevWeekLogs.sets).map(Number).sort((a, b) => b - a);
                    if (prevSetIndices.length > 0) {
                        const lastSet = prevWeekLogs.sets[prevSetIndices[0]];
                        if (lastSet) {
                            defaultWeight = lastSet.weight || 0;
                            defaultReps = lastSet.reps || 10;
                        }
                    }
                }
            }
            
            // Separera kg och decimal
            wheelPickerKg = Math.floor(defaultWeight);
            wheelPickerDecimal = defaultWeight - wheelPickerKg;
            // Runda av decimal till n√§rmaste 0.25
            wheelPickerDecimal = Math.round(wheelPickerDecimal * 4) / 4;
            wheelPickerReps = defaultReps;
            
            render();
        }
        
        // Funktion f√∂r att g√• tillbaka fr√•n log till perform
        function goBackToPerform() {
            inputStep = 'perform';
            render();
        }
        
        // Funktion f√∂r att g√• till f√∂reg√•ende set
        function goToPrevSet() {
            if (!activeSet) return;
            
            const parts = activeSet.split('-');
            const prefix = parts[0]; // 'free' eller dayIndex
            let exIndex = parseInt(parts[1]);
            let setNum = parseInt(parts[2]) || 0;
            
            // H√§mta √∂vningar
            let exercises = [];
            if (currentFreeDay !== null) {
                exercises = freeTrainingDays[currentFreeDay]?.exercises || [];
            } else if (currentProgram !== null && currentMobileDay !== null) {
                const program = programs[currentProgram];
                exercises = program?.days[currentMobileDay]?.exercises || [];
            }
            
            if (setNum > 0) {
                // G√• till f√∂reg√•ende set i samma √∂vning
                setNum--;
            } else if (exIndex > 0) {
                // G√• till sista setet i f√∂reg√•ende √∂vning
                exIndex--;
                setNum = exercises[exIndex].sets - 1;
            } else {
                // Redan p√• f√∂rsta setet av f√∂rsta √∂vningen
                return;
            }
            
            // Uppdatera activeSet
            activeSet = `${prefix}-${exIndex}-${setNum}`;
            inputStep = 'perform';
            
            // Stoppa eventuell timer
            if (restTimerInterval) clearInterval(restTimerInterval);
            restTimerRunning = false;
            
            render();
        }
        
        // Funktion f√∂r att g√• till n√§sta set
        function goToNextSet() {
            if (!activeSet) return;
            
            const parts = activeSet.split('-');
            const prefix = parts[0]; // 'free' eller dayIndex
            let exIndex = parseInt(parts[1]);
            let setNum = parseInt(parts[2]) || 0;
            
            // H√§mta √∂vningar
            let exercises = [];
            if (currentFreeDay !== null) {
                exercises = freeTrainingDays[currentFreeDay]?.exercises || [];
            } else if (currentProgram !== null && currentMobileDay !== null) {
                const program = programs[currentProgram];
                exercises = program?.days[currentMobileDay]?.exercises || [];
            }
            
            const currentExercise = exercises[exIndex];
            if (!currentExercise) return;
            
            if (setNum < currentExercise.sets - 1) {
                // G√• till n√§sta set i samma √∂vning
                setNum++;
            } else if (exIndex < exercises.length - 1) {
                // G√• till f√∂rsta setet i n√§sta √∂vning
                exIndex++;
                setNum = 0;
            } else {
                // Redan p√• sista setet av sista √∂vningen
                return;
            }
            
            // Uppdatera activeSet
            activeSet = `${prefix}-${exIndex}-${setNum}`;
            inputStep = 'perform';
            
            // Stoppa eventuell timer
            if (restTimerInterval) clearInterval(restTimerInterval);
            restTimerRunning = false;
            
            render();
        }
        
        window.startWorkoutMode = startWorkoutMode;
        window.exitWorkoutMode = exitWorkoutMode;
        window.skipRestTimer = skipRestTimer;
        window.showRestTimerInfo = showRestTimerInfo;
        window.showPerformInfo = showPerformInfo;
        window.toggleDecimalWheel = toggleDecimalWheel;
        window.readyToLog = readyToLog;
        window.goBackToPerform = goBackToPerform;
        window.goToPrevSet = goToPrevSet;
        window.goToNextSet = goToNextSet;
        
        // ============ WHEEL PICKER SYSTEM ============
        
        // Spara senast anv√§nda vikter per √∂vning
        let exerciseLastWeights = JSON.parse(localStorage.getItem('exerciseLastWeights') || '{}');
        
        function saveLastWeight(exerciseName, weight) {
            exerciseLastWeights[exerciseName] = weight;
            localStorage.setItem('exerciseLastWeights', JSON.stringify(exerciseLastWeights));
        }
        
        function getLastWeight(exerciseName) {
            return exerciseLastWeights[exerciseName] || 0;
        }
        
        // Wheel picker state
        let wheelPickerKg = 0;
        let wheelPickerDecimal = 0;
        let wheelPickerReps = 10;
        
        // Kg-v√§rden med varierande steg
        const wheelKgValues = [];
        for (let i = 0; i <= 10; i++) wheelKgValues.push(i);           // 0-10 (1kg steg)
        for (let i = 12; i <= 30; i += 2) wheelKgValues.push(i);       // 12-30 (2kg steg)
        for (let i = 35; i <= 200; i += 5) wheelKgValues.push(i);      // 35-200 (5kg steg)
        
        function createWheelPickerHTML(type, exerciseName) {
            // Alltid starta p√• 0 kg
            wheelPickerKg = 0;
            wheelPickerDecimal = 0;
            
            if (type === 'weight') {
                // Generera kg-items - alltid starta p√• 0
                let kgItems = '';
                wheelKgValues.forEach((kg, idx) => {
                    const isSelected = idx === 0; // F√∂rsta (0) √§r alltid vald
                    kgItems += `<div class="wheel-item ${isSelected ? 'selected' : ''}" data-value="${kg}" data-index="${idx}">${kg}</div>`;
                });
                
                // Generera decimal-v√§rden (0, 0.25, 0.5, 0.75)
                const decimals = [0, 0.25, 0.5, 0.75];
                let decimalItems = '';
                decimals.forEach((d, idx) => {
                    const isSelected = idx === 0; // F√∂rsta (0) √§r alltid vald
                    const display = d === 0 ? ',0' : ',' + (d * 100).toString().replace('25', '25').replace('50', '5').replace('75', '75');
                    decimalItems += `<div class="wheel-item ${isSelected ? 'selected' : ''}" data-value="${d}">${display}</div>`;
                });
                
                return `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">V√§lj vikt (kg)</div>
                        
                        <div style="display: flex; justify-content: center; align-items: center; gap: 0;">
                            <!-- KG wheel -->
                            <div style="position: relative; height: 180px; width: 90px; overflow: hidden;">
                                <div style="position: absolute; top: 50%; left: 0; right: 0; height: 50px; transform: translateY(-50%); background: rgba(0, 229, 160, 0.15); border-top: 2px solid var(--accent); border-bottom: 2px solid var(--accent); pointer-events: none; z-index: 2;"></div>
                                <div id="wheelKg" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;" onscroll="window.onWheelKgScroll(this)">
                                    <div style="height: 65px;"></div>
                                    ${kgItems}
                                    <div style="height: 65px;"></div>
                                </div>
                            </div>
                            
                            <!-- Decimal wheel -->
                            <div style="position: relative; height: 180px; width: 70px; overflow: hidden;">
                                <div style="position: absolute; top: 50%; left: 0; right: 0; height: 50px; transform: translateY(-50%); background: rgba(0, 229, 160, 0.15); border-top: 2px solid var(--accent); border-bottom: 2px solid var(--accent); pointer-events: none; z-index: 2;"></div>
                                <div id="wheelDecimal" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;" onscroll="window.onWheelDecimalScroll(this)">
                                    <div style="height: 65px;"></div>
                                    ${decimalItems}
                                    <div style="height: 65px;"></div>
                                </div>
                            </div>
                            
                            <div style="font-size: 1.5rem; color: var(--text-muted); margin-left: 0.5rem;">kg</div>
                        </div>
                        
                        <div id="wheelWeightDisplay" style="font-size: 2rem; font-weight: 700; color: var(--accent); margin-top: 1rem;">0 kg</div>
                    </div>
                    
                    <button onclick="window.wheelConfirmWeight()" style="width: 100%; padding: 1.25rem; background: var(--accent); border: none; border-radius: 14px; color: var(--primary); font-size: 1.2rem; font-weight: 700; cursor: pointer;">
                        N√§sta ‚Üí
                    </button>
                `;
            } else {
                // Reps picker (1-50)
                let repsItems = '';
                for (let i = 1; i <= 50; i++) {
                    const isSelected = i === 10;
                    repsItems += `<div class="wheel-item ${isSelected ? 'selected' : ''}" data-value="${i}">${i}</div>`;
                }
                
                return `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.5rem; color: var(--accent); font-weight: 600;">${tempFreeWeight} kg</span>
                            <span style="color: var(--text-muted);">√ó</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">V√§lj antal reps</div>
                        
                        <div style="display: flex; justify-content: center; align-items: center;">
                            <!-- Reps wheel -->
                            <div style="position: relative; height: 180px; width: 100px; overflow: hidden;">
                                <div style="position: absolute; top: 50%; left: 0; right: 0; height: 50px; transform: translateY(-50%); background: rgba(0, 229, 160, 0.15); border-top: 2px solid var(--accent); border-bottom: 2px solid var(--accent); pointer-events: none; z-index: 2;"></div>
                                <div id="wheelReps" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;" onscroll="window.onWheelRepsScroll(this)">
                                    <div style="height: 65px;"></div>
                                    ${repsItems}
                                    <div style="height: 65px;"></div>
                                </div>
                            </div>
                            
                            <div style="font-size: 1.5rem; color: var(--text-muted); margin-left: 0.5rem;">reps</div>
                        </div>
                        
                        <div id="wheelRepsDisplay" style="font-size: 2rem; font-weight: 700; color: var(--accent); margin-top: 1rem;">10 reps</div>
                    </div>
                    
                    <button onclick="window.wheelConfirmReps()" style="width: 100%; padding: 1.25rem; background: var(--accent); border: none; border-radius: 14px; color: var(--primary); font-size: 1.2rem; font-weight: 700; cursor: pointer;">
                        Logga set ‚úì
                    </button>
                `;
            }
        }
        
        function onWheelKgScroll(el) {
            const itemHeight = 80;  // Item height
            const scrollTop = el.scrollTop;
            const selectedIndex = Math.round(scrollTop / itemHeight);
            const clampedIndex = Math.max(0, Math.min(wheelKgValues.length - 1, selectedIndex));
            wheelPickerKg = wheelKgValues[clampedIndex];
            updateWheelWeightDisplay();
            updateWheelLogDisplay();
            highlightWheelItem(el, selectedIndex);
        }
        
        function onWheelDecimalScroll(el) {
            const decimals = [0, 0.25, 0.5, 0.75];
            const itemHeight = 80;  // Item height
            const scrollTop = el.scrollTop;
            const selectedIndex = Math.round(scrollTop / itemHeight);
            wheelPickerDecimal = decimals[Math.max(0, Math.min(3, selectedIndex))] || 0;
            updateWheelWeightDisplay();
            updateWheelLogDisplay();
            highlightWheelItem(el, selectedIndex);
        }
        
        function onWheelRepsScroll(el) {
            const itemHeight = 80;  // Item height
            const scrollTop = el.scrollTop;
            const selectedIndex = Math.round(scrollTop / itemHeight);
            wheelPickerReps = Math.max(1, Math.min(50, selectedIndex + 1));
            updateWheelRepsDisplay();
            updateWheelLogDisplay();
            highlightWheelItem(el, selectedIndex);
        }
        
        // Funktion f√∂r att uppdatera kombinerad log display
        function updateWheelLogDisplay() {
            const display = document.getElementById('wheelLogDisplay');
            if (display) {
                display.textContent = `${wheelPickerKg + wheelPickerDecimal} kg √ó ${wheelPickerReps} reps`;
            }
        }
        
        // Funktion f√∂r att markera valt item med vit f√§rg
        function highlightWheelItem(container, selectedIndex) {
            const items = container.querySelectorAll('.wheel-item');
            items.forEach((item, idx) => {
                if (idx === selectedIndex) {
                    item.style.color = '#ffffff';
                    item.style.opacity = '1';
                    item.style.fontWeight = '700';
                } else {
                    item.style.color = '';
                    item.style.opacity = '';
                    item.style.fontWeight = '';
                }
            });
        }
        
        function updateWheelWeightDisplay() {
            const display = document.getElementById('wheelWeightDisplay');
            if (display) {
                display.textContent = (wheelPickerKg + wheelPickerDecimal) + ' kg';
            }
        }
        
        function updateWheelRepsDisplay() {
            const display = document.getElementById('wheelRepsDisplay');
            if (display) {
                display.textContent = wheelPickerReps + ' reps';
            }
        }
        
        function wheelConfirmWeight() {
            tempFreeWeight = wheelPickerKg + wheelPickerDecimal;
            inputStep = 'reps';
            wheelPickerReps = 10; // Reset reps
            render();
        }
        
        function wheelConfirmReps() {
            const reps = wheelPickerReps;
            
            // H√§mta aktiv √∂vning
            const parts = activeSet.split('-');
            const exIndex = parseInt(parts[1]);
            const setNum = parseInt(parts[2]) || 0;
            
            // Best√§m om det √§r fri tr√§ning eller program
            let day, exercise, exercises, logs;
            if (currentFreeDay !== null) {
                // Fri tr√§ning - loggar sparas direkt p√• √∂vningen
                day = freeTrainingDays[currentFreeDay];
                exercise = day.exercises[exIndex];
                exercises = day.exercises;
                
                if (!exercise.logs) exercise.logs = {};
                exercise.logs[setNum] = { weight: tempFreeWeight, reps: reps };
                logs = exercise.logs;
                
                storage.save('freeTrainingDays', freeTrainingDays);
            } else {
                // Program mode - loggar sparas per vecka
                const program = programs[currentProgram];
                day = program.days[currentMobileDay];
                exercise = day.exercises[exIndex];
                exercises = day.exercises;
                
                // S√§kerst√§ll att logg-strukturen finns
                if (!program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[exIndex]) {
                    program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[exIndex] = { sets: {} };
                }
                const weekLogs = program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[exIndex];
                if (!weekLogs.sets) weekLogs.sets = {};
                weekLogs.sets[setNum] = { weight: tempFreeWeight, reps: reps };
                logs = weekLogs.sets;
                
                storage.save('programs', programs);
            }
            
            // Spara senaste vikt f√∂r √∂vningen
            saveLastWeight(exercise.name, tempFreeWeight);
            
            // Kolla om det finns fler set i denna √∂vning
            const exerciseSets = exercise.sets;
            let nextSetInExercise = null;
            for (let s = 0; s < exerciseSets; s++) {
                if (!logs[s]) {
                    nextSetInExercise = s;
                    break;
                }
            }
            
            if (nextSetInExercise !== null) {
                // Starta vila-timer och f√∂rbered n√§sta set
                activeSet = `free-${exIndex}-${nextSetInExercise}`;
                inputStep = 'weight';
                tempFreeWeight = null;
                // Vila baserat p√• faktiskt loggade reps, inte m√•l-reps
                startRestTimer(reps);
            } else {
                // √ñvningen klar - hitta n√§sta √∂vning
                let nextExIndex = null;
                for (let i = 0; i < exercises.length; i++) {
                    if (i === exIndex) continue;
                    const nextEx = exercises[i];
                    
                    // H√§mta loggar f√∂r n√§sta √∂vning
                    let nextLogs;
                    if (currentFreeDay !== null) {
                        nextLogs = nextEx.logs || {};
                    } else {
                        const program = programs[currentProgram];
                        const nextWeekData = program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[i] || { sets: {} };
                        nextLogs = nextWeekData.sets || {};
                    }
                    
                    let completed = 0;
                    for (let s = 0; s < nextEx.sets; s++) {
                        if (nextLogs[s]) completed++;
                    }
                    if (completed < nextEx.sets) {
                        nextExIndex = i;
                        break;
                    }
                }
                
                if (nextExIndex !== null) {
                    // G√• till n√§sta √∂vning
                    activeExercises = {};
                    activeExercises[`free-${nextExIndex}`] = true;
                    
                    const nextEx = exercises[nextExIndex];
                    
                    // H√§mta loggar f√∂r n√§sta √∂vning
                    let nextLogs;
                    if (currentFreeDay !== null) {
                        nextLogs = nextEx.logs || {};
                    } else {
                        const program = programs[currentProgram];
                        const nextWeekData = program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[nextExIndex] || { sets: {} };
                        nextLogs = nextWeekData.sets || {};
                    }
                    
                    for (let s = 0; s < nextEx.sets; s++) {
                        if (!nextLogs[s]) {
                            activeSet = `free-${nextExIndex}-${s}`;
                            break;
                        }
                    }
                    inputStep = 'weight';
                    tempFreeWeight = null;
                    
                    // Kort vila mellan √∂vningar - baserat p√• senaste loggade reps
                    startRestTimer(reps);
                } else {
                    // Hela passet klart!
                    workoutModeActive = false;
                    activeSet = null;
                    activeExercises = {};
                    
                    alert('üéâ Bra jobbat! Hela passet √§r klart!');
                    render();
                }
            }
        }
        
        // Ny funktion f√∂r att logga fr√•n det kombinerade wheel picker-l√§get
        function wheelConfirmLog() {
            const weight = wheelPickerKg + wheelPickerDecimal;
            const reps = wheelPickerReps;
            
            // H√§mta aktiv √∂vning
            const parts = activeSet.split('-');
            const exIndex = parseInt(parts[1]);
            const setNum = parseInt(parts[2]) || 0;
            
            // Best√§m om det √§r fri tr√§ning eller program
            let day, exercise, exercises, logs;
            if (currentFreeDay !== null) {
                day = freeTrainingDays[currentFreeDay];
                exercise = day.exercises[exIndex];
                exercises = day.exercises;
                
                if (!exercise.logs) exercise.logs = {};
                exercise.logs[setNum] = { weight: weight, reps: reps };
                logs = exercise.logs;
                
                storage.save('freeTrainingDays', freeTrainingDays);
            } else {
                const program = programs[currentProgram];
                day = program.days[currentMobileDay];
                exercise = day.exercises[exIndex];
                exercises = day.exercises;
                
                if (!program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[exIndex]) {
                    program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[exIndex] = { sets: {} };
                }
                const weekLogs = program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[exIndex];
                if (!weekLogs.sets) weekLogs.sets = {};
                weekLogs.sets[setNum] = { weight: weight, reps: reps };
                logs = weekLogs.sets;
                
                storage.save('programs', programs);
            }
            
            // Spara senaste vikt f√∂r √∂vningen
            saveLastWeight(exercise.name, weight);
            
            // Kolla om det finns fler set i denna √∂vning
            const exerciseSets = exercise.sets;
            let nextSetInExercise = null;
            for (let s = 0; s < exerciseSets; s++) {
                if (!logs[s]) {
                    nextSetInExercise = s;
                    break;
                }
            }
            
            if (nextSetInExercise !== null) {
                // N√§sta set - starta vila och g√• till perform-l√§ge
                activeSet = `free-${exIndex}-${nextSetInExercise}`;
                inputStep = 'perform';
                startRestTimer(reps);
            } else {
                // √ñvningen klar - hitta n√§sta √∂vning
                let nextExIndex = null;
                for (let i = 0; i < exercises.length; i++) {
                    if (i === exIndex) continue;
                    const nextEx = exercises[i];
                    
                    let nextLogs;
                    if (currentFreeDay !== null) {
                        nextLogs = nextEx.logs || {};
                    } else {
                        const program = programs[currentProgram];
                        const nextWeekData = program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[i] || { sets: {} };
                        nextLogs = nextWeekData.sets || {};
                    }
                    
                    let completed = 0;
                    for (let s = 0; s < nextEx.sets; s++) {
                        if (nextLogs[s]) completed++;
                    }
                    if (completed < nextEx.sets) {
                        nextExIndex = i;
                        break;
                    }
                }
                
                if (nextExIndex !== null) {
                    // G√• till n√§sta √∂vning
                    activeExercises = {};
                    activeExercises[`free-${nextExIndex}`] = true;
                    
                    const nextEx = exercises[nextExIndex];
                    let nextLogs;
                    if (currentFreeDay !== null) {
                        nextLogs = nextEx.logs || {};
                    } else {
                        const program = programs[currentProgram];
                        const nextWeekData = program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[nextExIndex] || { sets: {} };
                        nextLogs = nextWeekData.sets || {};
                    }
                    
                    for (let s = 0; s < nextEx.sets; s++) {
                        if (!nextLogs[s]) {
                            activeSet = `free-${nextExIndex}-${s}`;
                            break;
                        }
                    }
                    inputStep = 'perform';
                    startRestTimer(reps);
                } else {
                    // Hela passet klart!
                    workoutModeActive = false;
                    activeSet = null;
                    activeExercises = {};
                    
                    alert('üéâ Bra jobbat! Hela passet √§r klart!');
                    render();
                }
            }
        }
        
        window.wheelConfirmLog = wheelConfirmLog;
        
        // ============ WHEEL PICKER F√ñR REPS/SET (l√§gg till √∂vning) ============
        
        const wheelRepsValues = ['1-2', '2-4', '4-6', '6-8', '8-10', '10-12', '12-15', '15-20'];
        const wheelSetsValues = [1, 2, 3, 4, 5, 6];
        let wheelAddReps = '10-12';
        let wheelAddSets = 3;
        let mobileAddExerciseMode = false;
        
        function showMobileRepsSetPicker() {
            mobileAddExerciseMode = true;
            const appContent = document.getElementById('app-content');
            
            // D√∂lj modal
            exerciseModal.classList.remove('show');
            
            const exerciseName = selectedExerciseData.isBatch 
                ? `${window.pendingBatchExercises?.length || selectedExercises.length} √∂vningar`
                : selectedExerciseData.name;
            
            const showAllWeeksToggle = currentDay !== 'free';
            
            const html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--primary); z-index: 9998; display: flex; flex-direction: column; overflow: hidden;">
                    <!-- Header -->
                    <div style="padding: 0.75rem 1rem; padding-top: calc(0.75rem + env(safe-area-inset-top, 0px)); background: var(--surface-elevated); border-bottom: 1px solid var(--border); flex-shrink: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="window.closeMobileRepsSetPicker()" style="padding: 0.4rem 0.6rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 0.8rem; cursor: pointer;">
                                ‚Üê Tillbaka
                            </button>
                            <span style="font-size: 0.85rem; color: var(--text-muted);">Steg 2 av 2</span>
                        </div>
                        <div style="text-align: center; margin-top: 0.75rem;">
                            <h1 style="font-size: 1.3rem; font-weight: 700; color: var(--accent); margin: 0; text-transform: uppercase;">${exerciseName}</h1>
                        </div>
                    </div>
                    
                    <!-- Main content - centrerad -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; overflow: hidden;">
                        <div style="font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem;">V√§lj reps √ó set</div>
                        
                        <div style="font-size: 3.5rem; font-weight: 800; color: var(--accent); line-height: 1; margin-bottom: 2rem;">
                            <span id="wheelRepsValueMobile">${wheelAddReps}</span>
                            <span style="color: var(--text-muted); font-size: 1.5rem; font-weight: 400;"> √ó </span>
                            <span id="wheelSetsValueMobile">${wheelAddSets}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: center; align-items: flex-start; gap: 1rem;">
                            <!-- REPS wheel -->
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 600;">Reps</div>
                                <div style="position: relative; height: 260px; width: 130px; overflow: hidden; border-radius: 16px; background: var(--surface-elevated);">
                                    <div style="position: absolute; top: 50%; left: 6px; right: 6px; height: 80px; transform: translateY(-50%); background: rgba(0, 229, 160, 0.15); border: 2px solid var(--accent); border-radius: 12px; pointer-events: none; z-index: 2;"></div>
                                    <div id="wheelRepsAddMobile" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;" onscroll="window.onWheelRepsAddScrollMobile(this)">
                                        <div style="height: 90px;"></div>
                                        ${wheelRepsValues.map(v => `<div class="wheel-item" data-value="${v}">${v}</div>`).join('')}
                                        <div style="height: 90px;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SET wheel -->
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 600;">Set</div>
                                <div style="position: relative; height: 260px; width: 115px; overflow: hidden; border-radius: 16px; background: var(--surface-elevated);">
                                    <div style="position: absolute; top: 50%; left: 6px; right: 6px; height: 80px; transform: translateY(-50%); background: rgba(0, 229, 160, 0.15); border: 2px solid var(--accent); border-radius: 12px; pointer-events: none; z-index: 2;"></div>
                                    <div id="wheelSetsAddMobile" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;" onscroll="window.onWheelSetsAddScrollMobile(this)">
                                        <div style="height: 90px;"></div>
                                        ${wheelSetsValues.map(v => `<div class="wheel-item" data-value="${v}">${v}</div>`).join('')}
                                        <div style="height: 90px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${showAllWeeksToggle ? `
                        <div onclick="window.toggleAllWeeks(); window.updateMobileAllWeeksToggle();" style="margin-top: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1rem; background: var(--surface-elevated); border-radius: 8px; cursor: pointer; user-select: none;">
                                <div id="allWeeksTrackMobileFS" style="width: 36px; height: 20px; background: ${addToAllWeeks ? 'var(--accent)' : 'var(--border)'}; border-radius: 10px; position: relative; transition: background 0.2s; flex-shrink: 0;">
                                    <div id="allWeeksThumbMobileFS" style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; left: ${addToAllWeeks ? '18px' : '2px'}; transition: all 0.2s;"></div>
                                </div>
                                <span style="font-size: 0.85rem; color: var(--text);">L√§gg till f√∂r alla veckor</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Fixed bottom button -->
                    <div style="padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)); background: var(--primary); flex-shrink: 0;">
                        <button onclick="window.addExerciseFromMobilePicker()" style="width: 100%; padding: 1.1rem; background: var(--accent); border: none; border-radius: 14px; color: var(--primary); font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px rgba(0, 229, 160, 0.3);">
                            L√§gg till ‚úì
                        </button>
                    </div>
                </div>
            `;
            
            appContent.innerHTML = html;
            
            // Initiera wheel positions
            setTimeout(() => {
                const wheelReps = document.getElementById('wheelRepsAddMobile');
                const wheelSets = document.getElementById('wheelSetsAddMobile');
                
                if (wheelReps) {
                    wheelReps.scrollTop = 5 * 80; // 10-12
                    highlightWheelItemAdd(wheelReps, 5);
                }
                if (wheelSets) {
                    wheelSets.scrollTop = 2 * 80; // 3
                    highlightWheelItemAdd(wheelSets, 2);
                }
            }, 100);
        }
        
        function onWheelRepsAddScrollMobile(el) {
            const itemHeight = 80;
            const scrollTop = el.scrollTop;
            const selectedIndex = Math.round(scrollTop / itemHeight);
            const clampedIndex = Math.max(0, Math.min(wheelRepsValues.length - 1, selectedIndex));
            wheelAddReps = wheelRepsValues[clampedIndex];
            
            const display = document.getElementById('wheelRepsValueMobile');
            if (display) display.textContent = wheelAddReps;
            highlightWheelItemAdd(el, clampedIndex);
        }
        
        function onWheelSetsAddScrollMobile(el) {
            const itemHeight = 80;
            const scrollTop = el.scrollTop;
            const selectedIndex = Math.round(scrollTop / itemHeight);
            const clampedIndex = Math.max(0, Math.min(wheelSetsValues.length - 1, selectedIndex));
            wheelAddSets = wheelSetsValues[clampedIndex];
            
            const display = document.getElementById('wheelSetsValueMobile');
            if (display) display.textContent = wheelAddSets;
            highlightWheelItemAdd(el, clampedIndex);
        }
        
        function updateMobileAllWeeksToggle() {
            const track = document.getElementById('allWeeksTrackMobileFS');
            const thumb = document.getElementById('allWeeksThumbMobileFS');
            if (track && thumb) {
                track.style.background = addToAllWeeks ? 'var(--accent)' : 'var(--border)';
                thumb.style.left = addToAllWeeks ? '18px' : '2px';
            }
        }
        
        function closeMobileRepsSetPicker() {
            mobileAddExerciseMode = false;
            // G√• tillbaka till modalen
            exerciseModal.classList.add('show');
            render();
        }
        
        function addExerciseFromMobilePicker() {
            selectedExerciseData.reps = wheelAddReps;
            selectedExerciseData.sets = wheelAddSets;
            
            mobileAddExerciseMode = false;
            addExerciseFromSteps();
        }
        
        window.showMobileRepsSetPicker = showMobileRepsSetPicker;
        window.closeMobileRepsSetPicker = closeMobileRepsSetPicker;
        window.addExerciseFromMobilePicker = addExerciseFromMobilePicker;
        window.onWheelRepsAddScrollMobile = onWheelRepsAddScrollMobile;
        window.onWheelSetsAddScrollMobile = onWheelSetsAddScrollMobile;
        window.updateMobileAllWeeksToggle = updateMobileAllWeeksToggle;
        
        function onWheelRepsAddScroll(el) {
            const itemHeight = 80;
            const scrollTop = el.scrollTop;
            const selectedIndex = Math.round(scrollTop / itemHeight);
            const clampedIndex = Math.max(0, Math.min(wheelRepsValues.length - 1, selectedIndex));
            wheelAddReps = wheelRepsValues[clampedIndex];
            updateWheelRepsSetDisplay();
            highlightWheelItemAdd(el, clampedIndex);
        }
        
        function onWheelSetsAddScroll(el) {
            const itemHeight = 80;
            const scrollTop = el.scrollTop;
            const selectedIndex = Math.round(scrollTop / itemHeight);
            const clampedIndex = Math.max(0, Math.min(wheelSetsValues.length - 1, selectedIndex));
            wheelAddSets = wheelSetsValues[clampedIndex];
            updateWheelRepsSetDisplay();
            highlightWheelItemAdd(el, clampedIndex);
        }
        
        // Funktion f√∂r att markera valt item i reps/set picker
        function highlightWheelItemAdd(container, selectedIndex) {
            const items = container.querySelectorAll('.wheel-item');
            items.forEach((item, idx) => {
                if (idx === selectedIndex) {
                    item.style.color = '#ffffff';
                    item.style.opacity = '1';
                    item.style.fontWeight = '700';
                } else {
                    item.style.color = '';
                    item.style.opacity = '';
                    item.style.fontWeight = '';
                }
            });
        }
        
        function updateWheelRepsSetDisplay() {
            const repsValue = document.getElementById('wheelRepsValue');
            const setsValue = document.getElementById('wheelSetsValue');
            if (repsValue) repsValue.textContent = wheelAddReps;
            if (setsValue) setsValue.textContent = wheelAddSets;
        }
        
        function initWheelRepsSetPositions() {
            setTimeout(() => {
                const wheelReps = document.getElementById('wheelRepsAdd');
                const wheelSets = document.getElementById('wheelSetsAdd');
                
                if (wheelReps) {
                    // Default till 10-12 (index 5 i ['1-2', '2-4', '4-6', '6-8', '8-10', '10-12', '12-15', '15-20'])
                    wheelReps.scrollTop = 5 * 80;
                    highlightWheelItemAdd(wheelReps, 5);
                }
                if (wheelSets) {
                    // Default till 3 (index 2)
                    wheelSets.scrollTop = 2 * 80;
                    highlightWheelItemAdd(wheelSets, 2);
                }
                
                wheelAddReps = '10-12';
                wheelAddSets = 3;
                updateWheelRepsSetDisplay();
            }, 100);
        }
        
        function addExerciseFromWheelPicker() {
            selectedExerciseData.reps = wheelAddReps;
            selectedExerciseData.sets = wheelAddSets;
            
            addExerciseFromSteps();
        }
        
        window.onWheelRepsAddScroll = onWheelRepsAddScroll;
        window.onWheelSetsAddScroll = onWheelSetsAddScroll;
        window.addExerciseFromWheelPicker = addExerciseFromWheelPicker;
        
        function initWheelScrollPositions(exerciseName) {
            setTimeout(() => {
                const wheelKg = document.getElementById('wheelKg');
                const wheelDecimal = document.getElementById('wheelDecimal');
                const wheelReps = document.getElementById('wheelReps');
                
                // Hitta r√§tt index f√∂r default-v√§rden
                const kgIndex = wheelKgValues.indexOf(wheelPickerKg);
                const decimalIndex = [0, 0.25, 0.5, 0.75].indexOf(wheelPickerDecimal);
                const repsIndex = wheelPickerReps - 1;
                
                if (wheelKg) {
                    wheelKg.scrollTop = (kgIndex >= 0 ? kgIndex : 0) * 80;
                    highlightWheelItem(wheelKg, kgIndex >= 0 ? kgIndex : 0);
                }
                if (wheelDecimal) {
                    wheelDecimal.scrollTop = (decimalIndex >= 0 ? decimalIndex : 0) * 80;
                    highlightWheelItem(wheelDecimal, decimalIndex >= 0 ? decimalIndex : 0);
                }
                if (wheelReps) {
                    wheelReps.scrollTop = repsIndex * 80;
                    highlightWheelItem(wheelReps, repsIndex);
                }
                
                updateWheelLogDisplay();
            }, 100);
        }
        
        window.onWheelKgScroll = onWheelKgScroll;
        window.onWheelDecimalScroll = onWheelDecimalScroll;
        window.onWheelRepsScroll = onWheelRepsScroll;
        window.wheelConfirmWeight = wheelConfirmWeight;
        window.wheelConfirmReps = wheelConfirmReps;
        
        // Rendera workout mode (helsk√§rmsl√§ge)
        function renderWorkoutMode(dayIndex) {
            // Best√§m om det √§r fri tr√§ning eller program
            let day, exercises, isProgram = false;
            if (currentFreeDay !== null) {
                day = freeTrainingDays[dayIndex];
                exercises = day?.exercises || [];
            } else if (currentProgram !== null && currentMobileDay !== null) {
                const program = programs[currentProgram];
                day = program?.days[currentMobileDay];
                exercises = day?.exercises || [];
                isProgram = true;
            }
            
            if (!day || exercises.length === 0) return;
            
            // Hitta aktiv √∂vning fr√•n activeSet
            const parts = activeSet.split('-');
            const activeExIndex = parseInt(parts[1]);
            const activeSetNum = parseInt(parts[2]) || 0;
            const exercise = exercises[activeExIndex];
            
            if (!exercise) {
                exitWorkoutMode();
                return;
            }
            
            // H√§mta loggar - olika struktur f√∂r fri tr√§ning vs program
            let logs = {};
            if (currentFreeDay !== null) {
                logs = exercise.logs || {};
            } else {
                const program = programs[currentProgram];
                if (program?.weeks?.[currentWeek - 1]?.workouts?.[currentMobileDay]?.logs?.[activeExIndex]) {
                    logs = program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[activeExIndex].sets || {};
                }
            }
            
            const exerciseSets = exercise.sets;
            
            // R√§kna hur m√•nga set som √§r klara
            let completedSets = 0;
            for (let s = 0; s < exerciseSets; s++) {
                if (logs[s]) completedSets++;
            }
            
            // Funktion f√∂r att h√§mta loggar f√∂r en √∂vning
            function getLogsForExercise(exIdx) {
                if (currentFreeDay !== null) {
                    return exercises[exIdx]?.logs || {};
                } else {
                    const program = programs[currentProgram];
                    if (program?.weeks?.[currentWeek - 1]?.workouts?.[currentMobileDay]?.logs?.[exIdx]) {
                        return program.weeks[currentWeek - 1].workouts[currentMobileDay].logs[exIdx].sets || {};
                    }
                    return {};
                }
            }
            
            // Ber√§kna progress baserat p√• f√§rdigloggade sets
            let totalSets = 0;
            let completedTotalSets = 0;
            let setPositions = []; // {percent, isComplete, isCurrent, isExerciseStart, exerciseIndex}
            
            exercises.forEach((ex, idx) => {
                const exLogs = getLogsForExercise(idx);
                for (let s = 0; s < ex.sets; s++) {
                    const isSetComplete = !!exLogs[s];
                    const isCurrentSet = idx === activeExIndex && s === activeSetNum;
                    setPositions.push({
                        percent: totalSets > 0 ? (totalSets / (totalSets + exercises.reduce((sum, e, i) => i > idx ? sum + e.sets : sum, 0) + (ex.sets - s))) * 100 : 0,
                        isComplete: isSetComplete,
                        isCurrent: isCurrentSet,
                        isExerciseStart: s === 0,
                        exerciseIndex: idx
                    });
                    if (isSetComplete) completedTotalSets++;
                    totalSets++;
                }
            });
            
            // Recalculate positions evenly
            setPositions = [];
            let runningTotal = 0;
            exercises.forEach((ex, idx) => {
                const exLogs = getLogsForExercise(idx);
                for (let s = 0; s < ex.sets; s++) {
                    const isSetComplete = !!exLogs[s];
                    const isCurrentSet = idx === activeExIndex && s === activeSetNum;
                    const percent = (runningTotal / totalSets) * 100;
                    setPositions.push({
                        percent: percent,
                        isComplete: isSetComplete,
                        isCurrent: isCurrentSet,
                        isExerciseStart: s === 0,
                        exerciseIndex: idx
                    });
                    runningTotal++;
                }
            });
            
            const progressPercent = totalSets > 0 ? (completedTotalSets / totalSets) * 100 : 0;
            
            // F√§rgbyte baserat p√• √∂vningsindex - udda √∂vningar = gul, j√§mna = gr√∂n
            const isOddExercise = activeExIndex % 2 === 1;
            const accentColor = isOddExercise ? '#FFD93D' : '#00e5a0'; // Gul f√∂r udda, gr√∂n f√∂r j√§mna
            const accentColorRgba = isOddExercise ? 'rgba(255, 217, 61, 0.3)' : 'rgba(0, 229, 160, 0.3)';
            
            // Bygg checkpoints l√§ngs progress bar - ALLA anv√§nder samma f√§rglogik
            let checkpointsHtml = '';
            setPositions.forEach((pos, i) => {
                const size = pos.isExerciseStart ? (pos.isCurrent ? '14px' : '10px') : (pos.isCurrent ? '8px' : '5px');
                // Alla checkpoints anv√§nder samma f√§rg som current exercise
                const dotColor = accentColor;
                const dotColorRgba = accentColorRgba;
                
                let bg, borderColor, glow;
                if (pos.isComplete) {
                    bg = dotColor;
                    borderColor = dotColor;
                    glow = '';
                } else if (pos.isCurrent) {
                    bg = dotColorRgba;
                    borderColor = dotColor;
                    glow = `box-shadow: 0 0 0 3px ${dotColorRgba};`;
                } else {
                    bg = 'var(--surface-elevated)';
                    borderColor = 'var(--border)';
                    glow = '';
                }
                
                checkpointsHtml += `
                    <div style="position: absolute; left: ${pos.percent}%; top: 50%; transform: translate(-50%, -50%); z-index: 2;">
                        <div style="width: ${size}; height: ${size}; border-radius: 50%; background: ${bg}; border: ${pos.isExerciseStart ? '2px' : '1px'} solid ${borderColor}; ${glow}">
                            ${pos.isComplete && pos.isExerciseStart ? '<span style="color: var(--primary); font-size: 0.45rem; font-weight: bold; display: flex; align-items: center; justify-content: center; height: 100%;">‚úì</span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            // Navigation - kan man g√• bak√•t eller fram√•t?
            const canGoPrev = activeExIndex > 0 || activeSetNum > 0;
            const canGoNext = activeExIndex < exercises.length - 1 || activeSetNum < exerciseSets - 1;
            
            const setLabel = `SET ${activeSetNum + 1} av ${exerciseSets}`;
            
            // Gemensam knapp-stil
            const primaryBtnStyle = `width: 100%; padding: 1.1rem; background: ${accentColor}; border: none; border-radius: 14px; color: var(--primary); font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px ${accentColorRgba};`;
            const secondaryBtnStyle = `width: 100%; padding: 1.1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 14px; color: var(--text-muted); font-size: 1.1rem; font-weight: 600; cursor: pointer;`;
            
            // Content och knapp separeras
            let mainContent = '';
            let bottomButton = '';
            
            if (restTimerRunning) {
                // TIMER-L√ÑGE
                mainContent = `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; background: linear-gradient(180deg, ${accentColorRgba} 0%, transparent 50%);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px;">Vila</div>
                            <button onclick="window.showRestTimerInfo()" style="width: 22px; height: 22px; background: var(--surface); border: 1px solid var(--border); border-radius: 50%; color: var(--text-muted); font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">?</button>
                        </div>
                        <div id="restTimerDisplay" style="font-size: 5rem; font-weight: 800; color: var(--text-muted); font-variant-numeric: tabular-nums; line-height: 1;">${formatTime(restTimerSeconds)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 1.5rem;">N√§sta: Set ${activeSetNum + 2} av ${exerciseSets}</div>
                    </div>
                `;
                bottomButton = `<button onclick="window.skipRestTimer()" style="${secondaryBtnStyle}">Hoppa √∂ver ‚Üí</button>`;
            } else {
                if (inputStep === 'perform') {
                    // STEG 1: G√ñR √ñVNINGEN
                    mainContent = `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; overflow: hidden;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 0.5rem;">G√ñR</div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <div style="font-size: 5rem; font-weight: 800; color: ${accentColor}; line-height: 1;">${exercise.reps}</div>
                                    <button onclick="window.showPerformInfo()" style="width: 28px; height: 28px; background: var(--surface); border: 1px solid var(--border); border-radius: 50%; color: var(--text-muted); font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-top: -2rem;">?</button>
                                </div>
                                <div style="font-size: 1.2rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px;">REPS</div>
                            </div>
                        </div>
                    `;
                    bottomButton = `<button onclick="window.readyToLog()" style="${primaryBtnStyle}">‚úì Klar ‚Äì logga</button>`;
                } else {
                    // STEG 2: LOGGA
                    mainContent = `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; overflow: hidden;">
                            <div style="font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem;">Vad lyfte du?</div>
                            
                            <div style="display: flex; justify-content: center; align-items: flex-start; gap: 1rem; margin-bottom: 0.75rem;">
                                <!-- KG wheel -->
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; color: ${accentColor}; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 600;">Vikt</div>
                                    <div style="display: flex; align-items: center;">
                                        <div style="position: relative; height: 260px; width: 130px; overflow: hidden; border-radius: 16px; background: var(--surface-elevated);">
                                            <div style="position: absolute; top: 50%; left: 6px; right: 6px; height: 80px; transform: translateY(-50%); background: ${accentColorRgba}; border: 2px solid ${accentColor}; border-radius: 12px; pointer-events: none; z-index: 2;"></div>
                                            <div id="wheelKg" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;" onscroll="window.onWheelKgScroll(this)">
                                                <div style="height: 90px;"></div>
                                                ${wheelKgValues.map((kg, idx) => `<div class="wheel-item" data-value="${kg}">${kg}</div>`).join('')}
                                                <div style="height: 90px;"></div>
                                            </div>
                                        </div>
                                        <!-- Decimal wheel - dold som default -->
                                        <div id="wheelDecimalContainer" style="display: none; position: relative; height: 260px; width: 90px; overflow: hidden; border-radius: 16px; background: var(--surface-elevated); margin-left: 0.25rem;">
                                            <div style="position: absolute; top: 50%; left: 6px; right: 6px; height: 80px; transform: translateY(-50%); background: ${accentColorRgba}; border: 2px solid ${accentColor}; border-radius: 12px; pointer-events: none; z-index: 2;"></div>
                                            <div id="wheelDecimal" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;" onscroll="window.onWheelDecimalScroll(this)">
                                                <div style="height: 90px;"></div>
                                                <div class="wheel-item" data-value="0">,0</div>
                                                <div class="wheel-item" data-value="0.25">,25</div>
                                                <div class="wheel-item" data-value="0.5">,5</div>
                                                <div class="wheel-item" data-value="0.75">,75</div>
                                                <div style="height: 90px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- REPS wheel -->
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; color: ${accentColor}; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 600;">Reps</div>
                                    <div style="display: flex; align-items: center;">
                                        <div style="position: relative; height: 260px; width: 115px; overflow: hidden; border-radius: 16px; background: var(--surface-elevated);">
                                            <div style="position: absolute; top: 50%; left: 6px; right: 6px; height: 80px; transform: translateY(-50%); background: ${accentColorRgba}; border: 2px solid ${accentColor}; border-radius: 12px; pointer-events: none; z-index: 2;"></div>
                                            <div id="wheelReps" class="wheel-scroll" style="height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;" onscroll="window.onWheelRepsScroll(this)">
                                                <div style="height: 90px;"></div>
                                                ${Array.from({length: 50}, (_, i) => `<div class="wheel-item" data-value="${i+1}">${i+1}</div>`).join('')}
                                                <div style="height: 90px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Toggle f√∂r decimaler -->
                            <button id="toggleDecimalBtn" onclick="window.toggleDecimalWheel()" style="background: none; border: none; color: var(--text-muted); font-size: 0.85rem; cursor: pointer; margin-bottom: 0.75rem; text-decoration: underline;">
                                Visa decimaler
                            </button>
                            
                            <div id="wheelLogDisplay" style="font-size: 2rem; font-weight: 700; color: ${accentColor};">${wheelPickerKg + wheelPickerDecimal} kg √ó ${wheelPickerReps} reps</div>
                        </div>
                    `;
                    bottomButton = `<button onclick="window.wheelConfirmLog()" style="${primaryBtnStyle}">Spara & vila</button>`;
                }
            }
            
            const html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--primary); z-index: 9998; display: flex; flex-direction: column; overflow: hidden;">
                    <!-- Header - kompakt -->
                    <div style="padding: 0.75rem 1rem; padding-top: calc(0.75rem + env(safe-area-inset-top, 0px)); background: var(--surface-elevated); border-bottom: 1px solid var(--border); flex-shrink: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <button onclick="window.exitWorkoutMode()" style="padding: 0.4rem 0.6rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 0.8rem; cursor: pointer;">
                                ‚úï
                            </button>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${canGoPrev ? `<button onclick="window.goToPrevSet()" style="padding: 0.4rem 0.6rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 0.8rem; cursor: pointer;">‚Üê</button>` : ''}
                                <span style="font-size: 0.75rem; color: var(--text-muted);">${setLabel}</span>
                                ${canGoNext ? `<button onclick="window.goToNextSet()" style="padding: 0.4rem 0.6rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 0.8rem; cursor: pointer;">‚Üí</button>` : ''}
                            </div>
                        </div>
                        
                        <!-- √ñvningsnamn - dynamisk f√§rg -->
                        <div style="text-align: center; margin-bottom: 0.75rem;">
                            <h1 style="font-size: 1.5rem; font-weight: 800; color: ${accentColor}; margin: 0; text-transform: uppercase;">${exercise.name}</h1>
                        </div>
                        
                        <!-- Progress bar med checkpoints -->
                        <div style="position: relative; height: 20px; margin: 0 0.5rem;">
                            <!-- Bakgrundslinje -->
                            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 4px; transform: translateY(-50%); background: var(--border); border-radius: 2px; z-index: 0;"></div>
                            <!-- Progress-fyllning -->
                            <div style="position: absolute; top: 50%; left: 0; height: 4px; transform: translateY(-50%); background: ${accentColor}; border-radius: 2px; z-index: 1; width: ${progressPercent}%; transition: width 0.4s ease-out;"></div>
                            <!-- Checkpoints -->
                            ${checkpointsHtml}
                        </div>
                    </div>
                    
                    <!-- Main content -->
                    ${mainContent}
                    
                    <!-- Fixed bottom button -->
                    <div style="padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)); background: var(--primary); flex-shrink: 0;">
                        ${bottomButton}
                    </div>
                </div>
            `;
            
            appContent.innerHTML = html;
            
            // D√∂lj meny-knappen och PT/klient-toggle i workout mode
            const menuBtn = document.getElementById('menuBtn');
            const modeSwitch = document.getElementById('modeSwitchBtn');
            if (menuBtn) menuBtn.style.display = 'none';
            if (modeSwitch) modeSwitch.style.display = 'none';
            
            // Initiera wheel picker scroll-positioner
            if (!restTimerRunning) {
                initWheelScrollPositions(exercise.name);
            }
        }
        
        function workoutConfirmWeight() {
            // Anv√§nds inte l√§ngre - wheel picker hanterar detta
            tempFreeWeight = wheelPickerKg + wheelPickerDecimal;
            inputStep = 'reps';
            render();
        }
        
        function workoutLogSet() {
            // Anv√§nds inte l√§ngre - wheelConfirmReps hanterar detta
            const reps = wheelPickerReps;
            
            // H√§mta aktiv √∂vning
            const parts = activeSet.split('-');
            const dayIndex = currentFreeDay;
            const exIndex = parseInt(parts[1]);
            const setNum = parseInt(parts[2]) || 0;
            
            const day = freeTrainingDays[dayIndex];
            const exercise = day.exercises[exIndex];
            
            if (!exercise.logs) exercise.logs = {};
            exercise.logs[setNum] = { weight: tempFreeWeight, reps: reps };
            
            storage.save('freeTrainingDays', freeTrainingDays);
            
            // Kolla om det finns fler set i denna √∂vning
            const exerciseSets = exercise.sets;
            let nextSetInExercise = null;
            for (let s = 0; s < exerciseSets; s++) {
                if (!exercise.logs[s]) {
                    nextSetInExercise = s;
                    break;
                }
            }
            
            if (nextSetInExercise !== null) {
                // Starta vila-timer och f√∂rbered n√§sta set
                activeSet = `free-${exIndex}-${nextSetInExercise}`;
                inputStep = 'weight';
                tempFreeWeight = null;
                startRestTimer(exercise.reps);
            } else {
                // √ñvningen klar - hitta n√§sta √∂vning
                let nextExIndex = null;
                for (let i = 0; i < day.exercises.length; i++) {
                    if (i === exIndex) continue;
                    const nextEx = day.exercises[i];
                    const nextLogs = nextEx.logs || {};
                    let completed = 0;
                    for (let s = 0; s < nextEx.sets; s++) {
                        if (nextLogs[s]) completed++;
                    }
                    if (completed < nextEx.sets) {
                        nextExIndex = i;
                        break;
                    }
                }
                
                if (nextExIndex !== null) {
                    // G√• till n√§sta √∂vning
                    activeExercises = {};
                    activeExercises[`free-${nextExIndex}`] = true;
                    
                    const nextEx = day.exercises[nextExIndex];
                    const nextLogs = nextEx.logs || {};
                    for (let s = 0; s < nextEx.sets; s++) {
                        if (!nextLogs[s]) {
                            activeSet = `free-${nextExIndex}-${s}`;
                            break;
                        }
                    }
                    inputStep = 'weight';
                    tempFreeWeight = null;
                    
                    // Kort vila mellan √∂vningar
                    startRestTimer(exercise.reps);
                } else {
                    // Hela passet klart!
                    workoutModeActive = false;
                    activeSet = null;
                    activeExercises = {};
                    
                    alert('üéâ Bra jobbat! Hela passet √§r klart!');
                    render();
                }
            }
        }
        
        window.workoutConfirmWeight = workoutConfirmWeight;
        window.workoutLogSet = workoutLogSet;
        
        // Globalt videolink-bibliotek (√∂vningsnamn -> videol√§nk)
        let exerciseVideoLinks = JSON.parse(localStorage.getItem('exerciseVideoLinks') || '{}');
        
        function getVideoLinkForExercise(exerciseName) {
            return exerciseVideoLinks[exerciseName] || '';
        }
        
        function saveVideoLinkForExercise(exerciseName, videoLink) {
            if (videoLink && videoLink.trim()) {
                exerciseVideoLinks[exerciseName] = videoLink.trim();
            } else {
                delete exerciseVideoLinks[exerciseName];
            }
            localStorage.setItem('exerciseVideoLinks', JSON.stringify(exerciseVideoLinks));
        }
        
        // Visa √∂vningshj√§lp/video modal - anv√§nder globalt videolink-bibliotek
        function showExerciseHelp(exIndex, exerciseNameOverride = null) {
            let exerciseName;
            
            // H√§mta √∂vningsnamn fr√•n olika k√§llor
            if (exerciseNameOverride) {
                exerciseName = exerciseNameOverride;
            } else if (freeTrainingDays[currentFreeDay] && freeTrainingDays[currentFreeDay].exercises[exIndex]) {
                exerciseName = freeTrainingDays[currentFreeDay].exercises[exIndex].name;
            } else {
                return;
            }
            
            // H√§mta videol√§nk fr√•n globalt bibliotek
            const videoLink = getVideoLinkForExercise(exerciseName);
            const isPT = ptMode;
            const isClient = currentProfile && currentProfile.type === 'client';
            const canEdit = isPT || (!isClient); // PT och standard kan redigera
            
            let modalContent = '';
            
            if (videoLink) {
                // Video finns - visa enkel knapp + m√∂jlighet att √§ndra (om beh√∂righet)
                modalContent = `
                    <div style="padding: 1.25rem; text-align: center;">
                        <h3 style="margin: 0 0 1.25rem; font-size: 1.2rem; color: var(--text);">${exerciseName}</h3>
                        <a href="${videoLink}" target="_blank" style="display: block; padding: 1rem; background: var(--accent); border: none; border-radius: 12px; color: var(--primary); text-decoration: none; font-weight: 700; font-size: 1.1rem; margin-bottom: 1rem;">
                            ‚ñ∂ Se √∂vningen
                        </a>
                        ${canEdit ? `
                            <button onclick="window.editExerciseVideoLink('${exerciseName.replace(/'/g, "\\'")}', '${videoLink.replace(/'/g, "\\'")}')" style="padding: 0.6rem 1rem; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 0.85rem; cursor: pointer;">
                                √Ñndra videol√§nk
                            </button>
                        ` : ''}
                        <button onclick="document.getElementById('exerciseHelpModal').remove()" style="display: block; width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); cursor: pointer;">St√§ng</button>
                    </div>
                `;
            } else if (canEdit) {
                // Ingen video - visa inmatning (f√∂r PT/standard)
                modalContent = `
                    <div style="padding: 1.25rem;">
                        <h3 style="margin: 0 0 1rem; font-size: 1.2rem; color: var(--text);">${exerciseName}</h3>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">L√§gg till en videol√§nk f√∂r denna √∂vning. L√§nken sparas och visas √∂verallt d√§r √∂vningen anv√§nds.</p>
                        <input type="url" id="exerciseVideoLinkInput" placeholder="https://youtube.com/..." style="width: 100%; padding: 0.85rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.saveNewExerciseVideoLink('${exerciseName.replace(/'/g, "\\'")}')" style="flex: 1; padding: 0.85rem; background: var(--accent); border: none; border-radius: 10px; color: var(--primary); font-weight: 600; cursor: pointer;">Spara</button>
                            <button onclick="document.getElementById('exerciseHelpModal').remove()" style="flex: 1; padding: 0.85rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); cursor: pointer;">St√§ng</button>
                        </div>
                    </div>
                `;
            } else {
                // Ingen video - klient ser tom vy
                modalContent = `
                    <div style="padding: 1.5rem; text-align: center;">
                        <h3 style="margin: 0 0 1rem; font-size: 1.2rem; color: var(--text);">${exerciseName}</h3>
                        <div style="padding: 2rem; background: var(--surface); border-radius: 12px; color: var(--text-muted);">
                            Inget att se h√§r... √§n
                        </div>
                        <button onclick="document.getElementById('exerciseHelpModal').remove()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); cursor: pointer;">St√§ng</button>
                    </div>
                `;
            }
            
            // Skapa modal
            const modal = document.createElement('div');
            modal.id = 'exerciseHelpModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 1rem;';
            modal.innerHTML = `
                <div style="background: var(--surface-elevated); border-radius: 16px; max-width: 380px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                    ${modalContent}
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }
        
        function editExerciseVideoLink(exerciseName, currentLink) {
            // Ta bort befintlig modal
            const existingModal = document.getElementById('exerciseHelpModal');
            if (existingModal) existingModal.remove();
            
            // Visa redigeringsmodal
            const modal = document.createElement('div');
            modal.id = 'exerciseHelpModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 1rem;';
            modal.innerHTML = `
                <div style="background: var(--surface-elevated); border-radius: 16px; max-width: 380px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                    <div style="padding: 1.25rem;">
                        <h3 style="margin: 0 0 1rem; font-size: 1.2rem; color: var(--text);">√Ñndra videol√§nk</h3>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;">${exerciseName}</p>
                        <input type="url" id="exerciseVideoLinkInput" placeholder="https://youtube.com/..." value="${currentLink}" style="width: 100%; padding: 0.85rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.saveNewExerciseVideoLink('${exerciseName.replace(/'/g, "\\'")}')" style="flex: 1; padding: 0.85rem; background: var(--accent); border: none; border-radius: 10px; color: var(--primary); font-weight: 600; cursor: pointer;">Spara</button>
                            <button onclick="document.getElementById('exerciseHelpModal').remove()" style="flex: 1; padding: 0.85rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); cursor: pointer;">Avbryt</button>
                        </div>
                        <button onclick="window.removeExerciseVideoLink('${exerciseName.replace(/'/g, "\\'")}')" style="display: block; width: 100%; margin-top: 0.75rem; padding: 0.6rem; background: transparent; border: none; color: var(--danger); font-size: 0.85rem; cursor: pointer;">Ta bort videol√§nk</button>
                    </div>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }
        
        function saveNewExerciseVideoLink(exerciseName) {
            const input = document.getElementById('exerciseVideoLinkInput');
            const videoLink = input ? input.value.trim() : '';
            
            saveVideoLinkForExercise(exerciseName, videoLink);
            
            document.getElementById('exerciseHelpModal').remove();
            
            // Visa bekr√§ftelse kort
            if (videoLink) {
                // √ñppna videon direkt efter sparning
                showExerciseHelp(0, exerciseName);
            }
        }
        
        function removeExerciseVideoLink(exerciseName) {
            saveVideoLinkForExercise(exerciseName, '');
            document.getElementById('exerciseHelpModal').remove();
        }
        
        window.showExerciseHelp = showExerciseHelp;
        window.editExerciseVideoLink = editExerciseVideoLink;
        window.saveNewExerciseVideoLink = saveNewExerciseVideoLink;
        window.removeExerciseVideoLink = removeExerciseVideoLink;
        window.getVideoLinkForExercise = getVideoLinkForExercise;
        
        // Free exercise drag and drop
        let draggedFreeExerciseIndex = null;
        
        function handleFreeExerciseDragStart(event, exIndex) {
            draggedFreeExerciseIndex = exIndex;
            event.dataTransfer.effectAllowed = 'move';
            event.target.closest('.free-exercise-item').style.opacity = '0.5';
        }
        
        function handleFreeExerciseDragEnd(event) {
            const item = event.target.closest('.free-exercise-item');
            if (item) item.style.opacity = '1';
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            draggedFreeExerciseIndex = null;
        }
        
        function handleFreeExerciseDragOver(event) {
            event.preventDefault();
        }
        
        function handleFreeExerciseDragEnter(event, targetExIndex) {
            if (draggedFreeExerciseIndex === null || draggedFreeExerciseIndex === targetExIndex) return;
            
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            
            const target = event.currentTarget;
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator';
            indicator.style.cssText = 'height: 3px; background: var(--accent); border-radius: 2px; margin: 4px 0; box-shadow: 0 0 8px var(--accent);';
            
            if (draggedFreeExerciseIndex < targetExIndex) {
                target.parentNode.insertBefore(indicator, target.nextSibling);
            } else {
                target.parentNode.insertBefore(indicator, target);
            }
        }
        
        function handleFreeExerciseDragLeave(event) {
            // Keep indicator
        }
        
        function handleFreeExerciseDrop(event, dayIndex, targetExIndex) {
            event.preventDefault();
            if (draggedFreeExerciseIndex === null || draggedFreeExerciseIndex === targetExIndex) return;
            
            const day = freeTrainingDays[dayIndex];
            
            // Move exercise
            const [movedExercise] = day.exercises.splice(draggedFreeExerciseIndex, 1);
            day.exercises.splice(targetExIndex, 0, movedExercise);
            
            storage.save('freeTrainingDays', freeTrainingDays);
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            draggedFreeExerciseIndex = null;
            render();
        }
        
        window.handleFreeExerciseDragStart = handleFreeExerciseDragStart;
        window.handleFreeExerciseDragEnd = handleFreeExerciseDragEnd;
        window.handleFreeExerciseDragOver = handleFreeExerciseDragOver;
        window.handleFreeExerciseDragEnter = handleFreeExerciseDragEnter;
        window.handleFreeExerciseDragLeave = handleFreeExerciseDragLeave;
        window.handleFreeExerciseDrop = handleFreeExerciseDrop;
        
        // Touch handlers f√∂r fri tr√§ning drag-and-drop (mobil)
        let freeExerciseTouchDayIndex = null;
        let freeExerciseTouchExIndex = null;
        let freeExerciseTouchElement = null;
        let freeExerciseTouchClone = null;
        
        function handleFreeExerciseTouchStart(event, dayIndex, exIndex) {
            event.preventDefault();
            freeExerciseTouchDayIndex = dayIndex;
            freeExerciseTouchExIndex = exIndex;
            freeExerciseTouchElement = event.target.closest('.free-exercise-item');
            
            // Skapa en klon som f√∂ljer fingret
            if (freeExerciseTouchElement) {
                freeExerciseTouchClone = freeExerciseTouchElement.cloneNode(true);
                freeExerciseTouchClone.style.cssText = `
                    position: fixed;
                    pointer-events: none;
                    z-index: 10000;
                    opacity: 0.8;
                    transform: scale(1.02);
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    width: ${freeExerciseTouchElement.offsetWidth}px;
                `;
                document.body.appendChild(freeExerciseTouchClone);
                
                const touch = event.touches[0];
                freeExerciseTouchClone.style.left = (touch.clientX - freeExerciseTouchElement.offsetWidth / 2) + 'px';
                freeExerciseTouchClone.style.top = (touch.clientY - 30) + 'px';
                
                freeExerciseTouchElement.style.opacity = '0.3';
            }
        }
        
        function handleFreeExerciseTouchMove(event) {
            if (!freeExerciseTouchClone) return;
            event.preventDefault();
            
            const touch = event.touches[0];
            freeExerciseTouchClone.style.left = (touch.clientX - freeExerciseTouchClone.offsetWidth / 2) + 'px';
            freeExerciseTouchClone.style.top = (touch.clientY - 30) + 'px';
            
            // Hitta element under fingret
            freeExerciseTouchClone.style.display = 'none';
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            freeExerciseTouchClone.style.display = '';
            
            // Ta bort alla drop indicators
            document.querySelectorAll('.free-drop-indicator').forEach(el => el.remove());
            
            if (elementBelow) {
                const targetItem = elementBelow.closest('.free-exercise-item');
                if (targetItem && targetItem !== freeExerciseTouchElement) {
                    const targetIndex = parseInt(targetItem.dataset.freeExercise);
                    if (!isNaN(targetIndex)) {
                        // Visa drop indicator
                        const indicator = document.createElement('div');
                        indicator.className = 'free-drop-indicator';
                        indicator.style.cssText = 'height: 3px; background: var(--accent); border-radius: 2px; margin: 4px 0;';
                        targetItem.parentNode.insertBefore(indicator, targetItem);
                    }
                }
            }
        }
        
        function handleFreeExerciseTouchEnd(event) {
            if (!freeExerciseTouchClone) return;
            
            const touch = event.changedTouches[0];
            
            // Hitta element under fingret
            freeExerciseTouchClone.style.display = 'none';
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            freeExerciseTouchClone.style.display = '';
            
            if (elementBelow) {
                const targetItem = elementBelow.closest('.free-exercise-item');
                if (targetItem && targetItem !== freeExerciseTouchElement) {
                    const targetIndex = parseInt(targetItem.dataset.freeExercise);
                    if (!isNaN(targetIndex) && freeExerciseTouchExIndex !== null && freeExerciseTouchExIndex !== targetIndex) {
                        // Flytta √∂vningen
                        const day = freeTrainingDays[freeExerciseTouchDayIndex];
                        const [movedExercise] = day.exercises.splice(freeExerciseTouchExIndex, 1);
                        day.exercises.splice(targetIndex, 0, movedExercise);
                        storage.save('freeTrainingDays', freeTrainingDays);
                    }
                }
            }
            
            // St√§da upp
            if (freeExerciseTouchElement) {
                freeExerciseTouchElement.style.opacity = '1';
            }
            if (freeExerciseTouchClone) {
                freeExerciseTouchClone.remove();
            }
            document.querySelectorAll('.free-drop-indicator').forEach(el => el.remove());
            
            freeExerciseTouchDayIndex = null;
            freeExerciseTouchExIndex = null;
            freeExerciseTouchElement = null;
            freeExerciseTouchClone = null;
            
            render();
        }
        
        window.handleFreeExerciseTouchStart = handleFreeExerciseTouchStart;
        window.handleFreeExerciseTouchMove = handleFreeExerciseTouchMove;
        window.handleFreeExerciseTouchEnd = handleFreeExerciseTouchEnd;

        function toggleDayComplete(dayIndex) {
            const program = programs[currentProgram];
            const dayWorkout = program.weeks[currentWeek - 1].workouts[dayIndex];
            dayWorkout.completed = !dayWorkout.completed;
            storage.save('programs', programs);
            render();
        }
        
        function openMobileDay(dayIndex) {
            currentMobileDay = dayIndex;
            activeExercises = {};
            activeSet = null;
            
            // Auto-navigate to first incomplete week
            const program = programs[currentProgram];
            if (program) {
                const day = program.days[dayIndex];
                const visibleExercises = day.exercises.filter(ex => {
                    const showForWeek = !ex.weekOnly || ex.weekOnly === currentWeek;
                    const wasAddedBeforeOrAtWeek = !ex.addedAtWeek || ex.addedAtWeek <= currentWeek;
                    return showForWeek && wasAddedBeforeOrAtWeek;
                });
                
                // Find first incomplete week
                for (let w = 1; w <= program.weeksCount; w++) {
                    // Filter exercises that should be counted for this week:
                    // - weekOnly matches this week, OR no weekOnly set
                    // - AND was added at or before this week (or no addedAtWeek = legacy)
                    const weekExercises = day.exercises.filter(ex => {
                        const showForWeek = !ex.weekOnly || ex.weekOnly === w;
                        const wasAddedBeforeOrAtWeek = !ex.addedAtWeek || ex.addedAtWeek <= w;
                        return showForWeek && wasAddedBeforeOrAtWeek;
                    });
                    if (weekExercises.length === 0) continue;
                    
                    const weekComplete = weekExercises.every((exercise) => {
                        const exIndex = day.exercises.indexOf(exercise);
                        const weekData = program.weeks[w - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
                        const sets = weekData.sets || {};
                        let completedCount = 0;
                        for (let s = 0; s < exercise.sets; s++) {
                            if (sets[s]) completedCount++;
                        }
                        return completedCount >= exercise.sets;
                    });
                    
                    // Also check if manually marked complete
                    const dayWorkout = program.weeks[w - 1].workouts[dayIndex];
                    const manuallyComplete = dayWorkout.completed === true;
                    
                    if (!weekComplete && !manuallyComplete) {
                        currentWeek = w;
                        break;
                    }
                }
            }
            
            render();
        }
        
        function closeMobileDay() {
            currentMobileDay = null;
            activeExercises = {};
            activeSet = null;
            render();
        }
        
        function renderDesktopView(program, hasEditMode) {
            console.log('=== renderDesktopView ===');
            console.log('ptMode:', ptMode);
            console.log('editModes:', JSON.stringify(editModes));
            console.log('hasEditMode:', hasEditMode);
            console.log('anyDayInEditMode:', Object.values(editModes).some(v => v));
            const screenWidth = window.innerWidth;
            const isVerySmall = screenWidth <= 400;
            const isMobile = screenWidth <= 768;
            const canSaveAsTemplate = currentProfile?.type !== 'client';
            const canEdit = currentProfile?.type !== 'client' && ptMode;
            
            // Ber√§kna tillg√§nglig bredd f√∂r veckor
            const exerciseColWidth = 250;
            const repsColWidth = 100;
            const setsColWidth = 100;
            const weekWidth = 600;
            
            const anyDayInEditMode = Object.values(editModes).some(v => v);
            
            let html = `
                <div class="workout-builder">
                    <div class="builder-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="closeProgram()" style="padding: 0.5rem 0.75rem; font-size: 1rem;">‚Üê Tillbaka</button>
                            <h2 style="font-size: 1.75rem; margin: 0;">${program.name}</h2>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${canSaveAsTemplate ? `<button onclick="saveProgramAsTemplate()" style="padding: 0.5rem 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text-muted); font-size: 0.9rem;">üíæ Spara som mall</button>` : ''}
                            ${canEdit ? `<button class="btn ${anyDayInEditMode ? 'btn-primary' : 'btn-secondary'}" onclick="window.toggleAllEditMode()" style="padding: 0.5rem 0.75rem; font-size: 1rem;">${anyDayInEditMode ? '‚úì Klar' : '‚úèÔ∏è Redigera'}</button>` : ''}
                        </div>
                    </div>
            `;
            
            program.days.forEach((day, dayIndex) => {
                const isCollapsed = collapsedDays[dayIndex];
                
                // Samla unika muskelgrupper f√∂r denna dag
                const muscleGroups = [...new Set(day.exercises.map(ex => ex.muscleGroup).filter(mg => mg))];
                
                // CSS triangle for collapse indicator
                const collapseIcon = isCollapsed 
                    ? `<div style="width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 10px solid var(--text-muted); transition: transform 0.2s;"></div>`
                    : `<div style="width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 10px solid var(--accent); transition: transform 0.2s;"></div>`;
                
                const isDayEditMode = editModes[dayIndex] && ptMode;
                
                html += `
                    <div class="day-section" data-day-index="${dayIndex}" style="position: relative; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; transition: all 0.2s; ${isDayEditMode ? 'cursor: grab;' : ''}" ${isDayEditMode ? `draggable="true" ondragstart="window.handleDayDragStart(event, ${dayIndex})" ondragend="window.handleDayDragEnd(event)" ondragover="window.handleDayDragOver(event)" ondragenter="window.handleDayDragEnter(event, ${dayIndex})" ondragleave="window.handleDayDragLeave(event)" ondrop="window.handleDayDrop(event, ${dayIndex})"` : (isCollapsed ? `onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'"` : '')}>
                        ${isDayEditMode ? `<button onclick="event.stopPropagation(); window.deleteDay(${dayIndex})" style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%; background: var(--danger); border: 2px solid var(--primary); color: white; font-size: 0.85rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">√ó</button>` : ''}
                        <div class="day-header" style="cursor: ${isDayEditMode ? 'grab' : 'pointer'}; margin-bottom: ${isCollapsed ? '0' : '1rem'};" onclick="${isDayEditMode ? '' : `window.toggleDayCollapse(${dayIndex})`}">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    ${isDayEditMode ? `<span style="color: var(--text-muted); font-size: 1.3rem; cursor: grab;">‚ò∞</span>` : collapseIcon}
                                    ${isDayEditMode ? `
                                        <div style="display: flex; align-items: center; gap: 0.5rem;" onclick="event.stopPropagation();">
                                            <input type="text" 
                                                   value="${day.name}" 
                                                   onchange="window.renameDayInline(${dayIndex}, this.value)" 
                                                   style="font-size: 1.25rem; font-weight: 600; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; padding: 0.25rem 0.5rem; color: var(--text); text-transform: uppercase;">
                                        </div>
                                    ` : `
                                        <div>
                                            <h3 style="margin: 0; font-size: 1.35rem; font-weight: 700;">${day.name.toUpperCase()}</h3>
                                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.25rem;">
                                                <span style="font-size: 0.8rem; color: var(--text-muted);">${day.exercises.length} √∂vningar</span>
                                                ${muscleGroups.length > 0 ? `
                                                    <div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">
                                                        ${muscleGroups.map(mg => {
                                                            const color = getMuscleColor(mg);
                                                            return `<span style="background: ${color}20; color: ${color}; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.65rem; font-weight: 500;">${mg}</span>`;
                                                        }).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                        <div id="day-content-${dayIndex}" style="display: ${isCollapsed ? 'none' : 'block'};">
                `;
                
                // Week navigation
                html += `<div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; align-items: center; padding: 1rem; background: var(--surface-elevated); border-radius: 8px; flex-wrap: wrap;">`;
                
                for (let w = 1; w <= program.weeksCount; w++) {
                    const isSelected = w === currentWeek;
                    
                    html += `
                        <div style="padding: 0.75rem 1.5rem; text-align: center; background: ${isSelected ? 'var(--accent)' : 'var(--surface)'}; color: ${isSelected ? 'var(--primary)' : 'var(--text-muted)'}; font-size: 1rem; font-weight: ${isSelected ? '600' : '500'}; border-radius: 8px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; gap: 0.25rem; border: 1px solid ${isSelected ? 'var(--accent)' : 'var(--border)'};" onclick="window.selectWeek(${w})">
                            <span>VECKA ${w}</span>
                            ${hasEditMode && program.weeksCount > 1 ? `<button onclick="event.stopPropagation(); window.deleteWeek(${w})" style="background: none; border: none; color: ${isSelected ? 'var(--primary)' : 'var(--danger)'}; cursor: pointer; font-size: 0.9rem; padding: 0; line-height: 1;">√ó</button>` : ''}
                        </div>
                    `;
                }
                
                html += `
                            ${ptMode ? `<button class="btn btn-secondary btn-sm" onclick="window.addWeek()" style="flex-shrink: 0; padding: 0.5rem 0.75rem;">+</button>` : ''}
                        </div>
                `;
                
                if (day.exercises.length === 0) {
                    html += `
                        <div class="empty-exercises" style="cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onclick="window.openExerciseModal(${dayIndex})">
                            <span style="color: var(--accent); font-size: 1.2rem;">+</span>
                            <span>L√§gg till √∂vning</span>
                        </div>
                    `;
                } else {
                    // DESKTOP LAYOUT: Original table view
                    // Calculate max sets from exercises, add 1 for input column
                    // Calculate the maximum sets across all exercises for header sizing
                    const maxSets = Math.max(...day.exercises.map(ex => ex.sets), 3);
                    const headerHeight = isVerySmall ? '35px' : (isMobile ? '38px' : '50px');
                    const headerPadding = isVerySmall ? '0.3rem' : (isMobile ? '0.4rem' : '0.75rem');
                    const headerFontSize = isVerySmall ? '0.6rem' : (isMobile ? '0.7rem' : '0.85rem');
                    
                    html += `
                        <div style="display: flex; position: relative;">
                            <!-- TARGET Block (Fixed) -->
                            <div style="flex-shrink: 0; border-right: 3px solid var(--accent); box-shadow: 3px 0 8px rgba(0, 0, 0, 0.4);">
                                <table style="border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--surface-elevated); height: ${headerHeight};">
                                            <th style="padding: ${headerPadding}; text-align: left; border: 1px solid var(--border); font-size: ${headerFontSize}; font-weight: 600; min-width: ${exerciseColWidth}px;">√ñVNINGAR</th>
                                            <th style="padding: ${headerPadding}; text-align: center; border: 1px solid var(--border); border-left: none; font-size: ${headerFontSize}; font-weight: 600; width: ${repsColWidth}px;">${isVerySmall ? 'R' : 'REPS'}</th>
                                            <th style="padding: ${headerPadding}; text-align: center; border: 1px solid var(--border); border-left: none; font-size: ${headerFontSize}; font-weight: 600; width: ${setsColWidth}px;">${isVerySmall ? 'S' : 'SET'}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // Filter exercises for current week (also respect addedAtWeek)
                    const visibleExercisesDesktop = day.exercises.filter(ex => {
                        const showForWeek = !ex.weekOnly || ex.weekOnly === currentWeek;
                        const wasAddedBeforeOrAtWeek = !ex.addedAtWeek || ex.addedAtWeek <= currentWeek;
                        return showForWeek && wasAddedBeforeOrAtWeek;
                    });
                    
                    visibleExercisesDesktop.forEach((exercise, visibleIndex) => {
                        const exIndex = day.exercises.indexOf(exercise);
                        const isEditMode = editModes[dayIndex];
                        const isActive = activeExercises[`${dayIndex}-${exIndex}`];
                        const tableRowHeight = isVerySmall ? '45px' : (isMobile ? '50px' : '80px');
                        const exNameSize = isVerySmall ? '0.65rem' : (isMobile ? '0.75rem' : '1rem');
                        const badgeSize = isVerySmall ? '0.5rem' : (isMobile ? '0.55rem' : '0.7rem');
                        const badgePadding = isVerySmall ? '0.05rem 0.15rem' : (isMobile ? '0.1rem 0.2rem' : '0.25rem 0.5rem');
                        
                        // Show week-only indicator
                        const isWeekSpecific = exercise.weekOnly === currentWeek;
                        
                        html += `
                            <tr class="exercise-item" data-day="${dayIndex}" data-exercise="${exIndex}" style="height: ${tableRowHeight}; ${isActive ? 'background: rgba(0, 229, 160, 0.1);' : ''} ${isEditMode ? 'cursor: grab;' : 'cursor: pointer;'} transition: background 0.2s;" ${isEditMode ? `draggable="true" ondragstart="window.handleDragStart(event, ${dayIndex}, ${exIndex})" ondragover="window.handleDragOver(event)" ondragenter="window.handleDragEnter(event, ${dayIndex}, ${exIndex})" ondragleave="window.handleDragLeave(event)" ondrop="window.handleDrop(event, ${dayIndex}, ${exIndex})" ondragend="window.handleDragEnd(event)"` : ''}>
                                <td style="padding: ${isVerySmall ? '0.2rem' : (isMobile ? '0.3rem' : '0.75rem')}; border: 1px solid var(--border); background: ${isActive ? 'rgba(0, 229, 160, 0.15)' : 'rgba(255, 255, 255, 0.03)'}; height: ${tableRowHeight}; vertical-align: middle; ${!isEditMode ? 'cursor: pointer;' : ''} transition: background 0.2s;" ${!isEditMode ? `onclick="window.toggleExerciseActive(${dayIndex}, ${exIndex})"` : ''}>
                                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.15rem; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 0.15rem; flex-wrap: wrap; font-size: ${exNameSize};">
                                            ${isEditMode ? '<span style="color: var(--text-muted); margin-right: 0.5rem;">‚ò∞</span>' : ''}${isActive ? '‚ñ∂' : ''}${exercise.name}
                                            <span class="muscle-badge" style="background: ${getMuscleColor(exercise.muscleGroup)}; color: #0a0e27; font-size: ${badgeSize}; padding: ${badgePadding};">${isVerySmall ? exercise.muscleGroup.substring(0,3) : exercise.muscleGroup}</span>
                                        </div>
                                        ${isEditMode ? `<button class="btn btn-danger" style="padding: 0.15rem 0.3rem; font-size: 0.6rem;" onclick="event.stopPropagation(); window.deleteExercise(${dayIndex}, ${exIndex})">√ó</button>` : ''}
                                    </div>
                                </div>
                                ${isEditMode ? `
                                    <td style="padding: ${isVerySmall ? '0.2rem' : (isMobile ? '0.3rem' : '0.5rem')}; text-align: center; border: 1px solid var(--border); border-left: none; background: ${isActive ? 'rgba(0, 229, 160, 0.15)' : 'rgba(255, 255, 255, 0.03)'}; height: ${tableRowHeight}; vertical-align: middle;">
                                        <input type="text" value="${exercise.reps}" onchange="window.updateExerciseReps(${dayIndex}, ${exIndex}, this.value)" onclick="event.stopPropagation()" style="width: 50px; padding: 0.3rem; font-size: ${isVerySmall ? '0.6rem' : (isMobile ? '0.7rem' : '0.9rem')}; font-weight: 600; color: var(--accent); text-align: center; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px;">
                                    </td>
                                    <td style="padding: ${isVerySmall ? '0.2rem' : (isMobile ? '0.3rem' : '0.5rem')}; text-align: center; border: 1px solid var(--border); border-left: none; background: ${isActive ? 'rgba(0, 229, 160, 0.15)' : 'rgba(255, 255, 255, 0.03)'}; height: ${tableRowHeight}; vertical-align: middle;">
                                        <input type="number" value="${exercise.sets}" min="1" max="10" onchange="window.updateExerciseSets(${dayIndex}, ${exIndex}, this.value)" onclick="event.stopPropagation()" style="width: 45px; padding: 0.3rem; font-size: ${isVerySmall ? '0.6rem' : (isMobile ? '0.7rem' : '0.9rem')}; font-weight: 600; color: var(--accent); text-align: center; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px;">
                                    </td>
                                ` : `
                                    <td style="padding: ${isVerySmall ? '0.2rem' : (isMobile ? '0.3rem' : '0.75rem')}; text-align: center; border: 1px solid var(--border); border-left: none; font-weight: 600; color: var(--accent); background: ${isActive ? 'rgba(0, 229, 160, 0.15)' : 'rgba(255, 255, 255, 0.03)'}; height: ${tableRowHeight}; vertical-align: middle; font-size: ${isVerySmall ? '0.6rem' : (isMobile ? '0.7rem' : '1rem')};">${exercise.reps}</td>
                                    <td style="padding: ${isVerySmall ? '0.2rem' : (isMobile ? '0.3rem' : '0.75rem')}; text-align: center; border: 1px solid var(--border); border-left: none; font-weight: 600; color: var(--accent); background: ${isActive ? 'rgba(0, 229, 160, 0.15)' : 'rgba(255, 255, 255, 0.03)'}; height: ${tableRowHeight}; vertical-align: middle; font-size: ${isVerySmall ? '0.6rem' : (isMobile ? '0.7rem' : '1rem')};">${exercise.sets}</td>
                                `}
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- WEEKS Block -->
                            <div style="flex-grow: 1; overflow-x: auto;" data-scroll-container="day-${dayIndex}">
                                <!-- Week headers as separate row -->
                                <div style="display: flex; background: var(--surface-elevated); height: ${headerHeight};">
                    `;
                    
                    for (let w = 1; w <= program.weeksCount; w++) {
                        const isCurrentWeek = w === currentWeek;
                        const weekHeaderBg = isCurrentWeek ? 'rgba(0, 229, 160, 0.15)' : '';
                        html += `
                                    <div style="width: ${weekWidth}px; min-width: ${weekWidth}px; max-width: ${weekWidth}px; padding: ${headerPadding}; text-align: center; border: 1px solid var(--border); border-left: 2px solid var(--accent); font-size: ${headerFontSize}; font-weight: 600; background: ${weekHeaderBg}; display: flex; align-items: center; justify-content: center;">${isVerySmall ? 'V' : 'VECKA'} ${w}</div>
                        `;
                    }
                    
                    html += `
                                </div>
                                <!-- Data rows with flex layout -->
                                <div>
                    `;
                    
                    visibleExercisesDesktop.forEach((exercise, visibleIndex) => {
                        const exIndex = day.exercises.indexOf(exercise);
                        const isActive = activeExercises[`${dayIndex}-${exIndex}`];
                        const exerciseSets = exercise.sets;
                        const cellWidth = weekWidth / exerciseSets; // Each cell expands to fill weekWidth evenly
                        const inputWidth = isVerySmall ? Math.min(cellWidth / 2.8, 32) : (isMobile ? Math.min(cellWidth / 2.5, 40) : cellWidth / 2.2);
                        const rowHeight = isVerySmall ? '50px' : (isMobile ? '55px' : '80px');
                        const fontSize = isVerySmall ? '0.65rem' : (isMobile ? '0.7rem' : '0.85rem');
                        
                        html += `<div style="display: flex; height: ${rowHeight};">`;
                        
                        for (let w = 1; w <= program.weeksCount; w++) {
                            const weekData = program.weeks[w - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
                            const isCurrentWeek = w === currentWeek;
                            const sets = weekData.sets || {};
                            
                            // Check if exercise should show for this week (also respect addedAtWeek)
                            const showForThisWeek = (!exercise.weekOnly || exercise.weekOnly === w) && 
                                                    (!exercise.addedAtWeek || exercise.addedAtWeek <= w);
                            
                            if (!showForThisWeek) {
                                // Empty placeholder for weeks where exercise doesn't exist
                                html += `<div style="display: flex; width: ${weekWidth}px; min-width: ${weekWidth}px; background: rgba(50, 50, 50, 0.2);">`;
                                for (let s = 0; s < exerciseSets; s++) {
                                    html += `<div style="width: ${cellWidth}px; height: ${rowHeight}; border: 1px solid var(--border);"></div>`;
                                }
                                html += `</div>`;
                                continue;
                            }
                            
                            html += `<div style="display: flex; width: ${weekWidth}px; min-width: ${weekWidth}px;">`;
                            
                            // Render actual sets
                            for (let s = 0; s < exerciseSets; s++) {
                                const set = sets[s];
                                const isFirstSetOfWeek = s === 0;
                                const borderLeftStyle = isFirstSetOfWeek ? '3px solid var(--accent)' : '1px solid var(--border)';
                                
                                // Zebra striping for sets (subtle difference)
                                const isOddSet = s % 2 === 0;
                                
                                // Alternating background for each week WITH zebra striping
                                const weekBgBase = w % 2 === 1 
                                    ? (isOddSet ? 'rgba(10, 14, 39, 0.35)' : 'rgba(10, 14, 39, 0.25)')
                                    : (isOddSet ? 'rgba(20, 24, 49, 0.35)' : 'rgba(20, 24, 49, 0.25)');
                                const weekBgCurrent = w % 2 === 1 
                                    ? (isOddSet ? 'rgba(0, 229, 160, 0.07)' : 'rgba(0, 229, 160, 0.03)')
                                    : (isOddSet ? 'rgba(0, 229, 160, 0.10)' : 'rgba(0, 229, 160, 0.06)');
                                const weekBgActive = w % 2 === 1 
                                    ? (isOddSet ? 'rgba(0, 229, 160, 0.18)' : 'rgba(0, 229, 160, 0.12)')
                                    : (isOddSet ? 'rgba(0, 229, 160, 0.21)' : 'rgba(0, 229, 160, 0.15)');
                                    
                                const setKey = `${dayIndex}-${exIndex}-${s}`;
                                const isActiveSet = activeSet === setKey;
                                const cellPadding = isVerySmall ? '0.15rem' : (isMobile ? '0.2rem' : '0.5rem');
                                const inputPadding = isVerySmall ? '0.2rem' : (isMobile ? '0.25rem' : '0.4rem');
                                
                                if (set) {
                                    // Check if this is the active set for editing
                                    if (isCurrentWeek && isActive && isActiveSet) {
                                        // Show inputs with existing values for editing
                                        html += `
                                            <div style="padding: ${cellPadding}; border: 1px solid var(--border); border-left: ${borderLeftStyle}; background: ${weekBgActive}; text-align: center; height: ${rowHeight}; vertical-align: middle; width: ${cellWidth}px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;">
                                                ${set ? `<button onclick="window.clearSet(${dayIndex}, ${exIndex}, ${w}, ${s}); event.stopPropagation();" style="position: absolute; top: 1px; right: 1px; background: rgba(255, 80, 80, 0.8); border: none; color: white; font-size: 0.5rem; padding: 1px 3px; border-radius: 2px; cursor: pointer; font-weight: 600;">√ó</button>` : ''}
                                                <div style="display: flex; gap: 0.1rem; justify-content: center;">
                                                    <input type="number" 
                                                           id="weight-${dayIndex}-${exIndex}-${s}" 
                                                           placeholder="0 kg"
                                                           value="${set ? set.weight : ''}"
                                                           step="0.5" 
                                                           min="0" 
                                                           max="200"
                                                           onkeypress="if(event.key==='Enter'){document.getElementById('reps-${dayIndex}-${exIndex}-${s}').focus()}"
                                                           style="width: ${inputWidth}px; padding: ${inputPadding}; background: var(--surface); border: 1px solid var(--accent); border-radius: 3px; color: var(--text); text-align: center; font-size: ${fontSize};"
                                                           autofocus>
                                                    <input type="number" 
                                                           id="reps-${dayIndex}-${exIndex}-${s}" 
                                                           placeholder="r"
                                                           value="${set ? set.reps : ''}"
                                                           min="1" 
                                                           max="999"
                                                           onkeypress="if(event.key==='Enter'){window.logSetAtPosition(${dayIndex}, ${exIndex}, ${s})}"
                                                           style="width: ${inputWidth}px; padding: ${inputPadding}; background: var(--surface); border: 1px solid var(--accent); border-radius: 3px; color: var(--text); text-align: center; font-size: ${fontSize};">
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        // Show logged set as compact format
                                        const loggedFontSize = isVerySmall ? '0.6rem' : (isMobile ? '0.65rem' : '0.95rem');
                                        
                                        // Different styling for current vs other weeks
                                        const loggedBg = isCurrentWeek ? 'rgba(0, 229, 160, 0.12)' : 'rgba(0, 229, 160, 0.05)';
                                        const loggedInnerBg = isCurrentWeek ? 'rgba(0, 229, 160, 0.15)' : 'rgba(0, 229, 160, 0.08)';
                                        const loggedTextColor = isCurrentWeek ? 'rgba(0, 255, 180, 1)' : 'rgba(0, 229, 160, 0.5)';
                                        
                                        html += `
                                            <div style="padding: ${cellPadding}; border: 1px solid var(--border); border-left: ${borderLeftStyle}; background: ${loggedBg}; text-align: center; height: ${rowHeight}; vertical-align: middle; width: ${cellWidth}px; ${isCurrentWeek ? 'cursor: pointer;' : ''} position: relative; display: flex; align-items: center; justify-content: center;" ${isCurrentWeek ? `onclick="window.activateExerciseAndSet(${dayIndex}, ${exIndex}, ${s})"` : ''}>
                                                <div style="display: flex; align-items: center; justify-content: center; padding: ${isVerySmall ? '0.15rem' : '0.25rem'}; background: ${loggedInnerBg}; border-radius: 4px;">
                                                    <span style="font-size: ${loggedFontSize}; font-weight: 600; color: ${loggedTextColor};">${set.weight}√ó${set.reps}</span>
                                                </div>
                                            </div>
                                        `;
                                    }
                                } else if (isCurrentWeek && isActive && isActiveSet) {
                                    // Show input only for the specific active set (empty or for logging)
                                    html += `
                                        <div style="padding: ${cellPadding}; border: 1px solid var(--border); border-left: ${borderLeftStyle}; background: ${weekBgActive}; text-align: center; height: ${rowHeight}; vertical-align: middle; width: ${cellWidth}px; display: flex; align-items: center; justify-content: center;">
                                            <div style="display: flex; gap: 0.1rem; justify-content: center;">
                                                <input type="number" 
                                                       id="weight-${dayIndex}-${exIndex}-${s}" 
                                                       placeholder="0 kg"
                                                       step="0.5" 
                                                       min="0" 
                                                       max="200"
                                                       onkeypress="if(event.key==='Enter'){const repsInput = document.getElementById('reps-${dayIndex}-${exIndex}-${s}'); if(repsInput.value){window.logSetAtPosition(${dayIndex}, ${exIndex}, ${s}); return false;}else{repsInput.focus(); return false;}}"
                                                       style="width: ${inputWidth}px; padding: ${isMobile ? '0.3rem' : '0.4rem'}; background: var(--surface); border: 1px solid var(--accent); border-radius: 4px; color: var(--text); text-align: center; font-size: ${isMobile ? '0.75rem' : '0.85rem'};"
                                                       autofocus>
                                                <input type="number" 
                                                       id="reps-${dayIndex}-${exIndex}-${s}" 
                                                       placeholder="r"
                                                       min="1" 
                                                       max="999"
                                                       onkeypress="if(event.key==='Enter'){window.logSetAtPosition(${dayIndex}, ${exIndex}, ${s}); return false;}"
                                                       style="width: ${inputWidth}px; padding: ${inputPadding}; background: var(--surface); border: 1px solid var(--accent); border-radius: 3px; color: var(--text); text-align: center; font-size: ${fontSize};">
                                            </div>
                                        </div>
                                    `;
                                } else if (isCurrentWeek) {
                                    // Empty clickable cell - clean, no hint text
                                    html += `
                                        <div style="padding: ${cellPadding}; border: 1px solid var(--border); border-left: ${borderLeftStyle}; background: ${isActive ? weekBgCurrent : weekBgBase}; height: ${rowHeight}; cursor: pointer; text-align: center; width: ${cellWidth}px; display: flex; align-items: center; justify-content: center;" onclick="window.activateExerciseAndSet(${dayIndex}, ${exIndex}, ${s})">
                                        </div>
                                    `;
                                } else {
                                    // Empty cells (non-current week) - no SET number
                                    html += `
                                        <div style="padding: ${cellPadding}; border: 1px solid var(--border); border-left: ${borderLeftStyle}; background: ${weekBgBase}; height: ${rowHeight}; width: ${cellWidth}px;">
                                        </div>
                                    `;
                                }
                            }
                            html += `</div>`; // Close week div
                        }
                        
                        html += `</div>`; // Close row div
                    });
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add exercise button below exercises - always visible but subtle in client mode
                    if (ptMode) {
                        html += `
                            <div onclick="window.openExerciseModal(${dayIndex})" style="margin-top: 0.75rem; padding: 0.75rem; border: 2px dashed var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: var(--text-muted); transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)';" onmouseleave="this.style.borderColor='var(--border)'; this.style.color='var(--text-muted)';">
                                <span style="font-size: 1.1rem;">+</span>
                                <span style="font-size: 0.85rem;">L√§gg till √∂vning</span>
                            </div>
                        `;
                    } else {
                        // Klientl√§ge - mycket diskret
                        html += `
                            <div onclick="window.openExerciseModal(${dayIndex})" style="margin-top: 0.5rem; padding: 0.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.3rem; color: var(--text-muted); opacity: 0.4; font-size: 0.75rem; transition: opacity 0.2s;" onmouseenter="this.style.opacity='0.8';" onmouseleave="this.style.opacity='0.4';">
                                <span>+</span>
                                <span>L√§gg till √∂vning</span>
                            </div>
                        `;
                    }
                }
                
                html += `</div></div>`;
            });
            
            // Check permissions
            const canAddDay = currentProfile?.type !== 'client' && ptMode;
            
            // L√§gg till dag-knapp efter alla dagar - tydligt separerad
            if (canSaveAsTemplate || canAddDay) {
                html += `<div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">`;
                
                // Spara som mall knapp
                if (canSaveAsTemplate) {
                    html += `
                        <div onclick="window.saveProgramAsTemplate()" style="padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: var(--text-muted); margin-bottom: 0.75rem; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)';" onmouseleave="this.style.borderColor='var(--border)'; this.style.color='var(--text-muted)';">
                            <span style="font-size: 1.1rem;">üíæ</span>
                            <span style="font-size: 0.95rem;">Spara som mall</span>
                        </div>
                    `;
                }
                
                // Nytt tr√§ningspass knapp
                if (canAddDay) {
                    html += `
                        <div onclick="window.addDay()" style="padding: 1.25rem; background: rgba(0, 229, 160, 0.05); border: 1px solid rgba(0, 229, 160, 0.2); border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.6rem; color: var(--accent); transition: all 0.2s;" onmouseenter="this.style.background='rgba(0, 229, 160, 0.1)'; this.style.borderColor='var(--accent)';" onmouseleave="this.style.background='rgba(0, 229, 160, 0.05)'; this.style.borderColor='rgba(0, 229, 160, 0.2)';">
                            <span style="font-size: 1.3rem;">+</span>
                            <span style="font-size: 1rem; font-weight: 500;">Nytt tr√§ningspass</span>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            html += `</div>`;
            
            appContent.innerHTML = html;
        }
        
        // Create program data for step flow
        let createProgramData = {
            gender: '',
            level: '',
            daysPerWeek: 0,
            weeks: 8,
            name: ''
        };
        
        function openCreateModal() {
            // Reset to step 1
            for (let i = 1; i <= 6; i++) {
                const step = document.getElementById(`createStep${i}`);
                if (step) step.style.display = i === 1 ? 'block' : 'none';
            }
            
            // Reset data
            createProgramData = { gender: '', level: '', daysPerWeek: 0, weeks: 8, name: '' };
            
            // Clear inputs
            document.getElementById('programName').value = '';
            document.getElementById('customWeeksInput').value = '';
            document.getElementById('customWeeksBtn').style.display = 'none';
            
            // Update template count
            updateTemplateCount();
            
            createModal.classList.add('show');
        }
        
        function goToCreateStep(step) {
            for (let i = 1; i <= 6; i++) {
                const el = document.getElementById(`createStep${i}`);
                if (el) el.style.display = i === step ? 'block' : 'none';
            }
            updateCreateDisplays();
            updateTemplateCount();
        }
        
        function updateCreateDisplays() {
            
            const genderText = createProgramData.gender || '';
            
            ['selectedGenderDisplay', 'selectedGenderDisplay2', 'selectedGenderDisplay3', 'selectedGenderDisplay4', 'selectedGenderDisplay5'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = genderText;
            });
            
            ['selectedLevelDisplay', 'selectedLevelDisplay2', 'selectedLevelDisplay3', 'selectedLevelDisplay4'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = createProgramData.level;
            });
            
            const daysText = createProgramData.daysPerWeek ? `${createProgramData.daysPerWeek} dagar/v` : '';
            ['selectedDaysDisplay', 'selectedDaysDisplay2', 'selectedDaysDisplay3'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = daysText;
            });
            
            const weeksText = createProgramData.weeks ? `${createProgramData.weeks} veckor` : '';
            ['selectedWeeksDisplay', 'selectedWeeksDisplay2'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = weeksText;
            });
        }
        
        function updateTemplateCount() {
            const count = getMatchingTemplateCount();
            ['modalLibraryCount', 'matchingTemplatesCount'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = count;
            });
        }
        
        function getMatchingTemplateCount() {
            const templates = storage.load('programTemplates') || [];
            return templates.filter(t => {
                if (createProgramData.gender && t.gender !== createProgramData.gender) return false;
                if (createProgramData.level && t.level !== createProgramData.level) return false;
                if (createProgramData.daysPerWeek && t.days && t.days.length !== createProgramData.daysPerWeek) return false;
                return true;
            }).length;
        }
        
        function selectGenderAndNext(gender) {
            createProgramData.gender = gender;
            document.getElementById('programGender').value = gender;
            goToCreateStep(2);
        }
        
        function selectLevelAndNext(level) {
            createProgramData.level = level;
            document.getElementById('programLevel').value = level;
            goToCreateStep(3);
        }
        
        function selectDaysAndNext(days) {
            createProgramData.daysPerWeek = days;
            document.getElementById('programDaysPerWeek').value = days;
            goToCreateStep(4);
        }
        
        function selectWeeksAndNext(weeks) {
            createProgramData.weeks = weeks;
            document.getElementById('weeksCount').value = weeks;
            goToCreateStep(5);
        }
        
        function checkCustomWeeks() {
            const weeks = document.getElementById('customWeeksInput').value;
            const btn = document.getElementById('customWeeksBtn');
            btn.style.display = weeks && parseInt(weeks) > 0 ? 'block' : 'none';
        }
        
        function goToCreateStep5WithCustomWeeks() {
            const weeks = parseInt(document.getElementById('customWeeksInput').value);
            if (weeks > 0) {
                selectWeeksAndNext(weeks);
            }
        }
        
        function checkProgramName() {
            const name = document.getElementById('programName').value.trim();
            const btn = document.getElementById('createProgramBtn');
            if (btn) {
                btn.style.display = name ? 'block' : 'none';
            }
        }
        
        function createProgramFromSteps() {
            const name = document.getElementById('programName').value.trim();
            if (!name) {
                alert('Ange ett namn f√∂r programmet');
                return;
            }
            
            createProgramData.name = name;
            
            // Fallbacks if somehow steps were skipped
            const daysCount = createProgramData.daysPerWeek || 3;
            const weeksCount = createProgramData.weeks || 8;
            
            // Create empty days based on daysPerWeek
            const days = [];
            const dayNames = ['Dag 1', 'Dag 2', 'Dag 3', 'Dag 4', 'Dag 5', 'Dag 6', 'Dag 7'];
            for (let i = 0; i < daysCount; i++) {
                days.push({
                    name: dayNames[i],
                    exercises: []
                });
            }
            
            // Create weeks with empty workout data
            const weeks = [];
            for (let w = 0; w < weeksCount; w++) {
                const workouts = [];
                for (let d = 0; d < daysCount; d++) {
                    workouts.push({
                        completed: false,
                        logs: {}
                    });
                }
                weeks.push({ workouts });
            }
            
            const newProgram = {
                name: createProgramData.name,
                gender: createProgramData.gender || '',
                level: createProgramData.level || '',
                days: days,
                weeks: weeks,
                weeksCount: weeksCount,
                lastActivity: null
            };
            
            programs.push(newProgram);
            storage.save('programs', programs);
            
            createModal.classList.remove('show');
            currentProgram = programs.length - 1;
            currentWeek = 1;
            render();
        }
        
        function openTemplateLibraryFromCreate() {
            // Store current filters
            const searchInput = document.getElementById('templateSearchInput');
            if (searchInput) searchInput.value = '';
            
            populateTemplateLibrary();
            templateLibraryModal.classList.add('show');
        }
        
        function filterTemplates() {
            populateTemplateLibrary();
        }
        
        // Export create modal functions
        window.selectGenderAndNext = selectGenderAndNext;
        window.selectLevelAndNext = selectLevelAndNext;
        window.selectDaysAndNext = selectDaysAndNext;
        window.selectWeeksAndNext = selectWeeksAndNext;
        window.checkCustomWeeks = checkCustomWeeks;
        window.goToCreateStep5WithCustomWeeks = goToCreateStep5WithCustomWeeks;
        window.checkProgramName = checkProgramName;
        window.createProgramFromSteps = createProgramFromSteps;
        window.goToCreateStep = goToCreateStep;
        window.openTemplateLibraryFromCreate = openTemplateLibraryFromCreate;
        window.filterTemplates = filterTemplates;
        
        function openExerciseModal(dayIndex) {
            currentDay = dayIndex;
            
            // Reset to step 1
            document.getElementById('exerciseStep1').style.display = 'block';
            document.getElementById('exerciseStep2').style.display = 'none';
            document.getElementById('exerciseStep3').style.display = 'none';
            
            // Reset modal state - close library if open
            const library = document.getElementById('exerciseLibrary');
            const toggleIcon = document.getElementById('libraryToggleIcon');
            const toggleBtn = document.getElementById('toggleLibraryBtn');
            
            if (library) {
                library.style.display = 'none';
            }
            if (toggleIcon) {
                toggleIcon.textContent = 'üìö';
            }
            if (toggleBtn) {
                toggleBtn.style.background = 'var(--surface-elevated)';
                toggleBtn.style.borderColor = 'var(--accent)';
                toggleBtn.style.color = 'var(--text)';
            }
            
            // Clear input fields
            const exerciseName = document.getElementById('exerciseName');
            const exerciseReps = document.getElementById('exerciseReps');
            const saveToLibrary = document.getElementById('saveToLibrary');
            const step1NextBtn = document.getElementById('step1NextBtn');
            const customRepsBtn = document.getElementById('customRepsBtn');
            
            if (exerciseName) exerciseName.value = '';
            if (exerciseReps) exerciseReps.value = '';
            if (saveToLibrary) saveToLibrary.checked = false;
            if (step1NextBtn) step1NextBtn.style.display = 'none';
            if (customRepsBtn) customRepsBtn.style.display = 'none';
            
            // Reset selected data
            selectedExerciseData = { name: '', muscleGroup: '', reps: '', sets: 3, isBatch: false, isManualEntry: false };
            
            // Reset reps buttons
            document.querySelectorAll('.reps-btn').forEach(btn => {
                btn.style.background = 'var(--surface-elevated)';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'var(--text)';
            });
            
            // Reset all weeks toggle to default (on) and update label
            addToAllWeeks = true;
            updateAllWeeksToggle();
            
            exerciseModal.classList.add('show');
        }
        
        // Step navigation functions
        function checkExerciseName() {
            const name = document.getElementById('exerciseName').value.trim();
            const step1NextBtn = document.getElementById('step1NextBtn');
            if (name.length > 0) {
                step1NextBtn.style.display = 'block';
            } else {
                step1NextBtn.style.display = 'none';
            }
        }
        
        function toggleExerciseLibrary() {
            const library = document.getElementById('exerciseLibrary');
            const isVisible = library.style.display !== 'none';
            
            // I fri tr√§ning - biblioteket kan inte st√§ngas (alltid √∂ppet)
            if (isVisible && (currentDay === 'free' || freeTrainingMode)) {
                return; // G√∂r ingenting - kan inte st√§nga
            }
            
            library.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // √ñppnar biblioteket - alltid aktivera select mode
                exerciseSelectMode = true;
                selectedExercises = [];
                
                // Visa selected bar med disabled knapp
                const selectedBar = document.getElementById('selectedExercisesBar');
                const proceedBtn = document.getElementById('proceedSelectedBtn');
                if (selectedBar) {
                    selectedBar.style.display = 'block';
                    document.getElementById('selectedCount').textContent = 'V√§lj √∂vningar (max 10)';
                }
                if (proceedBtn) {
                    proceedBtn.disabled = true;
                    proceedBtn.style.opacity = '0.5';
                    proceedBtn.style.cursor = 'not-allowed';
                }
                
                populateExerciseLibrary();
            } else {
                // St√§nger biblioteket - √•terst√§ll
                exerciseSelectMode = false;
                selectedExercises = [];
                const selectedBar = document.getElementById('selectedExercisesBar');
                if (selectedBar) selectedBar.style.display = 'none';
            }
        }
        
        function goToStep1() {
            document.getElementById('exerciseStep1').style.display = 'block';
            document.getElementById('exerciseStep1b').style.display = 'none';
            document.getElementById('exerciseStep2').style.display = 'none';
            document.getElementById('exerciseStep3').style.display = 'none';
            
            // Visa modal-header igen
            const modalHeader = document.getElementById('exerciseModalHeader');
            if (modalHeader) modalHeader.style.display = 'flex';
        }
        
        function goToStep2() {
            const name = document.getElementById('exerciseName').value.trim();
            if (!name) {
                alert('Ange √∂vningsnamn');
                return;
            }
            selectedExerciseData.name = name;
            selectedExerciseData.isManualEntry = true; // Markera som manuellt inmatad
            
            // Go to muscle group selection for manual entry
            document.getElementById('selectedExerciseNameMuscle').textContent = name;
            document.getElementById('exerciseStep1').style.display = 'none';
            document.getElementById('exerciseStep1b').style.display = 'block';
            document.getElementById('exerciseStep2').style.display = 'none';
            document.getElementById('exerciseStep3').style.display = 'none';
        }
        
        function selectMuscleGroup(muscleGroup) {
            selectedExerciseData.muscleGroup = muscleGroup;
            
            // Now go to reps step
            document.getElementById('selectedExerciseName').textContent = selectedExerciseData.name;
            document.getElementById('exerciseStep1').style.display = 'none';
            document.getElementById('exerciseStep1b').style.display = 'none';
            document.getElementById('exerciseStep3').style.display = 'none';
            
            // Visa r√§tt UI baserat p√• sk√§rmstorlek
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Visa fullscreen picker p√• mobil
                showMobileRepsSetPicker();
            } else {
                // Desktop - visa i modal
                const step2 = document.getElementById('exerciseStep2');
                const mobileRepsSetPicker = document.getElementById('mobileRepsSetPicker');
                const desktopRepsPicker = document.getElementById('desktopRepsPicker');
                const modalHeader = document.getElementById('exerciseModalHeader');
                
                step2.style.display = 'block';
                if (mobileRepsSetPicker) mobileRepsSetPicker.style.display = 'none';
                if (desktopRepsPicker) desktopRepsPicker.style.display = 'block';
                if (modalHeader) modalHeader.style.display = 'flex';
                
                // Reset reps input
                document.getElementById('exerciseReps').value = '';
                document.getElementById('customRepsBtn').style.display = 'none';
            }
        }
        
        window.selectMuscleGroup = selectMuscleGroup;
        
        function checkCustomReps() {
            const reps = document.getElementById('exerciseReps').value.trim();
            const customRepsBtn = document.getElementById('customRepsBtn');
            if (reps.length > 0) {
                customRepsBtn.style.display = 'block';
            } else {
                customRepsBtn.style.display = 'none';
            }
        }
        
        function selectRepsAndContinue(reps) {
            selectedExerciseData.reps = reps;
            goToStep3();
        }
        
        function goToStep3() {
            const customReps = document.getElementById('exerciseReps').value.trim();
            if (customReps) {
                selectedExerciseData.reps = customReps;
            }
            
            if (!selectedExerciseData.reps) {
                alert('V√§lj reps');
                return;
            }
            
            document.getElementById('selectedExerciseName2').textContent = selectedExerciseData.name;
            document.getElementById('selectedReps').textContent = selectedExerciseData.reps;
            
            // Reset custom sets input
            const customSetsInput = document.getElementById('customSetsInput');
            const customSetsBtn = document.getElementById('customSetsBtn');
            if (customSetsInput) customSetsInput.value = '';
            if (customSetsBtn) customSetsBtn.style.display = 'none';
            
            document.getElementById('exerciseStep1').style.display = 'none';
            document.getElementById('exerciseStep2').style.display = 'none';
            document.getElementById('exerciseStep3').style.display = 'block';
        }
        
        function selectSetsAndAdd(sets) {
            selectedExerciseData.sets = sets;
            
            // P√• mobil: skapa temp input och fokusera INNAN vi st√§nger modalen
            // Detta beh√•ller tangentbordet √∂ppet
            const isMobile = window.innerWidth <= 768;
            if (isMobile && (currentDay === 'free' || freeTrainingMode)) {
                // Skapa och fokusera en tempor√§r input f√∂r att h√•lla tangentbordet √∂ppet
                let tempInput = document.getElementById('tempFocusInput');
                if (!tempInput) {
                    tempInput = document.createElement('input');
                    tempInput.id = 'tempFocusInput';
                    tempInput.type = 'number';
                    tempInput.inputMode = 'decimal';
                    tempInput.style.cssText = 'position: fixed; bottom: 50%; left: 50%; width: 1px; height: 1px; opacity: 0; pointer-events: none;';
                    document.body.appendChild(tempInput);
                }
                tempInput.focus();
            }
            
            addExerciseFromSteps();
        }
        
        function checkCustomSets() {
            const sets = parseInt(document.getElementById('customSetsInput').value);
            const customSetsBtn = document.getElementById('customSetsBtn');
            if (sets && sets > 0 && sets <= 10) {
                customSetsBtn.style.display = 'block';
            } else {
                customSetsBtn.style.display = 'none';
            }
        }
        
        function addWithCustomSets() {
            const sets = parseInt(document.getElementById('customSetsInput').value);
            if (sets && sets > 0 && sets <= 10) {
                selectedExerciseData.sets = sets;
                addExerciseFromSteps();
            } else {
                alert('Antal set m√•ste vara mellan 1 och 10');
            }
        }
        
        function addExerciseFromSteps() {
            // Check if this is a batch add
            if (selectedExerciseData.isBatch && window.pendingBatchExercises && window.pendingBatchExercises.length > 0) {
                const exercises = window.pendingBatchExercises;
                const reps = selectedExerciseData.reps;
                const sets = selectedExerciseData.sets;
                
                // Check if it's free training mode
                if (currentDay === 'free' || freeTrainingMode) {
                    // Remember the index of the first exercise we're adding
                    let firstExerciseIndex = 0;
                    if (currentFreeDay !== 'new' && freeTrainingDays[currentFreeDay]) {
                        firstExerciseIndex = freeTrainingDays[currentFreeDay].exercises.length;
                    }
                    
                    // Add all exercises (don't update UI until last one)
                    exercises.forEach((ex, idx) => {
                        addFreeExercise(ex.name, ex.muscleGroup, reps, sets, false); // Don't update UI yet
                    });
                    
                    // Now manually set up UI to show FIRST exercise
                    activeExercises = {};
                    activeExercises[`free-${firstExerciseIndex}`] = true;
                    activeSet = `free-${firstExerciseIndex}-0`;
                    inputStep = 'weight';
                    tempFreeWeight = null;
                    
                    // Reset batch mode
                    window.pendingBatchExercises = null;
                    selectedExerciseData.isBatch = false;
                    exerciseSelectMode = false;
                    selectedExercises = [];
                    
                    resetExerciseModal();
                    exerciseModal.classList.remove('show');
                    render();
                    
                    // Scrolla till toppen och fokusera input
                    setTimeout(() => {
                        // Ta bort temp input om den finns
                        const tempInput = document.getElementById('tempFocusInput');
                        if (tempInput) {
                            tempInput.remove();
                        }
                        
                        // Scrolla content-containern till toppen (inte hela sidan)
                        const container = document.getElementById('content');
                        if (container) {
                            container.scrollTop = 0;
                        }
                        
                        // Fokusera input-f√§ltet
                        setTimeout(() => {
                            const input = document.getElementById(`free-weight-${firstExerciseIndex}`);
                            if (input) {
                                // Anv√§nd preventScroll f√∂r att f√∂rhindra automatisk scroll
                                input.focus({ preventScroll: true });
                            }
                        }, 100);
                    }, 50);
                    return;
                } else if (currentProgram !== null && currentDay !== null) {
                    // Extra bekr√§ftelse i klientl√§ge
                    if (!ptMode) {
                        if (!confirm(`Du √§r p√• v√§g att l√§gga till ${exercises.length} √∂vningar i programmet. √Ñr du s√§ker?`)) {
                            return;
                        }
                    }
                    
                    // Add all exercises to program
                    exercises.forEach(ex => {
                        const newExercise = {
                            name: ex.name,
                            muscleGroup: ex.muscleGroup || '',
                            reps: reps,
                            sets: sets
                        };
                        
                        if (addToAllWeeks) {
                            newExercise.addedAtWeek = currentWeek;
                        } else {
                            newExercise.weekOnly = currentWeek;
                        }
                        
                        programs[currentProgram].days[currentDay].exercises.push(newExercise);
                    });
                    
                    storage.save('programs', programs);
                    
                    // Reset batch mode
                    window.pendingBatchExercises = null;
                    selectedExerciseData.isBatch = false;
                    exerciseSelectMode = false;
                    selectedExercises = [];
                    
                    resetExerciseModal();
                    exerciseModal.classList.remove('show');
                    render();
                    return;
                }
            }
            
            // Normal single exercise add
            const newExercise = {
                name: selectedExerciseData.name,
                muscleGroup: selectedExerciseData.muscleGroup || '',
                reps: selectedExerciseData.reps,
                sets: selectedExerciseData.sets
            };
            
            // Kolla om √∂vningen √§r manuellt inmatad (inte fr√•n bibliotek)
            const isManualEntry = selectedExerciseData.isManualEntry === true;
            const alreadyInLibrary = newExercise.muscleGroup && 
                exerciseLibrary[newExercise.muscleGroup] && 
                exerciseLibrary[newExercise.muscleGroup].includes(newExercise.name);
            
            // Om manuellt inmatad och inte redan i biblioteket - fr√•ga om den ska sparas
            if (isManualEntry && !alreadyInLibrary && newExercise.muscleGroup && newExercise.name) {
                if (confirm(`Vill du spara "${newExercise.name}" i √∂vningsbiblioteket?\n\nD√• kan du snabbt v√§lja den igen n√§sta g√•ng.`)) {
                    if (!exerciseLibrary[newExercise.muscleGroup]) {
                        exerciseLibrary[newExercise.muscleGroup] = [];
                    }
                    exerciseLibrary[newExercise.muscleGroup].push(newExercise.name);
                    saveExerciseLibrary();
                }
            }
            
            // Check if it's free training mode
            if (currentDay === 'free' || freeTrainingMode) {
                // Use addFreeExercise which handles both new and existing days
                addFreeExercise(newExercise.name, newExercise.muscleGroup, newExercise.reps, newExercise.sets);
                resetExerciseModal();
                exerciseModal.classList.remove('show');
                
                // Fokusera input
                setTimeout(() => {
                    const tempInput = document.getElementById('tempFocusInput');
                    if (tempInput) tempInput.remove();
                    
                    // Scrolla content-containern till toppen
                    const container = document.getElementById('content');
                    if (container) {
                        container.scrollTop = 0;
                    }
                    
                    // Hitta den nyaste √∂vningens index och fokusera
                    const exIndex = freeTrainingDays[currentFreeDay].exercises.length - 1;
                    const input = document.getElementById(`free-weight-${exIndex}`);
                    if (input) {
                        input.focus({ preventScroll: true });
                    }
                }, 100);
                return;
            } else if (currentProgram !== null && currentDay !== null) {
                // Extra bekr√§ftelse i klientl√§ge
                if (!ptMode) {
                    if (!confirm('Du √§r p√• v√§g att l√§gga till en √∂vning i programmet. √Ñr du s√§ker?')) {
                        return;
                    }
                }
                
                if (addToAllWeeks) {
                    const exerciseWithMeta = {
                        ...newExercise,
                        addedAtWeek: currentWeek
                    };
                    programs[currentProgram].days[currentDay].exercises.push(exerciseWithMeta);
                } else {
                    const weekSpecificExercise = {
                        ...newExercise,
                        weekOnly: currentWeek
                    };
                    programs[currentProgram].days[currentDay].exercises.push(weekSpecificExercise);
                }
                
                storage.save('programs', programs);
            }
            
            // Save to library if checkbox is checked
            const saveToLibrary = document.getElementById('saveToLibrary');
            if (saveToLibrary && saveToLibrary.checked && selectedExerciseData.muscleGroup) {
                if (!exerciseLibrary[selectedExerciseData.muscleGroup]) {
                    exerciseLibrary[selectedExerciseData.muscleGroup] = [];
                }
                if (!exerciseLibrary[selectedExerciseData.muscleGroup].includes(selectedExerciseData.name)) {
                    exerciseLibrary[selectedExerciseData.muscleGroup].push(selectedExerciseData.name);
                    saveExerciseLibrary();
                }
            }
            
            resetExerciseModal();
            exerciseModal.classList.remove('show');
            
            // Close all exercises and open the new one
            activeExercises = {};
            const newExIndex = programs[currentProgram].days[currentDay].exercises.length - 1;
            activeExercises[`${currentDay}-${newExIndex}`] = true;
            
            // Activate first set for logging
            activeSet = `${currentDay}-${newExIndex}-0`;
            inputStep = 'weight';
            
            render();
        }
        
        // Export new functions
        window.checkExerciseName = checkExerciseName;
        window.toggleExerciseLibrary = toggleExerciseLibrary;
        window.goToStep1 = goToStep1;
        window.goToStep2 = goToStep2;
        window.goToStep3 = goToStep3;
        window.checkCustomReps = checkCustomReps;
        window.selectRepsAndContinue = selectRepsAndContinue;
        window.selectSetsAndAdd = selectSetsAndAdd;
        window.checkCustomSets = checkCustomSets;
        window.addWithCustomSets = addWithCustomSets;
        
        function toggleProgramListEditMode() {
            programListEditMode = !programListEditMode;
            render();
        }
        
        function renameProgramInline(index, newName) {
            if (newName && newName.trim()) {
                programs[index].name = newName.trim();
                storage.save('programs', programs);
                render();
            }
        }
        
        function deleteProgram(index) {
            if (confirm(`√Ñr du s√§ker p√• att du vill radera "${programs[index].name}"? Detta g√•r inte att √•ngra.`)) {
                programs.splice(index, 1);
                storage.save('programs', programs);
                
                // If we deleted the currently open program, close it
                if (currentProgram === index) {
                    currentProgram = null;
                } else if (currentProgram > index) {
                    // Adjust current program index if needed
                    currentProgram--;
                }
                
                render();
            }
        }
        
        function openProgram(index) {
            currentProgram = index;
            currentWeek = 1;
            editModes = {}; // Reset edit modes
            
            // Set all days to collapsed by default
            const program = programs[index];
            collapsedDays = {};
            program.days.forEach((day, i) => {
                collapsedDays[i] = true;
            });
            
            render();
        }
        
        function saveProgramAsTemplate() {
            const program = programs[currentProgram];
            
            // Only prompt for name
            const name = prompt('Namn p√• mallen:', program.name || '');
            if (!name || !name.trim()) {
                return;
            }
            
            // Create a clean template without logged data
            // Use program's existing categories or defaults
            const template = {
                name: name.trim(),
                gender: program.gender || '',
                type: program.type || '',
                level: program.level || '',
                days: program.days.map(day => ({
                    name: day.name,
                    exercises: day.exercises.map(ex => ({
                        name: ex.name,
                        muscleGroup: ex.muscleGroup,
                        reps: ex.reps,
                        sets: ex.sets
                    }))
                })),
                weeksCount: program.weeksCount
            };
            
            // Check if template with same name exists
            const existingIndex = programTemplates.findIndex(t => t.name === template.name);
            
            if (existingIndex >= 0) {
                if (confirm(`En mall med namnet "${name}" finns redan. Vill du skriva √∂ver den?`)) {
                    programTemplates[existingIndex] = template;
                } else {
                    return;
                }
            } else {
                programTemplates.push(template);
            }
            
            storage.save('programTemplates', programTemplates);
            alert(`‚úÖ Mallen "${template.name}" sparad!`);
        }
        
        function closeProgram() {
            currentProgram = null;
            currentMobileDay = null;
            render();
        }
        
        function selectWeek(week) {
            currentWeek = week;
            render();
            
            // Scroll to the selected week
            setTimeout(() => {
                const program = programs[currentProgram];
                if (!program) return;
                
                // Calculate scroll position based on week
                // Each week is 600px wide (fixed)
                const weekWidth = 600;
                const targetScroll = (week - 1) * weekWidth;
                
                // Scroll all day containers
                document.querySelectorAll('[data-scroll-container]').forEach(container => {
                    container.scrollTo({
                        left: targetScroll,
                        behavior: 'smooth'
                    });
                });
            }, 100);
        }
        
        function addWeek() {
            const program = programs[currentProgram];
            program.weeksCount++;
            program.weeks.push({
                workouts: program.days.map(() => ({ logs: [] }))
            });
            storage.save('programs', programs);
            render();
        }
        
        function logSet(dayIndex, exIndex) {
            const program = programs[currentProgram];
            const weightInput = document.getElementById(`weight-${dayIndex}-${exIndex}`);
            const repsInput = document.getElementById(`reps-${dayIndex}-${exIndex}`);
            
            if (!weightInput || !repsInput) {
                alert('Fel vid inmatning');
                return;
            }
            
            const weight = parseFloat(weightInput.value);
            const reps = parseInt(repsInput.value);
            
            if (isNaN(weight) || weight < 0) {
                alert('Ange vikt (0 eller mer)');
                return;
            }
            
            if (!reps || reps <= 0) {
                alert('Ange reps');
                return;
            }
            
            if (!program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex]) {
                program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] = { sets: {} };
            }
            
            const logs = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex];
            if (!logs.sets) {
                logs.sets = {};
            }
            
            // Find the next available set number
            let nextSetNum = 0;
            while (logs.sets[nextSetNum] !== undefined) {
                nextSetNum++;
            }
            
            logs.sets[nextSetNum] = {
                weight,
                reps
            };
            
            storage.save('programs', programs);
            render();
        }
        
        function clearSet(dayIndex, exIndex, weekIndex, setPosition) {
            const program = programs[currentProgram];
            
            if (!program.weeks[weekIndex - 1].workouts[dayIndex].logs[exIndex]) {
                return;
            }
            
            const logs = program.weeks[weekIndex - 1].workouts[dayIndex].logs[exIndex];
            if (logs.sets && logs.sets[setPosition]) {
                delete logs.sets[setPosition];
                storage.save('programs', programs);
            }
            
            activeSet = null;
            render();
        }
        
        function logSetAtPosition(dayIndex, exIndex, setPosition) {
            const program = programs[currentProgram];
            const weightInput = document.getElementById(`weight-${dayIndex}-${exIndex}-${setPosition}`);
            const repsInput = document.getElementById(`reps-${dayIndex}-${exIndex}-${setPosition}`);
            
            if (!weightInput || !repsInput) {
                alert('Fel vid inmatning');
                return;
            }
            
            const weight = parseFloat(weightInput.value);
            const reps = parseInt(repsInput.value);
            
            // If both fields are empty, delete the set
            if ((weightInput.value === '' || isNaN(weight)) && (repsInput.value === '' || isNaN(reps))) {
                if (!program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex]) {
                    program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] = { sets: {} };
                }
                const logs = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex];
                if (logs.sets && logs.sets[setPosition]) {
                    delete logs.sets[setPosition];
                    storage.save('programs', programs);
                }
                activeSet = null;
                render();
                return;
            }
            
            if (isNaN(weight) || weight < 0 || weight > 999) {
                alert('Vikt m√•ste vara mellan 0 och 999 kg');
                return;
            }
            
            if (!reps || reps <= 0 || reps > 999) {
                alert('Reps m√•ste vara mellan 1 och 999');
                return;
            }
            
            if (!program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex]) {
                program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] = { sets: {} };
            }
            
            const logs = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex];
            if (!logs.sets) {
                logs.sets = {};
            }
            
            // Log at specific position
            logs.sets[setPosition] = {
                weight,
                reps
            };
            
            // Update last activity date for the program
            program.lastActivity = new Date().toISOString();
            
            storage.save('programs', programs);
            
            // Create temp input IMMEDIATELY to keep keyboard open
            const tempInput = document.createElement('input');
            tempInput.type = 'number';
            tempInput.inputMode = 'decimal';
            tempInput.style.cssText = 'position: fixed; top: 50%; left: 50%; width: 1px; height: 1px; opacity: 0; pointer-events: none; z-index: 9999;';
            document.body.appendChild(tempInput);
            tempInput.focus();
            
            // Find next empty set using exercise.sets
            const exercise = program.days[dayIndex].exercises[exIndex];
            const exerciseSets = Math.max(exercise.sets, 3);
            let nextEmptySet = setPosition + 1;
            while (nextEmptySet < exerciseSets && logs.sets[nextEmptySet] !== undefined) {
                nextEmptySet++;
            }
            
            // If there's a next empty set, activate it; otherwise move to next exercise
            if (nextEmptySet < exerciseSets) {
                activeSet = `${dayIndex}-${exIndex}-${nextEmptySet}`;
                inputStep = 'weight'; // Start fresh with weight input for new set
            } else {
                // All sets done for this exercise - close it and find next incomplete exercise
                activeSet = null;
                delete activeExercises[`${dayIndex}-${exIndex}`];
                
                // Find next incomplete exercise in this day
                const day = program.days[dayIndex];
                const visibleExercises = day.exercises.filter(ex => {
                    const showForWeek = !ex.weekOnly || ex.weekOnly === currentWeek;
                    const wasAddedBeforeOrAtWeek = !ex.addedAtWeek || ex.addedAtWeek <= currentWeek;
                    return showForWeek && wasAddedBeforeOrAtWeek;
                });
                
                let foundNext = false;
                for (let i = 0; i < visibleExercises.length; i++) {
                    const nextEx = visibleExercises[i];
                    const nextExIndex = day.exercises.indexOf(nextEx);
                    
                    // Skip current exercise
                    if (nextExIndex === exIndex) continue;
                    
                    // Check if this exercise is incomplete
                    const nextLogs = program.weeks[currentWeek - 1].workouts[dayIndex].logs[nextExIndex] || { sets: {} };
                    const nextSets = nextLogs.sets || {};
                    let completedCount = 0;
                    for (let s = 0; s < nextEx.sets; s++) {
                        if (nextSets[s]) completedCount++;
                    }
                    
                    if (completedCount < nextEx.sets) {
                        // Found incomplete exercise - open it and activate first empty set
                        activeExercises = {};
                        activeExercises[`${dayIndex}-${nextExIndex}`] = true;
                        
                        // Find first empty set
                        for (let s = 0; s < nextEx.sets; s++) {
                            if (!nextSets[s]) {
                                activeSet = `${dayIndex}-${nextExIndex}-${s}`;
                                inputStep = 'weight';
                                break;
                            }
                        }
                        foundNext = true;
                        break;
                    }
                }
                
                // If no next exercise found, just close current
                if (!foundNext) {
                    activeExercises = {};
                }
            }
            
            render();
            
            // Focus next input if available
            if (activeSet) {
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        const [d, e, s] = activeSet.split('-').map(Number);
                        const input = document.getElementById(`weight-${d}-${e}-${s}`);
                        if (input) {
                            input.focus();
                            input.click();
                        }
                        if (document.body.contains(tempInput)) {
                            document.body.removeChild(tempInput);
                        }
                    }, 50);
                });
            } else {
                if (document.body.contains(tempInput)) {
                    document.body.removeChild(tempInput);
                }
            }
        }
        
        function addExtraSet(dayIndex, exIndex) {
            // Add an extra logged set WITHOUT changing the target sets
            const program = programs[currentProgram];
            const exercise = program.days[dayIndex].exercises[exIndex];
            const targetSets = exercise.sets; // Keep target unchanged
            
            // Make sure the week data structure exists
            if (!program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex]) {
                program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] = { sets: {} };
            }
            
            // Find the next available set index (could be beyond target)
            const logs = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex];
            if (!logs.sets) logs.sets = {};
            
            let nextSetIndex = 0;
            while (logs.sets[nextSetIndex] !== undefined) {
                nextSetIndex++;
            }
            
            storage.save('programs', programs);
            
            // Activate the new set for input
            inputStep = 'weight';
            activeSet = `${dayIndex}-${exIndex}-${nextSetIndex}`;
            
            render();
            
            setTimeout(() => {
                const input = document.getElementById(`weight-${dayIndex}-${exIndex}-${newSetIndex}`);
                if (input) input.focus();
            }, 100);
        }
        
        function activateSet(dayIndex, exIndex, setPosition) {
            // Check if set already has data (editing mode)
            const program = programs[currentProgram];
            const weekData = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
            const existingSet = weekData.sets ? weekData.sets[setPosition] : null;
            
            // If editing existing set, show both fields; if new, start with weight
            inputStep = existingSet ? 'both' : 'weight';
            activeSet = `${dayIndex}-${exIndex}-${setPosition}`;
            render();
            // Focus the weight input after render
            setTimeout(() => {
                const input = document.getElementById(`weight-${dayIndex}-${exIndex}-${setPosition}`);
                if (input) input.focus();
            }, 100);
        }
        
        function addDay() {
            const program = programs[currentProgram];
            const newDayIndex = program.days.length;
            const newDay = {
                name: `Dag ${newDayIndex + 1}`,
                exercises: []
            };
            program.days.push(newDay);
            
            // Add workout data for each week
            program.weeks.forEach(week => {
                week.workouts.push({ logs: {} });
            });
            
            storage.save('programs', programs);
            
            // Open exercise modal directly for the new day
            openExerciseModal(newDayIndex);
        }
        
        function deleteDay(dayIndex) {
            console.log('deleteDay called with index:', dayIndex, 'ptMode:', ptMode);
            const program = programs[currentProgram];
            if (program.days.length <= 1) {
                alert('Du m√•ste ha minst en dag');
                return;
            }
            
            if (confirm(`Radera ${program.days[dayIndex].name}?`)) {
                program.days.splice(dayIndex, 1);
                
                // Remove workout data for each week
                program.weeks.forEach(week => {
                    week.workouts.splice(dayIndex, 1);
                });
                
                // Reset edit mode for this day
                delete editModes[dayIndex];
                
                // If we were viewing this day, go back to day list
                if (currentMobileDay === dayIndex) {
                    currentMobileDay = null;
                } else if (currentMobileDay > dayIndex) {
                    currentMobileDay--;
                }
                
                storage.save('programs', programs);
                render();
            }
        }
        
        function confirmWeight(dayIndex, exIndex, setPosition) {
            // Save the weight value before re-rendering
            const weightInput = document.getElementById(`weight-${dayIndex}-${exIndex}-${setPosition}`);
            const weightValue = weightInput ? weightInput.value : '';
            
            // Create a temporary hidden input to keep keyboard open on mobile
            const tempInput = document.createElement('input');
            tempInput.type = 'number';
            tempInput.inputMode = 'decimal';
            tempInput.style.cssText = 'position: fixed; top: 50%; left: 50%; opacity: 0; pointer-events: none;';
            document.body.appendChild(tempInput);
            tempInput.focus();
            
            inputStep = 'reps';
            render();
            
            // Use requestAnimationFrame for smoother transition
            requestAnimationFrame(() => {
                setTimeout(() => {
                    // Restore weight value and focus reps
                    const newWeightInput = document.getElementById(`weight-${dayIndex}-${exIndex}-${setPosition}`);
                    if (newWeightInput) newWeightInput.value = weightValue;
                    
                    const repsInput = document.getElementById(`reps-${dayIndex}-${exIndex}-${setPosition}`);
                    if (repsInput) {
                        repsInput.focus();
                        repsInput.click(); // Extra trigger for mobile
                    }
                    
                    // Remove temp input
                    document.body.removeChild(tempInput);
                }, 50);
            });
        }
        
        function activateExerciseAndSet(dayIndex, exIndex, setPosition) {
            const key = `${dayIndex}-${exIndex}`;
            // Activate exercise
            activeExercises = {};
            activeExercises[key] = true;
            
            // Check if set already has data
            const program = programs[currentProgram];
            const weekData = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
            const existingSet = weekData.sets ? weekData.sets[setPosition] : null;
            inputStep = existingSet ? 'both' : 'weight';
            
            // Activate specific set
            activeSet = `${dayIndex}-${exIndex}-${setPosition}`;
            render();
            // Focus the weight input after render
            setTimeout(() => {
                const input = document.getElementById(`weight-${dayIndex}-${exIndex}-${setPosition}`);
                if (input) input.focus();
            }, 100);
        }
        
        let templateEditMode = false;
        
        function populateTemplateLibrary() {
            const templates = storage.load('programTemplates') || [];
            const filterInfo = document.getElementById('filterInfo');
            const templateGrid = document.getElementById('templateGrid');
            const searchInput = document.getElementById('templateSearchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            // Build filter chips
            let filterHtml = '';
            if (createProgramData.gender) {
                filterHtml += `<span onclick="window.clearCreateFilter('gender')" style="background: var(--accent); color: var(--primary); padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">${createProgramData.gender} √ó</span>`;
            }
            if (createProgramData.level) {
                filterHtml += `<span onclick="window.clearCreateFilter('level')" style="background: rgba(0, 229, 160, 0.2); color: var(--accent); padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">${createProgramData.level} √ó</span>`;
            }
            if (createProgramData.daysPerWeek) {
                filterHtml += `<span onclick="window.clearCreateFilter('days')" style="background: rgba(100, 150, 255, 0.2); color: #88aaff; padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">${createProgramData.daysPerWeek} dagar √ó</span>`;
            }
            if (filterHtml) {
                filterHtml += `<span onclick="window.clearAllCreateFilters()" style="background: var(--surface); color: var(--text-muted); padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.75rem; cursor: pointer;">Rensa alla</span>`;
            }
            filterInfo.innerHTML = filterHtml;
            
            // Filter templates
            const filtered = templates.filter(t => {
                if (createProgramData.gender && t.gender !== createProgramData.gender) return false;
                if (createProgramData.level && t.level !== createProgramData.level) return false;
                if (createProgramData.daysPerWeek && t.days && t.days.length !== createProgramData.daysPerWeek) return false;
                if (searchTerm && !t.name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });
            
            if (filtered.length === 0) {
                templateGrid.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Inga mallar matchar dina filter</p>
                        <button onclick="window.buildFromScratchFromLibrary()" style="padding: 1rem 2rem; background: var(--accent); border: none; border-radius: 10px; color: var(--primary); font-size: 1rem; font-weight: 600; cursor: pointer;">Bygg fr√•n scratch ist√§llet</button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filtered.forEach((template, index) => {
                const originalIndex = templates.indexOf(template);
                html += `
                    <div onclick="window.loadTemplateFromLibrary(${originalIndex})" style="background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; cursor: pointer; transition: all 0.2s;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${template.name}</div>
                        <div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">
                            ${template.gender ? `<span style="background: rgba(0, 229, 160, 0.1); color: var(--accent); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">${template.gender}</span>` : ''}
                            ${template.level ? `<span style="background: rgba(100, 150, 255, 0.1); color: #88aaff; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">${template.level}</span>` : ''}
                            <span style="background: rgba(255, 180, 100, 0.1); color: #ffbb66; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">${template.days ? template.days.length : 0} dagar</span>
                            <span style="background: rgba(200, 100, 255, 0.1); color: #cc88ff; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">${template.weeksCount || 8} veckor</span>
                        </div>
                    </div>
                `;
            });
            templateGrid.innerHTML = html;
        }
        
        function clearCreateFilter(type) {
            if (type === 'gender') createProgramData.gender = '';
            if (type === 'level') createProgramData.level = '';
            if (type === 'days') createProgramData.daysPerWeek = 0;
            populateTemplateLibrary();
            updateTemplateCount();
        }
        
        function clearAllCreateFilters() {
            createProgramData.gender = '';
            createProgramData.level = '';
            createProgramData.daysPerWeek = 0;
            populateTemplateLibrary();
            updateTemplateCount();
        }
        
        function buildFromScratchFromLibrary() {
            // Close template library and go to step 6 (name input)
            templateLibraryModal.classList.remove('show');
            goToCreateStep(6);
        }
        
        window.buildFromScratchFromLibrary = buildFromScratchFromLibrary;
        
        function loadTemplateFromLibrary(index) {
            const templates = storage.load('programTemplates') || [];
            const template = templates[index];
            if (!template) return;
            
            // Create program from template
            const weeks = [];
            for (let w = 0; w < (template.weeksCount || 8); w++) {
                const workouts = [];
                for (let d = 0; d < template.days.length; d++) {
                    workouts.push({ completed: false, logs: {} });
                }
                weeks.push({ workouts });
            }
            
            const newProgram = {
                name: template.name,
                gender: template.gender,
                level: template.level,
                days: JSON.parse(JSON.stringify(template.days)),
                weeks: weeks,
                weeksCount: template.weeksCount || 8,
                lastActivity: null
            };
            
            programs.push(newProgram);
            storage.save('programs', programs);
            
            templateLibraryModal.classList.remove('show');
            createModal.classList.remove('show');
            currentProgram = programs.length - 1;
            currentWeek = 1;
            render();
        }
        
        window.clearCreateFilter = clearCreateFilter;
        window.clearAllCreateFilters = clearAllCreateFilters;
        window.loadTemplateFromLibrary = loadTemplateFromLibrary;
        
        function toggleTemplateEditMode() {
            // This function is no longer used - templates managed through inline display
            templateEditMode = !templateEditMode;
            filterAndShowTemplates();
        }
        
        function loadProgramTemplate(index) {
            const template = programTemplates[index];
            
            // Fill in the form
            document.getElementById('programName').value = template.name;
            document.getElementById('weeksCount').value = template.weeksCount;
            
            // Select the matching day count
            const dayOptions = document.querySelectorAll('.day-option');
            dayOptions.forEach(opt => {
                opt.classList.remove('selected');
                if (parseInt(opt.dataset.days) === template.days.length) {
                    opt.classList.add('selected');
                }
            });
            
            // Store template to apply after program creation
            window.pendingTemplate = template;
        }
        
        function updateExerciseReps(dayIndex, exIndex, value) {
            const program = programs[currentProgram];
            program.days[dayIndex].exercises[exIndex].reps = value;
            storage.save('programs', programs);
            render();
        }
        
        function updateExerciseSets(dayIndex, exIndex, value) {
            const program = programs[currentProgram];
            const newSets = parseInt(value);
            if (newSets >= 1 && newSets <= 10) {
                program.days[dayIndex].exercises[exIndex].sets = newSets;
                storage.save('programs', programs);
                render();
            }
        }
        
        function deleteTemplate(index) {
            if (confirm(`Radera programmallen "${programTemplates[index].name}"?`)) {
                programTemplates.splice(index, 1);
                storage.save('programTemplates', programTemplates);
                populateTemplateLibrary();
            }
        }
        
        // Multi-select mode for exercises
        let exerciseSelectMode = false;
        let selectedExercises = []; // Array of {name, muscleGroup}
        
        function toggleExerciseSelection(name, muscleGroup) {
            const idx = selectedExercises.findIndex(e => e.name === name && e.muscleGroup === muscleGroup);
            if (idx > -1) {
                // Avmarkera
                selectedExercises.splice(idx, 1);
            } else {
                // Markera - men max 10
                if (selectedExercises.length >= 10) {
                    alert('Max 10 √∂vningar √•t g√•ngen');
                    return;
                }
                selectedExercises.push({ name, muscleGroup });
            }
            
            // Update UI
            const selectedBar = document.getElementById('selectedExercisesBar');
            const selectedCount = document.getElementById('selectedCount');
            const proceedBtn = document.getElementById('proceedSelectedBtn');
            
            selectedBar.style.display = 'block';
            if (selectedExercises.length > 0) {
                selectedCount.textContent = `${selectedExercises.length} √∂vning${selectedExercises.length > 1 ? 'ar' : ''} vald${selectedExercises.length > 1 ? 'a' : ''}`;
                if (proceedBtn) {
                    proceedBtn.disabled = false;
                    proceedBtn.style.opacity = '1';
                    proceedBtn.style.cursor = 'pointer';
                }
            } else {
                selectedCount.textContent = 'V√§lj √∂vningar (max 10)';
                if (proceedBtn) {
                    proceedBtn.disabled = true;
                    proceedBtn.style.opacity = '0.5';
                    proceedBtn.style.cursor = 'not-allowed';
                }
            }
            
            // Spara vilka kategorier som √§r √∂ppna
            const openCategories = [];
            document.querySelectorAll('[id^="exercises-"]').forEach(div => {
                if (div.style.display === 'flex') {
                    openCategories.push(div.id.replace('exercises-', ''));
                }
            });
            
            // Re-render to update checkboxes
            populateExerciseLibrary();
            
            // √Öterst√§ll √∂ppna kategorier
            openCategories.forEach(categoryId => {
                const exercisesDiv = document.getElementById(`exercises-${categoryId}`);
                const arrow = document.getElementById(`arrow-${categoryId}`);
                if (exercisesDiv) {
                    exercisesDiv.style.display = 'flex';
                }
                if (arrow) {
                    arrow.style.transform = 'rotate(180deg)';
                }
            });
        }
        
        function proceedWithSelectedExercises() {
            if (selectedExercises.length === 0) return;
            
            const isMobile = window.innerWidth <= 768;
            
            // Om bara 1 √∂vning vald - hantera som single add
            if (selectedExercises.length === 1) {
                const ex = selectedExercises[0];
                selectedExerciseData.name = ex.name;
                selectedExerciseData.muscleGroup = ex.muscleGroup;
                selectedExerciseData.isBatch = false;
                selectedExerciseData.isManualEntry = false;
                window.pendingBatchExercises = null;
            } else {
                // Flera √∂vningar - batch mode
                window.pendingBatchExercises = selectedExercises.slice();
                
                selectedExerciseData.name = selectedExercises.map(e => e.name).join(', ');
                selectedExerciseData.muscleGroup = selectedExercises[0].muscleGroup;
                selectedExerciseData.isBatch = true;
                selectedExerciseData.isManualEntry = false;
            }
            
            if (isMobile) {
                // Visa fullscreen picker p√• mobil
                showMobileRepsSetPicker();
            } else {
                // Desktop - visa i modal
                document.getElementById('exerciseStep1').style.display = 'none';
                document.getElementById('exerciseStep1b').style.display = 'none';
                document.getElementById('selectedExerciseName').textContent = selectedExercises.length === 1 
                    ? selectedExercises[0].name 
                    : `${selectedExercises.length} √∂vningar`;
                
                const step2 = document.getElementById('exerciseStep2');
                const mobileRepsSetPicker = document.getElementById('mobileRepsSetPicker');
                const desktopRepsPicker = document.getElementById('desktopRepsPicker');
                const modalHeader = document.getElementById('exerciseModalHeader');
                
                step2.style.display = 'block';
                if (mobileRepsSetPicker) mobileRepsSetPicker.style.display = 'none';
                if (desktopRepsPicker) desktopRepsPicker.style.display = 'block';
                if (modalHeader) modalHeader.style.display = 'flex';
            }
        }
        
        window.toggleExerciseSelection = toggleExerciseSelection;
        window.proceedWithSelectedExercises = proceedWithSelectedExercises;
        
        function populateExerciseLibrary() {
            const libraryContent = document.getElementById('libraryContent');
            
            // Color map for muscle groups
            const muscleColors = {
                'Br√∂st': '#6B9FFF',           // Bl√•
                'Rygg': '#4ECDC4',            // Turkos
                'Axlar': '#FFB366',           // Varm orange
                'Biceps': '#A8E6CF',          // Mintgr√∂n
                'Triceps': '#C9A7FF',         // Lila
                'Framsida l√•r': '#7DD3FC',    // Ljusbl√•
                'Baksida l√•r': '#B4A7D6',     // Lila
                'Rumpa': '#FFB3E6',           // Ljusrosa
                'Vader': '#95E1D3',           // Mint
                'Mage': '#FDB777'             // Persika/orange
            };
            
            let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
            
            for (const [category, exercises] of Object.entries(exerciseLibrary)) {
                const color = muscleColors[category];
                const categoryId = category.replace(/\s+/g, '-');
                
                // Muscle group button (same size as exercises)
                html += `
                    <button onclick="window.toggleCategoryExercises('${categoryId}', '${category.replace(/'/g, "\\'")}', this)" style="padding: 0.75rem 1rem; background: ${color}20; border: 1px solid ${color}; border-radius: 6px; color: var(--text); cursor: pointer; text-align: left; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center;" data-color="${color}">
                        <span>${category}</span>
                        <span id="arrow-${categoryId}" style="font-size: 0.85rem; transition: transform 0.2s;">‚ñº</span>
                    </button>
                `;
                
                // Exercise list (hidden by default)
                html += `
                    <div id="exercises-${categoryId}" style="display: none; padding-left: 1rem; flex-direction: column; gap: 0.5rem;">
                `;
                
                exercises.forEach((exercise, exIndex) => {
                    const isSelected = exerciseSelectMode && selectedExercises.some(e => e.name === exercise && e.muscleGroup === category);
                    
                    html += `
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${libraryEditMode ? `
                                <input type="text" 
                                       value="${exercise}" 
                                       onchange="window.renameExerciseInLibrary('${category.replace(/'/g, "\\'")}', ${exIndex}, this.value)"
                                       style="padding: 0.75rem 1rem; background: var(--surface); border: 1px solid ${color}; border-radius: 6px; color: var(--text); text-align: left; font-size: 0.9rem; flex: 1;">
                            ` : exerciseSelectMode ? `
                                <div onclick="window.toggleExerciseSelection('${exercise.replace(/'/g, "\\'")}', '${category.replace(/'/g, "\\'")}')" style="padding: 0.75rem 1rem; background: ${isSelected ? 'rgba(0, 229, 160, 0.15)' : 'var(--surface)'}; border: 1px solid ${isSelected ? 'var(--accent)' : color}; border-radius: 6px; color: var(--text); cursor: pointer; text-align: left; font-size: 0.9rem; transition: all 0.2s; flex: 1; display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="width: 22px; height: 22px; border: 2px solid ${isSelected ? 'var(--accent)' : 'var(--border)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: ${isSelected ? 'var(--accent)' : 'transparent'}; flex-shrink: 0;">
                                        ${isSelected ? '<span style="color: var(--primary); font-size: 0.8rem;">‚úì</span>' : ''}
                                    </div>
                                    <span>${exercise}</span>
                                </div>
                            ` : `
                                <button class="exercise-lib-btn" onmouseover="this.style.background='${color}'; this.style.color='#0a0e27'; this.style.transform='translateX(4px)'" onmouseout="this.style.background='var(--surface)'; this.style.color='var(--text)'; this.style.transform='none'" onclick="window.selectExerciseFromLibrary('${exercise.replace(/'/g, "\\'")}', '${category.replace(/'/g, "\\'")}')" style="padding: 0.75rem 1rem; background: var(--surface); border: 1px solid ${color}; border-radius: 6px; color: var(--text); cursor: pointer; text-align: left; font-size: 0.9rem; transition: all 0.2s; flex: 1;">
                                    ${exercise}
                                </button>
                            `}
                            ${libraryEditMode ? `<button onclick="window.deleteExerciseFromLibrary('${category.replace(/'/g, "\\'")}', '${exercise.replace(/'/g, "\\'")}'); event.stopPropagation();" style="padding: 0.5rem 0.75rem; background: rgba(255, 80, 80, 0.8); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.75rem; font-weight: 600;">RADERA</button>` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            html += '</div>';
            
            libraryContent.innerHTML = html;
        }
        
        function toggleCategoryExercises(categoryId, category, button) {
            const exercisesDiv = document.getElementById(`exercises-${categoryId}`);
            const arrow = document.getElementById(`arrow-${categoryId}`);
            
            if (exercisesDiv.style.display === 'none') {
                // I select mode - st√§ng inte andra kategorier
                if (!exerciseSelectMode) {
                    // Close all other categories first (only in normal mode)
                    document.querySelectorAll('[id^="exercises-"]').forEach(div => {
                        div.style.display = 'none';
                    });
                    document.querySelectorAll('[id^="arrow-"]').forEach(arr => {
                        arr.style.transform = 'rotate(0deg)';
                    });
                }
                
                // Open this category
                exercisesDiv.style.display = 'flex';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                // Close this category
                exercisesDiv.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        function selectExerciseFromLibrary(exerciseName, category) {
            // Auto-select muscle group based on category
            const muscleGroupMap = {
                'Br√∂st': 'Br√∂st',
                'Rygg': 'Rygg',
                'Axlar': 'Axlar',
                'Biceps': 'Biceps',
                'Triceps': 'Triceps',
                'Framsida l√•r': 'Ben',
                'Baksida l√•r': 'Ben',
                'Rumpa': 'Ben',
                'Vader': 'Ben',
                'Mage': 'Mage'
            };
            
            // Set exercise data
            selectedExerciseData.name = exerciseName;
            selectedExerciseData.muscleGroup = muscleGroupMap[category] || category;
            selectedExerciseData.isBatch = false;
            selectedExerciseData.isManualEntry = false;
            
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Visa fullscreen picker p√• mobil
                showMobileRepsSetPicker();
            } else {
                // Desktop - visa i modal
                document.getElementById('exerciseName').value = exerciseName;
                document.getElementById('selectedExerciseName').textContent = exerciseName;
                
                const library = document.getElementById('exerciseLibrary');
                library.style.display = 'none';
                
                document.getElementById('exerciseStep1').style.display = 'none';
                document.getElementById('exerciseStep3').style.display = 'none';
                
                const step2 = document.getElementById('exerciseStep2');
                const mobileRepsSetPicker = document.getElementById('mobileRepsSetPicker');
                const desktopRepsPicker = document.getElementById('desktopRepsPicker');
                const modalHeader = document.getElementById('exerciseModalHeader');
                
                step2.style.display = 'block';
                if (mobileRepsSetPicker) mobileRepsSetPicker.style.display = 'none';
                if (desktopRepsPicker) desktopRepsPicker.style.display = 'block';
                if (modalHeader) modalHeader.style.display = 'flex';
                
                document.getElementById('exerciseReps').value = '';
                document.getElementById('customRepsBtn').style.display = 'none';
            }
        }
        
        function removeSet(dayIndex, exIndex, week, setIndex) {
            if (confirm('Ta bort detta set?')) {
                const program = programs[currentProgram];
                const logs = program.weeks[week - 1].workouts[dayIndex].logs[exIndex];
                if (logs && logs.sets) {
                    // Instead of splice, just delete that specific set (keeping position)
                    delete logs.sets[setIndex];
                }
                storage.save('programs', programs);
                render();
            }
        }
        
        function setWeight(dayIndex, exIndex, value) {
            const program = programs[currentProgram];
            if (!program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex]) {
                program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] = {};
            }
            program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex].weight = parseFloat(value);
            storage.save('programs', programs);
        }
        
        function adjustWeight(dayIndex, exIndex, delta) {
            const program = programs[currentProgram];
            if (!program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex]) {
                program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] = { weight: 0 };
            }
            const current = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex].weight || 0;
            const newWeight = Math.max(0, Math.min(200, current + delta));
            program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex].weight = newWeight;
            storage.save('programs', programs);
            render();
        }
        
        function deleteExercise(dayIndex, exIndex) {
            console.log('Delete clicked:', dayIndex, exIndex);
            
            // Extra bekr√§ftelse i klientl√§ge
            if (!ptMode) {
                if (!confirm('Du √§r p√• v√§g att √§ndra programmet. √Ñr du s√§ker?')) {
                    return;
                }
            }
            
            if (confirm('Ta bort denna √∂vning?')) {
                console.log('Deleting exercise from program', currentProgram);
                programs[currentProgram].days[dayIndex].exercises.splice(exIndex, 1);
                storage.save('programs', programs);
                render();
            }
        }
        
        function toggleEditMode(dayIndex) {
            editModes[dayIndex] = !editModes[dayIndex];
            console.log('Edit mode for day', dayIndex, ':', editModes[dayIndex]);
            render();
        }
        
        function toggleAllEditMode() {
            console.log('toggleAllEditMode called, ptMode:', ptMode);
            const anyInEditMode = Object.values(editModes).some(v => v);
            const program = programs[currentProgram];
            
            if (anyInEditMode) {
                // Turn off all edit modes
                editModes = {};
                console.log('Turning off edit modes');
            } else {
                // Turn on edit mode for all days
                program.days.forEach((day, index) => {
                    editModes[index] = true;
                });
                console.log('Edit modes set to:', editModes);
            }
            render();
        }
        
        function toggleExerciseActive(dayIndex, exIndex) {
            const key = `${dayIndex}-${exIndex}`;
            if (activeExercises[key]) {
                // Deactivate
                delete activeExercises[key];
                activeSet = null;
            } else {
                // Activate this exercise and find first empty set
                activeExercises = {};
                activeExercises[key] = true;
                
                // Find first empty set position within target
                const program = programs[currentProgram];
                const exercise = program.days[dayIndex].exercises[exIndex];
                const targetSets = exercise.sets;
                const weekData = program.weeks[currentWeek - 1].workouts[dayIndex].logs[exIndex] || { sets: {} };
                const sets = weekData.sets || {};
                
                // Find first empty position within target sets
                let firstEmptySet = null;
                for (let i = 0; i < targetSets; i++) {
                    if (sets[i] === undefined) {
                        firstEmptySet = i;
                        break;
                    }
                }
                
                // Only auto-activate if there's an empty target set
                if (firstEmptySet !== null) {
                    activeSet = `${dayIndex}-${exIndex}-${firstEmptySet}`;
                    inputStep = 'weight';
                } else {
                    activeSet = null;
                }
            }
            render();
            
            // Focus the input if we activated a set
            if (activeSet) {
                setTimeout(() => {
                    const [d, e, s] = activeSet.split('-').map(Number);
                    const input = document.getElementById(`weight-${d}-${e}-${s}`);
                    if (input) input.focus();
                }, 100);
            }
        }
        
        function editDayName(dayIndex) {
            const program = programs[currentProgram];
            const currentName = program.days[dayIndex].name;
            const newName = prompt('Ange nytt namn f√∂r dagen:', currentName);
            
            if (newName && newName.trim() !== '') {
                program.days[dayIndex].name = newName.trim();
                storage.save('programs', programs);
                render();
            }
        }
        
        function renameDayInline(dayIndex, newName) {
            if (newName && newName.trim() !== '') {
                const program = programs[currentProgram];
                program.days[dayIndex].name = newName.trim();
                storage.save('programs', programs);
                render();
            }
        }
        
        function toggleDayCollapse(dayIndex) {
            collapsedDays[dayIndex] = !collapsedDays[dayIndex];
            render();
        }
        
        function deleteWeek(weekNumber) {
            const program = programs[currentProgram];
            
            if (program.weeksCount <= 1) {
                alert('Du m√•ste ha minst en vecka!');
                return;
            }
            
            // Check if user has disabled confirmation
            const dontAskAgain = storage.load('dontAskDeleteWeek');
            
            if (dontAskAgain) {
                performDeleteWeek(weekNumber);
            } else {
                // Show custom confirm dialog with checkbox
                const confirmed = confirm(`√Ñr du s√§ker p√• att du vill ta bort Vecka ${weekNumber}?\n\n(Tryck OK f√∂r att forts√§tta)`);
                
                if (confirmed) {
                    // For now just delete, we can add "don't ask again" later with a custom modal
                    performDeleteWeek(weekNumber);
                }
            }
        }
        
        function performDeleteWeek(weekNumber) {
            const program = programs[currentProgram];
            program.weeks.splice(weekNumber - 1, 1);
            program.weeksCount--;
            
            // Adjust current week if needed
            if (currentWeek > program.weeksCount) {
                currentWeek = program.weeksCount;
            }
            if (currentWeek >= weekNumber) {
                currentWeek = Math.max(1, currentWeek - 1);
            }
            
            storage.save('programs', programs);
            render();
        }
        
        // Drag and drop state
        let draggedExercise = null;
        let draggedFromDay = null;
        let draggedFromIndex = null;
        
        function handleDragStart(event, dayIndex, exIndex) {
            draggedFromDay = dayIndex;
            draggedFromIndex = exIndex;
            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function handleDrop(event, targetDayIndex, targetExIndex) {
            event.preventDefault();
            
            // Only allow reordering within same day
            if (draggedFromDay !== targetDayIndex) return;
            if (draggedFromIndex === targetExIndex) return;
            
            const program = programs[currentProgram];
            const day = program.days[targetDayIndex];
            
            // Remove exercise from original position
            const [movedExercise] = day.exercises.splice(draggedFromIndex, 1);
            
            // Insert at new position
            const insertIndex = draggedFromIndex < targetExIndex ? targetExIndex : targetExIndex;
            day.exercises.splice(insertIndex, 0, movedExercise);
            
            // Also reorder the logs for all weeks
            program.weeks.forEach(week => {
                const workout = week.workouts[targetDayIndex];
                const [movedLog] = workout.logs.splice(draggedFromIndex, 1);
                workout.logs.splice(insertIndex, 0, movedLog);
            });
            
            storage.save('programs', programs);
            render();
        }
        
        function handleDragEnd(event) {
            event.target.style.opacity = '1';
            draggedFromDay = null;
            draggedFromIndex = null;
            // Remove all drop indicators
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
        }
        
        function handleDragEnter(event, targetDayIndex, targetExIndex) {
            if (draggedFromDay !== targetDayIndex) return;
            if (draggedFromIndex === targetExIndex) return;
            
            // Remove existing indicators
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            
            // Add indicator
            const target = event.currentTarget;
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator';
            indicator.style.cssText = 'height: 3px; background: var(--accent); border-radius: 2px; margin: 4px 0; box-shadow: 0 0 8px var(--accent);';
            
            if (draggedFromIndex < targetExIndex) {
                target.parentNode.insertBefore(indicator, target.nextSibling);
            } else {
                target.parentNode.insertBefore(indicator, target);
            }
        }
        
        function handleDragLeave(event) {
            // Only remove if leaving the container entirely
            if (!event.currentTarget.contains(event.relatedTarget)) {
                // Keep indicator
            }
        }
        
        // Touch event handlers for mobile drag and drop
        let touchDragElement = null;
        let touchStartY = 0;
        let touchCurrentY = 0;
        let touchClone = null;
        
        function handleTouchStart(event, dayIndex, exIndex) {
            if (!editModes[dayIndex]) return;
            
            // Don't start drag if touching an input element
            const targetTag = event.target.tagName.toLowerCase();
            if (targetTag === 'input' || targetTag === 'button' || targetTag === 'textarea') {
                return;
            }
            
            const touch = event.touches[0];
            touchStartY = touch.clientY;
            touchDragElement = event.currentTarget;
            draggedFromDay = dayIndex;
            draggedFromIndex = exIndex;
            
            // Create a clone for visual feedback
            touchClone = touchDragElement.cloneNode(true);
            touchClone.style.cssText = `
                position: fixed;
                top: ${touchDragElement.getBoundingClientRect().top}px;
                left: ${touchDragElement.getBoundingClientRect().left}px;
                width: ${touchDragElement.offsetWidth}px;
                opacity: 0.8;
                z-index: 1000;
                pointer-events: none;
                transform: scale(1.02);
                box-shadow: 0 4px 20px rgba(0, 229, 160, 0.3);
                border: 2px solid var(--accent);
            `;
            document.body.appendChild(touchClone);
            
            touchDragElement.style.opacity = '0.3';
            
            // Prevent scrolling
            event.preventDefault();
        }
        
        function handleTouchMove(event) {
            if (!touchClone) return;
            
            const touch = event.touches[0];
            touchCurrentY = touch.clientY;
            
            // Move the clone
            const deltaY = touchCurrentY - touchStartY;
            const originalTop = touchDragElement.getBoundingClientRect().top;
            touchClone.style.top = (originalTop + deltaY) + 'px';
            
            // Find element under touch point
            touchClone.style.display = 'none';
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            touchClone.style.display = '';
            
            // Remove existing indicators
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            
            // Find the exercise item
            const exerciseItem = elementBelow?.closest('.exercise-item');
            if (exerciseItem && exerciseItem !== touchDragElement) {
                const targetDay = parseInt(exerciseItem.dataset.day);
                const targetEx = parseInt(exerciseItem.dataset.exercise);
                
                if (targetDay === draggedFromDay && targetEx !== draggedFromIndex) {
                    const indicator = document.createElement('div');
                    indicator.className = 'drop-indicator';
                    indicator.style.cssText = 'height: 3px; background: var(--accent); border-radius: 2px; margin: 4px 0; box-shadow: 0 0 8px var(--accent);';
                    
                    if (draggedFromIndex < targetEx) {
                        exerciseItem.parentNode.insertBefore(indicator, exerciseItem.nextSibling);
                    } else {
                        exerciseItem.parentNode.insertBefore(indicator, exerciseItem);
                    }
                }
            }
            
            event.preventDefault();
        }
        
        function handleTouchEnd(event) {
            if (!touchClone) return;
            
            // Find element under last touch point
            const touch = event.changedTouches[0];
            touchClone.style.display = 'none';
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            touchClone.style.display = '';
            
            const exerciseItem = elementBelow?.closest('.exercise-item');
            if (exerciseItem && exerciseItem !== touchDragElement) {
                const targetDay = parseInt(exerciseItem.dataset.day);
                const targetEx = parseInt(exerciseItem.dataset.exercise);
                
                if (targetDay === draggedFromDay && targetEx !== draggedFromIndex) {
                    // Perform the move
                    const program = programs[currentProgram];
                    const day = program.days[targetDay];
                    
                    const [movedExercise] = day.exercises.splice(draggedFromIndex, 1);
                    const insertIndex = draggedFromIndex < targetEx ? targetEx : targetEx;
                    day.exercises.splice(insertIndex, 0, movedExercise);
                    
                    program.weeks.forEach(week => {
                        const workout = week.workouts[targetDay];
                        const [movedLog] = workout.logs.splice(draggedFromIndex, 1);
                        workout.logs.splice(insertIndex, 0, movedLog);
                    });
                    
                    storage.save('programs', programs);
                }
            }
            
            // Cleanup
            if (touchClone) {
                touchClone.remove();
                touchClone = null;
            }
            if (touchDragElement) {
                touchDragElement.style.opacity = '1';
                touchDragElement = null;
            }
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            draggedFromDay = null;
            draggedFromIndex = null;
            
            render();
        }
        
        // Day drag and drop
        let draggedDayIndex = null;
        let dayTouchElement = null;
        let dayTouchClone = null;
        
        function handleDayDragStart(event, dayIndex) {
            draggedDayIndex = dayIndex;
            event.dataTransfer.effectAllowed = 'move';
            const dayEl = event.target.closest('.day-item') || event.target.closest('.day-section');
            if (dayEl) dayEl.style.opacity = '0.5';
        }
        
        function handleDayDragEnd(event) {
            const dayEl = event.target.closest('.day-item') || event.target.closest('.day-section');
            if (dayEl) dayEl.style.opacity = '1';
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            draggedDayIndex = null;
        }
        
        function handleDayDragOver(event) {
            event.preventDefault();
        }
        
        function handleDayDragEnter(event, targetDayIndex) {
            if (draggedDayIndex === null || draggedDayIndex === targetDayIndex) return;
            
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            
            const target = event.currentTarget;
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator';
            indicator.style.cssText = 'height: 3px; background: var(--accent); border-radius: 2px; margin: 4px 0; box-shadow: 0 0 8px var(--accent);';
            
            if (draggedDayIndex < targetDayIndex) {
                target.parentNode.insertBefore(indicator, target.nextSibling);
            } else {
                target.parentNode.insertBefore(indicator, target);
            }
        }
        
        function handleDayDragLeave(event) {
            // Keep indicator
        }
        
        function handleDayDrop(event, targetDayIndex) {
            event.preventDefault();
            if (draggedDayIndex === null || draggedDayIndex === targetDayIndex) return;
            
            const program = programs[currentProgram];
            
            // Move day
            const [movedDay] = program.days.splice(draggedDayIndex, 1);
            const insertIndex = draggedDayIndex < targetDayIndex ? targetDayIndex : targetDayIndex;
            program.days.splice(insertIndex, 0, movedDay);
            
            // Move workout data for each week
            program.weeks.forEach(week => {
                const [movedWorkout] = week.workouts.splice(draggedDayIndex, 1);
                week.workouts.splice(insertIndex, 0, movedWorkout);
            });
            
            // Update edit modes
            const newEditModes = {};
            Object.keys(editModes).forEach(key => {
                const oldIndex = parseInt(key);
                if (oldIndex === draggedDayIndex) {
                    newEditModes[insertIndex] = editModes[oldIndex];
                } else if (draggedDayIndex < targetDayIndex) {
                    if (oldIndex > draggedDayIndex && oldIndex <= insertIndex) {
                        newEditModes[oldIndex - 1] = editModes[oldIndex];
                    } else {
                        newEditModes[oldIndex] = editModes[oldIndex];
                    }
                } else {
                    if (oldIndex >= insertIndex && oldIndex < draggedDayIndex) {
                        newEditModes[oldIndex + 1] = editModes[oldIndex];
                    } else {
                        newEditModes[oldIndex] = editModes[oldIndex];
                    }
                }
            });
            editModes = newEditModes;
            
            storage.save('programs', programs);
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            draggedDayIndex = null;
            render();
        }
        
        function handleDayTouchStart(event, dayIndex) {
            const anyEditMode = Object.values(editModes).some(v => v);
            if (!anyEditMode) return;
            
            const targetTag = event.target.tagName.toLowerCase();
            if (targetTag === 'input' || targetTag === 'button') return;
            
            const touch = event.touches[0];
            dayTouchElement = event.target.closest('.day-item');
            draggedDayIndex = dayIndex;
            
            dayTouchClone = dayTouchElement.cloneNode(true);
            dayTouchClone.style.cssText = `
                position: fixed;
                top: ${dayTouchElement.getBoundingClientRect().top}px;
                left: ${dayTouchElement.getBoundingClientRect().left}px;
                width: ${dayTouchElement.offsetWidth}px;
                opacity: 0.8;
                z-index: 1000;
                pointer-events: none;
                transform: scale(1.02);
                box-shadow: 0 4px 20px rgba(0, 229, 160, 0.3);
                border: 2px solid var(--accent);
            `;
            document.body.appendChild(dayTouchClone);
            dayTouchElement.style.opacity = '0.3';
            
            event.preventDefault();
        }
        
        function handleDayTouchMove(event) {
            if (!dayTouchClone) return;
            
            const touch = event.touches[0];
            dayTouchClone.style.top = `${touch.clientY - 30}px`;
            
            // Find element under touch
            dayTouchClone.style.display = 'none';
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            dayTouchClone.style.display = '';
            
            const dayItem = elementBelow?.closest('.day-item');
            if (dayItem && dayItem !== dayTouchElement) {
                const targetDayIndex = parseInt(dayItem.dataset.dayIndex);
                
                document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
                
                const indicator = document.createElement('div');
                indicator.className = 'drop-indicator';
                indicator.style.cssText = 'height: 3px; background: var(--accent); border-radius: 2px; margin: 4px 0; box-shadow: 0 0 8px var(--accent);';
                
                if (draggedDayIndex < targetDayIndex) {
                    dayItem.parentNode.insertBefore(indicator, dayItem.nextSibling);
                } else {
                    dayItem.parentNode.insertBefore(indicator, dayItem);
                }
            }
            
            event.preventDefault();
        }
        
        function handleDayTouchEnd(event) {
            if (!dayTouchClone) return;
            
            const touch = event.changedTouches[0];
            dayTouchClone.style.display = 'none';
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            dayTouchClone.style.display = '';
            
            const dayItem = elementBelow?.closest('.day-item');
            if (dayItem && dayItem !== dayTouchElement) {
                const targetDayIndex = parseInt(dayItem.dataset.dayIndex);
                
                if (targetDayIndex !== draggedDayIndex) {
                    const program = programs[currentProgram];
                    
                    const [movedDay] = program.days.splice(draggedDayIndex, 1);
                    program.days.splice(targetDayIndex, 0, movedDay);
                    
                    program.weeks.forEach(week => {
                        const [movedWorkout] = week.workouts.splice(draggedDayIndex, 1);
                        week.workouts.splice(targetDayIndex, 0, movedWorkout);
                    });
                    
                    storage.save('programs', programs);
                }
            }
            
            if (dayTouchClone) {
                dayTouchClone.remove();
                dayTouchClone = null;
            }
            if (dayTouchElement) {
                dayTouchElement.style.opacity = '1';
                dayTouchElement = null;
            }
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            draggedDayIndex = null;
            
            render();
        }
        
        // Program drag and drop
        let draggedProgramIndex = null;
        
        function handleProgramDragStart(event, programIndex) {
            draggedProgramIndex = programIndex;
            event.dataTransfer.effectAllowed = 'move';
            event.target.closest('.program-item').style.opacity = '0.5';
        }
        
        function handleProgramDragEnd(event) {
            const item = event.target.closest('.program-item');
            if (item) item.style.opacity = '1';
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            draggedProgramIndex = null;
        }
        
        function handleProgramDragOver(event) {
            event.preventDefault();
        }
        
        function handleProgramDragEnter(event, targetProgramIndex) {
            if (draggedProgramIndex === null || draggedProgramIndex === targetProgramIndex) return;
            
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            
            const target = event.currentTarget;
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator';
            indicator.style.cssText = 'height: 3px; background: var(--accent); border-radius: 2px; margin: 4px 0; box-shadow: 0 0 8px var(--accent);';
            
            if (draggedProgramIndex < targetProgramIndex) {
                target.parentNode.insertBefore(indicator, target.nextSibling);
            } else {
                target.parentNode.insertBefore(indicator, target);
            }
        }
        
        function handleProgramDragLeave(event) {
            // Keep indicator
        }
        
        function handleProgramDrop(event, targetProgramIndex) {
            event.preventDefault();
            if (draggedProgramIndex === null || draggedProgramIndex === targetProgramIndex) return;
            
            // Move program
            const [movedProgram] = programs.splice(draggedProgramIndex, 1);
            programs.splice(targetProgramIndex, 0, movedProgram);
            
            storage.save('programs', programs);
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            draggedProgramIndex = null;
            render();
        }
        
        // Make functions globally accessible
        window.deleteExercise = deleteExercise;
        window.toggleEditMode = toggleEditMode;
        window.toggleAllEditMode = toggleAllEditMode;
        window.renameDayInline = renameDayInline;
        window.toggleDayCollapse = toggleDayCollapse;
        window.toggleExerciseActive = toggleExerciseActive;
        window.activateSet = activateSet;
        window.activateExerciseAndSet = activateExerciseAndSet;
        window.confirmWeight = confirmWeight;
        window.addExtraSet = addExtraSet;
        window.updateExerciseReps = updateExerciseReps;
        window.updateExerciseSets = updateExerciseSets;
        window.selectExerciseFromLibrary = selectExerciseFromLibrary;
        window.openMobileDay = openMobileDay;
        window.closeMobileDay = closeMobileDay;
        window.toggleDayComplete = toggleDayComplete;
        window.addDay = addDay;
        window.deleteDay = deleteDay;
        window.handleDayDragStart = handleDayDragStart;
        window.handleDayDragEnd = handleDayDragEnd;
        window.handleDayDragOver = handleDayDragOver;
        window.handleDayDragEnter = handleDayDragEnter;
        window.handleDayDragLeave = handleDayDragLeave;
        window.handleDayDrop = handleDayDrop;
        window.handleDayTouchStart = handleDayTouchStart;
        window.handleDayTouchMove = handleDayTouchMove;
        window.handleDayTouchEnd = handleDayTouchEnd;
        window.handleDragStart = handleDragStart;
        window.handleDragOver = handleDragOver;
        window.handleDragEnter = handleDragEnter;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.handleDragEnd = handleDragEnd;
        window.handleTouchStart = handleTouchStart;
        window.handleTouchMove = handleTouchMove;
        window.handleTouchEnd = handleTouchEnd;
        window.handleProgramDragStart = handleProgramDragStart;
        window.handleProgramDragEnd = handleProgramDragEnd;
        window.handleProgramDragOver = handleProgramDragOver;
        window.handleProgramDragEnter = handleProgramDragEnter;
        window.handleProgramDragLeave = handleProgramDragLeave;
        window.handleProgramDrop = handleProgramDrop;
        
        function toggleLibraryEditMode() {
            libraryEditMode = !libraryEditMode;
            document.getElementById('editLibraryText').textContent = libraryEditMode ? '‚úì Klar' : 'Redigera';
            populateExerciseLibrary();
        }
        
        function renameExerciseInLibrary(category, exerciseIndex, newName) {
            if (newName && newName.trim() !== '') {
                exerciseLibrary[category][exerciseIndex] = newName.trim();
                saveExerciseLibrary();
                populateExerciseLibrary();
            }
        }
        
        function deleteExerciseFromLibrary(category, exerciseName) {
            if (confirm(`Radera "${exerciseName}" fr√•n biblioteket?`)) {
                const index = exerciseLibrary[category].indexOf(exerciseName);
                if (index > -1) {
                    exerciseLibrary[category].splice(index, 1);
                    saveExerciseLibrary();
                    populateExerciseLibrary();
                }
            }
        }
        
        window.toggleLibraryEditMode = toggleLibraryEditMode;
        window.deleteExerciseFromLibrary = deleteExerciseFromLibrary;
        window.renameExerciseInLibrary = renameExerciseInLibrary;
        window.saveProgramAsTemplate = saveProgramAsTemplate;
        window.loadProgramTemplate = loadProgramTemplate;
        window.deleteTemplate = deleteTemplate;
        window.toggleTemplateEditMode = toggleTemplateEditMode;
        window.addNewProgramType = addNewProgramType;
        window.selectGender = selectGender;
        window.selectLevel = selectLevel;
        window.filterAndShowTemplates = filterAndShowTemplates;
        window.toggleCategoryExercises = toggleCategoryExercises;
        window.editDayName = editDayName;
        window.deleteWeek = deleteWeek;
        window.openCreateModal = openCreateModal;
        window.openExerciseModal = openExerciseModal;
        window.openProgram = openProgram;
        window.closeProgram = closeProgram;
        window.selectWeek = selectWeek;
        window.addWeek = addWeek;
        window.logSet = logSet;
        window.logSetAtPosition = logSetAtPosition;
        window.clearSet = clearSet;
        window.removeSet = removeSet;
        window.openTemplateLibraryModal = openTemplateLibraryModal;
        window.selectTemplateFromLibrary = selectTemplateFromLibrary;
        
        // Start app
        init();
    </script>
</body>
</html>